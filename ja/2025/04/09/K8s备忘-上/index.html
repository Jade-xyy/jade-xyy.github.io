
  <!DOCTYPE html>
  <html lang="zh-CN"  
    
      data-theme-mode="auto"
    
  >
  <head>
  
  <meta charset="utf-8">
  

  

  

  <script>window.REIMU_CONFIG = {};window.REIMU_CONFIG.icon_font = '4552607_0khxww3tj3q9';window.REIMU_CONFIG.clipboard_tips = {"success":"复制成功(*^▽^*)","fail":"复制失败 (ﾟ⊿ﾟ)ﾂ","copyright":{"enable":false,"count":50,"content":"本文版权：本博客所有文章除特别声明外，均采用 BY-NC-SA 许可协议。转载请注明出处！"}};window.REIMU_CONFIG.code_block = {"expand":30};window.REIMU_CONFIG.base = 'https://jade-xyy.github.io';window.REIMU_CONFIG.i18n_languages = ["en","ja"];</script>
  
  <title>
    K8s备忘 - 上 |
    
    本堂主Blog
  </title>
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <link rel="preconnect" href="https://fonts.gstatic.com/" crossorigin><link rel="preload" as="style" href="https://fonts.googleapis.com/css?family=Mulish:400,400italic,700,700italic%7CNoto%20Serif%20SC:400,400italic,700,700italic&display=swap"><link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Mulish:400,400italic,700,700italic%7CNoto%20Serif%20SC:400,400italic,700,700italic&display=swap" media="print" onload="this.media&#x3D;&#39;all&#39;">
  
    <link rel="preload" href="//at.alicdn.com/t/c/font_4552607_0khxww3tj3q9.woff2" as="font" type="font/woff2" crossorigin="anonymous">
  
  
    
<link rel="stylesheet" href="/css/loader.css">

  
  
    <meta name="description" content="K8s备忘k8s常用命令… … … kubectl … … … ∞#查看命名空间nsA下pod1的日志最近100行kubectl logs -f pod1 -n nsA --tail&#x3D;100#查日志kubectl logs --tail&#x3D;1000 $&#123;podname&#125; -n cloudpath &gt; $&#123;podname&#125;.log#查看服务配置信息kube">
<meta property="og:type" content="article">
<meta property="og:title" content="K8s备忘 - 上">
<meta property="og:url" content="https://jade-xyy.github.io/ja/2025/04/09/K8s%E5%A4%87%E5%BF%98-%E4%B8%8A/index.html">
<meta property="og:site_name" content="本堂主Blog">
<meta property="og:description" content="K8s备忘k8s常用命令… … … kubectl … … … ∞#查看命名空间nsA下pod1的日志最近100行kubectl logs -f pod1 -n nsA --tail&#x3D;100#查日志kubectl logs --tail&#x3D;1000 $&#123;podname&#125; -n cloudpath &gt; $&#123;podname&#125;.log#查看服务配置信息kube">
<meta property="og:locale" content="ja_JP">
<meta property="og:image" content="https://jade-xyy.github.io/ja/2025/04/09/K8s%E5%A4%87%E5%BF%98-%E4%B8%8A/k8s_module.png">
<meta property="og:image" content="https://jade-xyy.github.io/ja/2025/04/09/K8s%E5%A4%87%E5%BF%98-%E4%B8%8A/pod_lifecycle.png">
<meta property="og:image" content="https://jade-xyy.github.io/ja/2025/04/09/K8s%E5%A4%87%E5%BF%98-%E4%B8%8A/k8s_clusterip.png">
<meta property="og:image" content="https://jade-xyy.github.io/ja/2025/04/09/K8s%E5%A4%87%E5%BF%98-%E4%B8%8A/k8s_lb.png">
<meta property="og:image" content="https://jade-xyy.github.io/ja/2025/04/09/K8s%E5%A4%87%E5%BF%98-%E4%B8%8A/k8s_agent_us.png">
<meta property="og:image" content="https://jade-xyy.github.io/ja/2025/04/09/K8s%E5%A4%87%E5%BF%98-%E4%B8%8A/k8s_agent_iptables.png">
<meta property="og:image" content="https://jade-xyy.github.io/ja/2025/04/09/K8s%E5%A4%87%E5%BF%98-%E4%B8%8A/k8s_agent_ipvs.png">
<meta property="og:image" content="https://jade-xyy.github.io/ja/2025/04/09/K8s%E5%A4%87%E5%BF%98-%E4%B8%8A/k8s_svc_module.png">
<meta property="og:image" content="https://jade-xyy.github.io/ja/2025/04/09/K8s%E5%A4%87%E5%BF%98-%E4%B8%8A/k8s_ingress.png">
<meta property="og:image" content="https://jade-xyy.github.io/ja/2025/04/09/K8s%E5%A4%87%E5%BF%98-%E4%B8%8A/k8s_nginx.png">
<meta property="og:image" content="https://jade-xyy.github.io/ja/2025/04/09/K8s%E5%A4%87%E5%BF%98-%E4%B8%8A/k8s_image_pull.png">
<meta property="og:image" content="https://jade-xyy.github.io/ja/2025/04/09/K8s%E5%A4%87%E5%BF%98-%E4%B8%8A/k8s_volume.png">
<meta property="og:image" content="https://jade-xyy.github.io/ja/2025/04/09/K8s%E5%A4%87%E5%BF%98-%E4%B8%8A/k8s_pv.png">
<meta property="og:image" content="https://jade-xyy.github.io/ja/2025/04/09/K8s%E5%A4%87%E5%BF%98-%E4%B8%8A/k8s_pv_accessmode.png">
<meta property="og:image" content="https://jade-xyy.github.io/ja/2025/04/09/K8s%E5%A4%87%E5%BF%98-%E4%B8%8A/k8s_pvs_nfs.png">
<meta property="article:published_time" content="2025-04-09T09:05:17.000Z">
<meta property="article:modified_time" content="2025-04-14T06:43:42.010Z">
<meta property="article:author" content="本堂主">
<meta property="article:tag" content="k8s">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://jade-xyy.github.io/ja/2025/04/09/K8s%E5%A4%87%E5%BF%98-%E4%B8%8A/k8s_module.png">
  
  
    <link rel="alternate" href="/atom.xml" title="本堂主Blog" type="application/atom+xml">
  
  
    <link rel="shortcut icon" href="/images/favicon.ico">
  
  
<link rel="stylesheet" href="/css/style.css">

  <link rel="preload" href="https://npm.webcache.cn/photoswipe@5.4.4/dist/photoswipe.css" as="style" onload="this.onload=null;this.rel='stylesheet'">
  
  
  
  
    
<script src="https://npm.webcache.cn/pace-js@1.2.4/pace.min.js" integrity="sha384-k6YtvFUEIuEFBdrLKJ3YAUbBki333tj1CSUisai5Cswsg9wcLNaPzsTHDswp4Az8" crossorigin="anonymous"></script>

  
  
    
<link rel="stylesheet" href="https://npm.webcache.cn/@reimujs/aos@0.1.0/dist/aos.css">

  
  
  
<meta name="generator" content="Hexo 7.3.0"></head>

  <body>
    
    
  <div id='loader'>
    <div class="loading-left-bg loading-bg"></div>
    <div class="loading-right-bg loading-bg"></div>
    <div class="spinner-box">
      <div class="loading-taichi">
        
          <svg width="150" height="150" viewBox="0 0 1024 1024" class="icon" version="1.1" xmlns="https://www.w3.org/2000/svg" shape-rendering="geometricPrecision">
            <path d="M303.5 432A80 80 0 0 1 291.5 592A80 80 0 0 1 303.5 432z" fill="var(--red-1, #ff5252)" />
            <path d="M512 65A447 447 0 0 1 512 959L512 929A417 417 0 0 0 512 95A417 417 0 0 0 512 929L512 959A447 447 0 0 1 512 65z 
           M512 95A417 417 0 0 1 929 512A208.5 208.5 0 0 1 720.5 720.5L720.5 592A80 80 0 0 0 720.5 432A80 80 0 0 0 720.5 592L720.5 720.5A208.5 208.5 0 0 1 512 512A208.5 208.5 0 0 0 303.5 303.5A208.5 208.5 0 0 0 95 512A417 417 0 0 1 512 95z" fill="var(--red-1, #ff5252)" />
          </svg>
        
      </div>
      <div class="loading-word">Wait a moment ...</div>
    </div>
  </div>
  </div>
  <script>
    var time = null;
    var startLoading = () => {
      time = Date.now();
      document.getElementById('loader').classList.remove("loading");
    }
    var endLoading = () => {
      if (!time) {
        document.body.style.overflow = 'auto';
        document.getElementById('loader').classList.add("loading");
      } else {
        if (Date.now() - time > 500) {
          time = null;
          document.body.style.overflow = 'auto';
          document.getElementById('loader').classList.add("loading");
        } else {
          setTimeout(endLoading, 500 - (Date.now() - time));
          time = null;
        }
      }
    }
    window.addEventListener('DOMContentLoaded', endLoading);
    document.getElementById('loader').addEventListener('click', endLoading);
  </script>

<div id="copy-tooltip" style="pointer-events: none; opacity: 0; transition: all 0.2s ease; position: fixed;top: 50%;left: 50%;z-index: 999;transform: translate(-50%, -50%);color: white;background: rgba(0, 0, 0, 0.5);padding: 10px 15px;border-radius: 10px;">
</div>


    <div id="container">
      <div id="wrap">
        <div id="header-nav">
  <nav id="main-nav">
    
      
        <span class="main-nav-link-wrap">
          <div class="main-nav-icon icon rotate">
            &#xe62b;
          </div>
          <a class="main-nav-link" href="/ja/">ホーム</a>
        </span>
      
        <span class="main-nav-link-wrap">
          <div class="main-nav-icon icon rotate">
            &#xe62b;
          </div>
          <a class="main-nav-link" href="/ja/archives">アーカイブ</a>
        </span>
      
        <span class="main-nav-link-wrap">
          <div class="main-nav-icon icon rotate">
            &#xe62b;
          </div>
          <a class="main-nav-link" href="/ja/about">プロフィール</a>
        </span>
      
        <span class="main-nav-link-wrap">
          <div class="main-nav-icon icon rotate">
            &#xe62b;
          </div>
          <a class="main-nav-link" href="/ja/friend">フレンド</a>
        </span>
      
    
    <a id="main-nav-toggle" class="nav-icon"></a>
  </nav>
  <nav id="sub-nav">
    
      <a id="nav-rss-link" class="nav-icon" href="/atom.xml" title="RSS フィード" target="_blank"></a>
    
    
    
      <a id="nav-search-btn" class="nav-icon popup-trigger" title="検索"></a>
    
  </nav>
  
    
    <nav id="i18n-nav">
      <div class="custom-dropdown">
        <div class="select-selected" id="select-selected">
          <span id="nav-language-btn" class="nav-icon" style="padding: 0 20px 0 0"></span>
          <span id="selected-lang">日本語</span>
        </div>
        <ul class="select-items" id="select-items">
          
            <li data-value="zh-CN" >简体中文</li>
          
            <li data-value="en" >English</li>
          
            <li data-value="ja" class="selected">日本語</li>
          
        </ul>
      </div>
      <script>
        var selectSelected = document.getElementById("select-selected");
        var selectedLang = document.getElementById("selected-lang");
        var selectItems = document.getElementById("select-items");
        var selectOptions = selectItems.querySelectorAll("li");

        selectSelected.addEventListener("click", () => {
          selectItems.classList.toggle("show");
        });

        selectOptions.forEach((item) => {
          item.addEventListener("click", () => {
            const langMap = {};
            
              langMap['zh-CN'] = '/2025/04/09/K8s备忘-上/';
            
              langMap['en'] = '/en/2025/04/09/K8s备忘-上/';
            
              langMap['ja'] = '/ja/2025/04/09/K8s备忘-上/';
            
            selectedLang.textContent = item.textContent;
            selectItems.classList.remove("show");
            selectOptions.forEach((option) => {
              option.classList.remove("selected");
            });
            item.classList.add("selected");
            window.location = langMap[item.dataset.value];
          });
        });

        document.addEventListener("click", (event) => {
          if (!event.target.closest(".custom-dropdown")) {
            selectItems.classList.remove("show");
          }
        });
      </script>
    </nav>
  
</div>
<header id="header">
  
    
      
        <picture>
          
            
              <source media="(max-width: 479px)" srcset="/images/banner-600w.webp">
            
              <source media="(max-width: 799px)" srcset="/images/banner-800w.webp">
            
              <source media="(min-width: 800px)" srcset="/images/banner.webp">
            
            <img  fetchpriority="high" src="/images/banner.webp" alt="K8s备忘 - 上">
          
        </picture>
        
          <img alt="K8s备忘 - 上" style="visibility: hidden;">
        
      
    
  
  <div id="header-outer">
    <div id="header-title">
      
        
        
          <a href="/" id="logo">
            <h1 data-aos="slide-up">K8s备忘 - 上</h1>
          </a>
        
      
      
        
        <h2 id="subtitle-wrap" data-aos="slide-down">
          
        </h2>
      
    </div>
  </div>
</header>

        <div id="content"  class="sidebar-right" >
          <aside id="sidebar">
  
  
  
  <div class="sidebar-wrapper wrap-sticky">
    <div class="sidebar-wrap" data-aos="fade-up">
      
        
          <div class="sidebar-toc-sidebar"><div class="sidebar-toc">
  <h3 class="toc-title">見出し</h3>
  <div class="sidebar-toc-wrapper toc-div-class" >
      
        <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#K8s%E5%A4%87%E5%BF%98"><span class="toc-number">1.</span> <span class="toc-text">K8s备忘</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#k8s%E5%B8%B8%E7%94%A8%E5%91%BD%E4%BB%A4"><span class="toc-number">1.1.</span> <span class="toc-text">k8s常用命令</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E2%80%A6-%E2%80%A6-%E2%80%A6-kubectl-%E2%80%A6-%E2%80%A6-%E2%80%A6-%E2%88%9E"><span class="toc-number">1.1.0.1.</span> <span class="toc-text">… … … kubectl … … … ∞</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E2%80%A6-%E2%80%A6-%E2%80%A6-deployment-%E2%80%A6-%E2%80%A6-%E2%80%A6-%E2%88%9E"><span class="toc-number">1.1.0.2.</span> <span class="toc-text">… … … deployment … … … ∞</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E2%80%A6-%E2%80%A6-%E2%80%A6-ipvs-%E2%80%A6-%E2%80%A6-%E2%80%A6-%E2%88%9E"><span class="toc-number">1.1.0.3.</span> <span class="toc-text">… … … ipvs … … … ∞</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E2%80%A6-%E2%80%A6-%E2%80%A6-docker-%E2%80%A6-%E2%80%A6-%E2%80%A6-%E2%88%9E"><span class="toc-number">1.1.0.4.</span> <span class="toc-text">… … … docker … … … ∞</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#K8s%E7%BB%84%E4%BB%B6"><span class="toc-number">1.2.</span> <span class="toc-text">K8s组件</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#Master%E7%9A%84%E7%BB%84%E4%BB%B6"><span class="toc-number">1.2.0.1.</span> <span class="toc-text">Master的组件</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Node%E7%9A%84%E7%BB%84%E4%BB%B6"><span class="toc-number">1.2.0.2.</span> <span class="toc-text">Node的组件</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%85%B6%E4%BB%96%E6%8F%92%E4%BB%B6"><span class="toc-number">1.2.0.3.</span> <span class="toc-text">其他插件</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Pod"><span class="toc-number">1.3.</span> <span class="toc-text">Pod</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%88%86%E7%B1%BB"><span class="toc-number">1.3.0.1.</span> <span class="toc-text">分类</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%B5%84%E6%BA%90%E6%B8%85%E5%8D%95"><span class="toc-number">1.4.</span> <span class="toc-text">资源清单</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%B5%84%E6%BA%90"><span class="toc-number">1.4.0.1.</span> <span class="toc-text">资源</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%9B%86%E7%BE%A4%E8%B5%84%E6%BA%90%E5%88%86%E7%B1%BB"><span class="toc-number">1.4.0.2.</span> <span class="toc-text">集群资源分类</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%B5%84%E6%BA%90%E6%B8%85%E5%8D%95YAML"><span class="toc-number">1.4.0.3.</span> <span class="toc-text">资源清单YAML</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%AE%B9%E5%99%A8%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F"><span class="toc-number">1.4.0.4.</span> <span class="toc-text">容器生命周期</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#Init%E5%AE%B9%E5%99%A8%E4%B8%8E%E6%99%AE%E9%80%9A%E5%AE%B9%E5%99%A8%E9%9D%9E%E5%B8%B8%E5%83%8F%EF%BC%8C%E9%99%A4%E4%BA%86%E5%A6%82%E4%B8%8B%E4%B8%A4%E7%82%B9"><span class="toc-number">1.4.0.4.1.</span> <span class="toc-text">Init容器与普通容器非常像，除了如下两点</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#Init%E5%AE%B9%E5%99%A8%E5%90%AF%E5%8A%A8%E7%9B%B8%E5%85%B3%E4%BB%A3%E7%A0%81%E4%BC%98%E5%8A%BF%EF%BC%9A%EF%BC%88%E5%9B%A0%E4%B8%BAInit%E5%AE%B9%E5%99%A8%E5%85%B7%E6%9C%89%E4%B8%8E%E5%BA%94%E7%94%A8%E7%A8%8B%E5%BA%8F%E5%AE%B9%E5%99%A8%E5%88%86%E7%A6%BB%E7%9A%84%E5%8D%95%E7%8B%AC%E9%95%9C%E5%83%8F%EF%BC%8C%E6%89%80%E4%BB%A5%E6%9C%89%E5%A6%82%E4%B8%8B%E4%BC%98%E5%8A%BF%EF%BC%89"><span class="toc-number">1.4.0.4.2.</span> <span class="toc-text">Init容器启动相关代码优势：（因为Init容器具有与应用程序容器分离的单独镜像，所以有如下优势）</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#Init%E5%AE%B9%E5%99%A8%E7%9A%84%E7%89%B9%E6%AE%8A%E8%AF%B4%E6%98%8E"><span class="toc-number">1.4.0.4.3.</span> <span class="toc-text">Init容器的特殊说明</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#Pod-phase%EF%BC%88%E7%9B%B8%E4%BD%8D%EF%BC%89-%E5%8F%AF%E8%83%BD%E5%AD%98%E5%9C%A8%E7%9A%84%E5%80%BC"><span class="toc-number">1.4.0.4.4.</span> <span class="toc-text">Pod phase（相位） 可能存在的值</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%8E%A2%E9%92%88"><span class="toc-number">1.4.0.5.</span> <span class="toc-text">探针</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%8E%A2%E9%92%88%E6%98%AF%E7%94%B1kubelet%E5%AF%B9%E5%AE%B9%E5%99%A8%E6%89%A7%E8%A1%8C%E7%9A%84%E5%AE%9A%E6%9C%9F%E8%AF%8A%E6%96%AD"><span class="toc-number">1.4.0.5.1.</span> <span class="toc-text">探针是由kubelet对容器执行的定期诊断</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%8E%A2%E6%B5%8B%E7%BB%93%E6%9E%9C%EF%BC%9A%E6%AF%8F%E6%AC%A1%E6%8E%A2%E6%B5%8B%E9%83%BD%E5%B0%86%E8%8E%B7%E5%BE%97%E4%BB%A5%E4%B8%8B%E4%B8%89%E7%A7%8D%E7%BB%93%E6%9E%9C%E4%B9%8B%E4%B8%80%EF%BC%9A"><span class="toc-number">1.4.0.5.2.</span> <span class="toc-text">探测结果：每次探测都将获得以下三种结果之一：</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%8E%A2%E6%B5%8B%E6%96%B9%E5%BC%8F%EF%BC%9A"><span class="toc-number">1.4.0.5.3.</span> <span class="toc-text">探测方式：</span></a></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Pod%E6%8E%A7%E5%88%B6%E5%99%A8%EF%BC%88controller%EF%BC%8C%E7%9B%B8%E5%BD%93%E4%BA%8E%E4%B8%80%E4%B8%AA%E7%8A%B6%E6%80%81%E6%9C%BA%E7%94%A8%E6%9D%A5%E6%8E%A7%E5%88%B6Pod%E7%9A%84%E5%85%B7%E4%BD%93%E7%8A%B6%E6%80%81%E5%92%8C%E8%A1%8C%E4%B8%BA%EF%BC%89"><span class="toc-number">1.5.</span> <span class="toc-text">Pod控制器（controller，相当于一个状态机用来控制Pod的具体状态和行为）</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#ReplicationController"><span class="toc-number">1.5.0.1.</span> <span class="toc-text">ReplicationController</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#ReplicaSet"><span class="toc-number">1.5.0.2.</span> <span class="toc-text">ReplicaSet</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Deployment"><span class="toc-number">1.5.0.3.</span> <span class="toc-text">Deployment</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Horizontal-Pod-Autoscaling"><span class="toc-number">1.5.0.4.</span> <span class="toc-text">Horizontal Pod Autoscaling</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#DaemonSet"><span class="toc-number">1.5.0.5.</span> <span class="toc-text">DaemonSet</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#StatefulSet"><span class="toc-number">1.5.0.6.</span> <span class="toc-text">StatefulSet</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Job"><span class="toc-number">1.5.0.7.</span> <span class="toc-text">Job</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#CronJob"><span class="toc-number">1.5.0.8.</span> <span class="toc-text">CronJob</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%BD%91%E7%BB%9C"><span class="toc-number">1.6.</span> <span class="toc-text">网络</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#Service"><span class="toc-number">1.6.0.1.</span> <span class="toc-text">Service</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%A6%82%E5%BF%B5%EF%BC%9A"><span class="toc-number">1.6.0.1.1.</span> <span class="toc-text">概念：</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#svc%E7%B1%BB%E5%9E%8B"><span class="toc-number">1.6.0.1.2.</span> <span class="toc-text">svc类型</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#VIP%E5%92%8CSVC%E4%BB%A3%E7%90%86"><span class="toc-number">1.6.0.1.3.</span> <span class="toc-text">VIP和SVC代理</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E4%BB%A3%E7%90%86%E6%A8%A1%E5%BC%8F%E5%88%86%E7%B1%BB"><span class="toc-number">1.6.0.1.4.</span> <span class="toc-text">代理模式分类</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#svc%E6%89%80%E9%9C%80%E7%BB%84%E4%BB%B6"><span class="toc-number">1.6.0.1.5.</span> <span class="toc-text">svc所需组件</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Ingress"><span class="toc-number">1.6.0.2.</span> <span class="toc-text">Ingress</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#nginx%E5%86%85%E9%83%A8%E5%8D%8F%E7%A8%8B%E6%B2%9F%E9%80%9A%E6%96%B9%E6%A1%88"><span class="toc-number">1.6.0.2.1.</span> <span class="toc-text">nginx内部协程沟通方案</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%BD%91%E7%BB%9C%E9%80%9A%E8%AE%AF%E6%A8%A1%E5%BC%8F"><span class="toc-number">1.6.0.3.</span> <span class="toc-text">网络通讯模式</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%AE%9A%E4%B9%89"><span class="toc-number">1.6.0.3.1.</span> <span class="toc-text">定义</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#Flannel"><span class="toc-number">1.6.0.3.2.</span> <span class="toc-text">Flannel</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E9%80%9A%E8%AE%AF%E6%96%B9%E5%BC%8F"><span class="toc-number">1.6.0.3.3.</span> <span class="toc-text">通讯方式</span></a></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AD%98%E5%82%A8"><span class="toc-number">1.7.</span> <span class="toc-text">存储</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#configmap%EF%BC%88%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6%E6%B3%A8%E5%86%8C%E4%B8%AD%E5%BF%83%EF%BC%89"><span class="toc-number">1.7.0.1.</span> <span class="toc-text">configmap（配置文件注册中心）</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%8F%8F%E8%BF%B0%E4%BF%A1%E6%81%AF"><span class="toc-number">1.7.0.1.1.</span> <span class="toc-text">描述信息</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%88%9B%E5%BB%BA"><span class="toc-number">1.7.0.1.2.</span> <span class="toc-text">创建</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#Pod%E4%B8%AD%E4%BD%BF%E7%94%A8ConfigMap"><span class="toc-number">1.7.0.1.3.</span> <span class="toc-text">Pod中使用ConfigMap</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Secret"><span class="toc-number">1.7.0.2.</span> <span class="toc-text">Secret</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%8F%8F%E8%BF%B0%E4%BF%A1%E6%81%AF-1"><span class="toc-number">1.7.0.2.1.</span> <span class="toc-text">描述信息</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%88%86%E7%B1%BB-1"><span class="toc-number">1.7.0.2.2.</span> <span class="toc-text">分类</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Volume"><span class="toc-number">1.7.0.3.</span> <span class="toc-text">Volume</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%A6%82%E5%BF%B5"><span class="toc-number">1.7.0.3.1.</span> <span class="toc-text">概念</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E8%83%8C%E6%99%AF"><span class="toc-number">1.7.0.3.2.</span> <span class="toc-text">背景</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%8D%B7%E7%9A%84%E7%B1%BB%E5%9E%8B"><span class="toc-number">1.7.0.3.3.</span> <span class="toc-text">卷的类型</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Persistent-Volume%EF%BC%88PV%EF%BC%89%E6%8C%81%E4%B9%85%E5%8D%B7"><span class="toc-number">1.7.0.4.</span> <span class="toc-text">Persistent Volume（PV）持久卷</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E9%9D%99%E6%80%81pv"><span class="toc-number">1.7.0.4.1.</span> <span class="toc-text">静态pv</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%8A%A8%E6%80%81"><span class="toc-number">1.7.0.4.2.</span> <span class="toc-text">动态</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E7%B1%BB%E5%9E%8B"><span class="toc-number">1.7.0.4.3.</span> <span class="toc-text">类型</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#pv%E6%BC%94%E7%A4%BA%E4%BB%A3%E7%A0%81"><span class="toc-number">1.7.0.4.4.</span> <span class="toc-text">pv演示代码</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#pv%E8%AE%BF%E9%97%AE%E6%A8%A1%E5%BC%8F"><span class="toc-number">1.7.0.4.5.</span> <span class="toc-text">pv访问模式</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%9B%9E%E6%94%B6%E7%AD%96%E7%95%A5"><span class="toc-number">1.7.0.4.6.</span> <span class="toc-text">回收策略</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E7%8A%B6%E6%80%81"><span class="toc-number">1.7.0.4.7.</span> <span class="toc-text">状态</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#PersistentVolumeClaim%EF%BC%88PVC%EF%BC%89%E6%8C%81%E4%B9%85%E5%8D%B7%E5%A3%B0%E6%98%8E"><span class="toc-number">1.7.0.5.</span> <span class="toc-text">PersistentVolumeClaim（PVC）持久卷声明</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E7%BB%91%E5%AE%9A"><span class="toc-number">1.7.0.5.1.</span> <span class="toc-text">绑定</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#pvc%E7%9A%84%E4%BF%9D%E6%8A%A4"><span class="toc-number">1.7.0.5.2.</span> <span class="toc-text">pvc的保护</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%8C%81%E4%B9%85%E5%8C%96%E6%BC%94%E7%A4%BA%E8%AF%B4%E6%98%8E-NFS"><span class="toc-number">1.7.0.5.3.</span> <span class="toc-text">持久化演示说明 - NFS</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%85%B3%E4%BA%8Ests"><span class="toc-number">1.7.0.5.4.</span> <span class="toc-text">关于sts</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#sts%E7%9A%84%E5%90%AF%E5%81%9C%E9%A1%BA%E5%BA%8F"><span class="toc-number">1.7.0.5.5.</span> <span class="toc-text">sts的启停顺序</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#sts%E4%BD%BF%E7%94%A8%E5%9C%BA%E6%99%AF"><span class="toc-number">1.7.0.5.6.</span> <span class="toc-text">sts使用场景</span></a></li></ol></li></ol></li></ol></li></ol></li></ol>
      
  </div>
</div>
</div>
          <div class="sidebar-common-sidebar hidden"><div class="sidebar-author">
  <img data-src="/avatar/Omen.jpg" data-sizes="auto" alt="本堂主" class="lazyload">
  <div class="sidebar-author-name">本堂主</div>
  <div class="sidebar-description"></div>
</div>
<div class="sidebar-state">
  <div class="sidebar-state-article">
    <div>投稿</div>
    <div class="sidebar-state-number">13</div>
  </div>
  <div class="sidebar-state-category">
    <div>カテゴリー</div>
    <div class="sidebar-state-number">5</div>
  </div>
  <div class="sidebar-state-tag">
    <div>タグ</div>
    <div class="sidebar-state-number">9</div>
  </div>
</div>
<div class="sidebar-social">
  
</div>
<div class="sidebar-menu">
  
    
      <div class="sidebar-menu-link-wrap">
        <a class="sidebar-menu-link-dummy" href="/ja/" aria-label="ホーム"></a>
        <div class="sidebar-menu-icon icon rotate">
          &#xe62b;
        </div>
        <div class="sidebar-menu-link">ホーム</div>
      </div>
    
      <div class="sidebar-menu-link-wrap">
        <a class="sidebar-menu-link-dummy" href="/ja/archives" aria-label="アーカイブ"></a>
        <div class="sidebar-menu-icon icon rotate">
          &#xe62b;
        </div>
        <div class="sidebar-menu-link">アーカイブ</div>
      </div>
    
      <div class="sidebar-menu-link-wrap">
        <a class="sidebar-menu-link-dummy" href="/ja/about" aria-label="プロフィール"></a>
        <div class="sidebar-menu-icon icon rotate">
          &#xe62b;
        </div>
        <div class="sidebar-menu-link">プロフィール</div>
      </div>
    
      <div class="sidebar-menu-link-wrap">
        <a class="sidebar-menu-link-dummy" href="/ja/friend" aria-label="フレンド"></a>
        <div class="sidebar-menu-icon icon rotate">
          &#xe62b;
        </div>
        <div class="sidebar-menu-link">フレンド</div>
      </div>
    
  
</div>
</div>
        
      
      
        
          <div class="sidebar-btn-wrapper" style="position:static">
            <div class="sidebar-toc-btn current"></div>
            <div class="sidebar-common-btn"></div>
          </div>
        
      
    </div>
  </div>

  <div class="sidebar-widget">
  
  </div>
  
</aside>

          <section id="main"><article id="post-K8s备忘-上" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-inner" data-aos="fade-up">
    <div class="article-meta">
      <div class="article-date">
  <span class="article-date-link" data-aos="zoom-in">
    <time datetime="2025-04-09T09:05:17.000Z" itemprop="datePublished">2025-04-09</time>
    <time style="display: none;" id="post-update-time">2025-04-14</time>
  </span>
</div>

      
  <div class="article-category">
    <a class="article-category-link" href="/ja/categories/memos/" data-aos="zoom-in">memos</a><a class="article-category-link" href="/ja/categories/study/" data-aos="zoom-in">study</a>
  </div>


    </div>
    <div class="hr-line"></div>
    

    <div class="e-content article-entry" itemprop="articleBody">
      
      
        <h1 id="K8s备忘"><a href="#K8s备忘" class="headerlink" title="K8s备忘"></a>K8s备忘</h1><h2 id="k8s常用命令"><a href="#k8s常用命令" class="headerlink" title="k8s常用命令"></a>k8s常用命令</h2><h4 id="…-…-…-kubectl-…-…-…-∞"><a href="#…-…-…-kubectl-…-…-…-∞" class="headerlink" title="… … … kubectl … … … ∞"></a><code>… … … kubectl … … … ∞</code></h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment">#查看命名空间nsA下pod1的日志最近100行</span></span><br><span class="line">kubectl logs -f pod1 -n nsA --<span class="built_in">tail</span>=100</span><br><span class="line"></span><br><span class="line"><span class="comment">#查日志</span></span><br><span class="line">kubectl logs --<span class="built_in">tail</span>=1000 <span class="variable">$&#123;podname&#125;</span> -n cloudpath &gt; <span class="variable">$&#123;podname&#125;</span>.<span class="built_in">log</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#查看服务配置信息</span></span><br><span class="line">kubectl -n kubernetes-dashboard get service kubernetes-dashboard -o yaml</span><br><span class="line"></span><br><span class="line"><span class="comment">#查看服务信息，所在node就是访问的ip</span></span><br><span class="line">kubectl -n kubernetes-dashboard get service kubernetes-dashboard</span><br><span class="line"></span><br><span class="line"><span class="comment"># kubeworker节点添加label test=true</span></span><br><span class="line">kubectl get node | grep <span class="variable">$&#123;nodename_pre&#125;</span> | awk <span class="string">&#x27;&#123;print $1&#125;&#x27;</span> | xargs -I &#123;&#125; kubectl label node &#123;&#125; <span class="built_in">test</span>=<span class="literal">true</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># pod测试网络连通性</span></span><br><span class="line">kubectl <span class="built_in">exec</span> -it <span class="variable">$&#123;pod_name&#125;</span> -- ping 目标地址</span><br><span class="line"></span><br><span class="line"><span class="comment"># 替换集群公网config信息就可访问对应集群.kube/config</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 指定公网config执行命令</span></span><br><span class="line">kubectl get node --kubeconfig=/root/.kube/config</span><br><span class="line"></span><br><span class="line"><span class="comment"># </span></span><br><span class="line">kubectl get node --no-headers | <span class="keyword">while</span> <span class="built_in">read</span> node status; <span class="keyword">do</span> <span class="built_in">echo</span> <span class="string">&#x27;&gt;&gt;&gt;&gt;  [&#x27;</span><span class="variable">$node</span><span class="string">&#x27;]&#x27;</span>; kubectl describe node <span class="variable">$node</span> | grep Resource -A 3 ;<span class="keyword">done</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 设置ds不起pod，但不删除ds，通过增加一个所有node上都不存在的labels作为nodeSelector，让ds起不来</span></span><br><span class="line">kubectl -n openstack patch daemonset <span class="variable">$&#123;dsname&#125;</span> -p <span class="string">&#x27;&#123;&quot;spec&quot;: &#123;&quot;template&quot;: &#123;&quot;spec&quot;: &#123;&quot;nodeSelector&quot;: &#123;&quot;non-existing&quot;: &quot;true&quot;&#125;&#125;&#125;&#125;&#125;&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看资源对象</span></span><br><span class="line">kubectl api-resources</span><br></pre></td></tr></table></figure>
<h4 id="…-…-…-deployment-…-…-…-∞"><a href="#…-…-…-deployment-…-…-…-∞" class="headerlink" title="… … … deployment … … … ∞"></a><code>… … … deployment … … … ∞</code></h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 创建并记录 --record参数可以记录命令，可以方便的查看每次revision的变化</span></span><br><span class="line">kubectl create -f https://kubernetes.io/docs/user-guide/nginx-deployment.yaml --record</span><br><span class="line"><span class="comment"># 扩容</span></span><br><span class="line">kubectl scale deployment nginx-deployment --replicas 10</span><br><span class="line"><span class="comment"># 设置自动扩展（如果集群支持hpa（horizontal pod autoscaling））</span></span><br><span class="line">kubectl autoscale deploy nginx-deployment --min=10 --max=15 --cpu-percent=80</span><br><span class="line"><span class="comment"># 更新镜像</span></span><br><span class="line">kubectl <span class="built_in">set</span> image deploy/nginx-deployment nginx=nginx:1.9.1</span><br><span class="line"><span class="comment"># 回滚</span></span><br><span class="line"><span class="comment"># 只要deploy的rollout被触发就会创建一个revision。</span></span><br><span class="line"><span class="comment"># 也就是说当且仅当deploy的pod template（如&#x27;.spec.template&#x27;）被更改，例如更新template中的label和容器镜像时，就会创建出一个新的revision# 其他的更新，比如扩容deploy不会创建revision</span></span><br><span class="line"><span class="comment"># 因此可以很方便的手动或自动扩容，这意味着回退到历史revision时，只有deploy中的pod template部分才会回退</span></span><br><span class="line">kubectl rollout <span class="built_in">history</span> deploy/nginx-deployment <span class="comment">## 查看历史revision，创建时指定--record，revision会有详细信息</span></span><br><span class="line">kubectl rollout undo deploy/nginx-deployment</span><br><span class="line">kubectl rollout undo deploy/nginx-deployment --to-revision=2 <span class="comment">## 指定历史版本</span></span><br><span class="line">kubectl rollout pause deploy/nginx-deployment <span class="comment">## 暂停deploy的更新</span></span><br><span class="line">kubectl rollout status deploy/nginx-deployment <span class="comment">## 查看是否完成，如果完成会返回0的exit code，echo $?查看</span></span><br><span class="line"><span class="comment"># 可通过设置.spec.revisionHistoryLimit项来指定deploy最多保留多少revision历史记录，默认的会保留所有的revision；如果将该项设置为0，deploy就不允许回退了</span></span><br></pre></td></tr></table></figure>

<h4 id="…-…-…-ipvs-…-…-…-∞"><a href="#…-…-…-ipvs-…-…-…-∞" class="headerlink" title="… … … ipvs … … … ∞"></a><code>… … … ipvs … … … ∞</code></h4><p>ipvsadm -Ln</p>
<h4 id="…-…-…-docker-…-…-…-∞"><a href="#…-…-…-docker-…-…-…-∞" class="headerlink" title="… … … docker … … … ∞"></a><code>… … … docker … … … ∞</code></h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 一键删除全部容器</span></span><br><span class="line">docker <span class="built_in">rm</span> $(docker ps -qa)</span><br><span class="line"><span class="comment"># 删除镜像</span></span><br><span class="line">docker rmi IMAG</span><br><span class="line"><span class="comment"># 查看容器的IP地址</span></span><br><span class="line">docker inspect 容器</span><br><span class="line"><span class="comment"># 查看当前正在运行的容器进程号</span></span><br><span class="line">docker inspect --format <span class="string">&#x27;&#123;&#123; .State.Pid &#125;&#125;&#x27;</span> 容器ID</span><br><span class="line"><span class="comment"># 导入镜像</span></span><br><span class="line">tar -zxvf perl.tar.gz</span><br><span class="line">docker load -i perl.tar</span><br><span class="line"><span class="comment"># 复制容器内文件到本地</span></span><br><span class="line">docker <span class="built_in">cp</span> k8s_test_svc-test-56ccb44cb9-t2hnj_testns_399b7029-074f-46b5-89b7-3dbb156a5a3b_0:/test/gc.log /tmp/gc.log</span><br><span class="line">命令空间testns</span><br><span class="line">容器svc-test</span><br><span class="line">pod为svc-test-56ccb44cb9-t2hnj</span><br><span class="line">文件/test/gc.log</span><br><span class="line"><span class="comment"># docker打tag推镜像</span></span><br><span class="line">docker build -t java-demo-01:lastest .</span><br><span class="line">docker run -d -p 8111:8111 java-demo-01:latest -t</span><br><span class="line">docker images | grep java-demo-01</span><br><span class="line">docker tag c234sdgfsdg hub.jade.com/library/java-project-01:1.0.0</span><br><span class="line">docker push hub.jade.com/library/java-project-01:1.0.0</span><br></pre></td></tr></table></figure>

<hr>
<h2 id="K8s组件"><a href="#K8s组件" class="headerlink" title="K8s组件"></a>K8s组件</h2><p>高可用集群的高可用节点数一般是3 5 7 9，避免双数高可用集群副本数最好是&gt;&#x3D;3 奇数个<br><img src="k8s_module.png"></p>
<h4 id="Master的组件"><a href="#Master的组件" class="headerlink" title="Master的组件"></a>Master的组件</h4><ul>
<li>APIServer：所有服务访问统一入口</li>
<li>ControllerManager控制器：维持副本期望数</li>
<li>Scheduler调度器：负责接收任务，选择合适的节点进行分配任务</li>
<li>ETCD键值对数据库：存储K8s集群所有重要信息（持久化）,官方将它定位成一个可信赖的分布式键值存储服务，能够为整个分布式集群存储一些关键数据，协助分布式集群的正常运转ETCDv2直接存储到内存（已在k8sv1.11中弃用），v3引入本地卷的持久化（1.11前不存在意味着关机不会有损坏）</li>
</ul>
<h4 id="Node的组件"><a href="#Node的组件" class="headerlink" title="Node的组件"></a>Node的组件</h4><ul>
<li>Kubelet：维持pod生命周期直接跟容器引擎(docker)交互实现容器的生命周期管理</li>
<li>Kube-proxy：实现pod间访问、负载均衡，默认操作防火墙实现pod映射，新版ipvs负责写入规则至IPTables、IPVS 实现服务映射访问</li>
</ul>
<h4 id="其他插件"><a href="#其他插件" class="headerlink" title="其他插件"></a>其他插件</h4><ul>
<li>CoreDNS：可以为集群中的SVC创建一个域名IP的对应关系解析，实现负载均衡的其一</li>
<li>Dashboard：给K8s集群提供一个B&#x2F;S结构访问体系</li>
<li>Ingress Controller：官方只能实现四层代理，Ingress可以实现七层</li>
<li>Federation：提供一个可以跨集群中心多K8s统一管理功能</li>
<li>Prometheus：提供一个K8s集群的监控能力</li>
<li>ELK：提供K8s集群日志统一分析接入平台</li>
</ul>
<hr>
<h2 id="Pod"><a href="#Pod" class="headerlink" title="Pod"></a>Pod</h2><h4 id="分类"><a href="#分类" class="headerlink" title="分类"></a>分类</h4><p>自主式Pod：Pod退出了，此类Pod不会被创建<br>控制器管理的Pod：在控制器的生命周期里，始终要维持Pod的副本数目</p>
<blockquote>
<p>pause：只要有pod，此容器就会被启动，容器网络栈</p>
</blockquote>
<hr>
<h2 id="资源清单"><a href="#资源清单" class="headerlink" title="资源清单"></a>资源清单</h2><h4 id="资源"><a href="#资源" class="headerlink" title="资源"></a>资源</h4><p>K8s中所有的内容都抽象为资源，资源实例化之后，叫做对象</p>
<h4 id="集群资源分类"><a href="#集群资源分类" class="headerlink" title="集群资源分类"></a>集群资源分类</h4><ul>
<li>名称空间级别：仅ns内可见<ul>
<li>工作负载型资源（workload）：Pod、ReplicaSet、Deployment、StatefulSet、DaemonSet、Job、CronJob、ReplicationController（在v1.11版本被废弃）</li>
<li>服务发现及负载均衡型资源（ServiceDiscovery LoadBalance）：Service、Ingress</li>
<li>配置与存储型资源：Volume（存储卷）、CSI（容器存储接口，可扩展各种各样的第三方存储卷）</li>
<li>特殊类型的存储卷：ConfigMap（当配置中心来使用的资源类型）、Secret（保存敏感数据）、DownwardAPI（把外部环境中的信息输出给容器）</li>
</ul>
</li>
<li>集群级别：全集群可见（role）<ul>
<li>Namespace、Node、Role、ClusterRole、RoleBinding、ClusterRoleBinding</li>
</ul>
</li>
<li>元数据型：通过指标进行操作（HPA）<ul>
<li>HPA、PodTemplate、LimitRange</li>
</ul>
</li>
</ul>
<h4 id="资源清单YAML"><a href="#资源清单YAML" class="headerlink" title="资源清单YAML"></a>资源清单YAML</h4><p>yaml文件就是资源清单</p>
<p><strong>yaml意思：</strong> 仍是一种标记语言，但为了强调这种语言以数据为中心，而不是以标记语言为重点基本语法：<br>缩进只能用空格，不能用tab<br>缩进的空格数目不重要，只要相同层级的元素左侧对齐即可<br>注释用#<br><strong>yaml支持的数据结构：</strong><br>对象：键值对集合，又称为映射（mapping）&#x2F;哈希（hashes）&#x2F;字典（dictionary）<br>数组：一组按次序排列的值，又称为序列（sequence）&#x2F;列表（list）<br>纯量（scalars）：单个的、不可再分的值</p>
<ul>
<li>对象类型：对象的一组键值对，使用冒号结构表示<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">name: jade</span><br><span class="line">age: 18</span><br><span class="line"></span><br><span class="line"><span class="comment"># yaml也允许另一个写法，写成一个行内对象</span></span><br><span class="line"><span class="built_in">hash</span>: &#123; name: jade, age: 18 &#125;</span><br></pre></td></tr></table></figure></li>
<li>数组类型：一组连词线开头的行，构成一个数组<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">animal</span><br><span class="line">- Cat</span><br><span class="line">- Dog</span><br><span class="line"></span><br><span class="line"><span class="comment"># 数组也可以采用行内表示法 </span></span><br><span class="line">animal: [Cat, Dog]</span><br></pre></td></tr></table></figure></li>
<li>复合结构：对象和数组可以结合使用，形成复合结构<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">languages:</span><br><span class="line">- Ruby</span><br><span class="line">- Perl</span><br><span class="line">- Python</span><br><span class="line">websites:</span><br><span class="line">YAML: yaml.org</span><br><span class="line">Ruby: ruby-lang.org</span><br><span class="line">Python: python.org</span><br><span class="line">Perl: http://use.perl.org</span><br></pre></td></tr></table></figure></li>
<li>纯量：纯量是最基本的、不可再分的值<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">1.string boolean <span class="built_in">integer</span> <span class="built_in">float</span> Null</span><br><span class="line">2.时间 日期</span><br><span class="line"></span><br><span class="line"><span class="comment">## integer：直接以字面量的形式表示</span></span><br><span class="line">number: 12.30</span><br><span class="line"></span><br><span class="line"><span class="comment">## boolean：用true false表示</span></span><br><span class="line"></span><br><span class="line"><span class="comment">## null：用~表示，或者不写也表示null</span></span><br><span class="line"></span><br><span class="line"><span class="comment">## 时间采用ISO8601格式</span></span><br><span class="line">iso8601: 2001-12-14t21:59:43.10-05:00</span><br><span class="line"></span><br><span class="line"><span class="comment">## 日期采用复合iso8601格式的年、月、日表示</span></span><br><span class="line"><span class="built_in">date</span>: 1976-07-31</span><br><span class="line"></span><br><span class="line"><span class="comment">## yaml允许使用!!强制转换数据类型</span></span><br><span class="line">e: !!str 123</span><br><span class="line">f: !!str <span class="literal">true</span></span><br><span class="line"></span><br><span class="line"><span class="comment">## 字符串：默认不使用引号表示</span></span><br><span class="line"><span class="comment"># 包含空格或特殊字符需放在引号中：</span></span><br><span class="line">str: <span class="string">&#x27;内容: 字符串&#x27;</span></span><br><span class="line"><span class="comment"># 单引号、双引号都可使用，双银不会对特殊字符转义：</span></span><br><span class="line">s1: <span class="string">&#x27;内容\n字符串&#x27;</span></span><br><span class="line">s2: <span class="string">&quot;内容\n字符串&quot;</span></span><br><span class="line"><span class="comment"># 单引号中还有单引号，需用另一个单引号转义：</span></span><br><span class="line">str: <span class="string">&#x27;labor&#x27;</span><span class="string">&#x27;s day&#x27;</span></span><br><span class="line"><span class="comment"># 字符串可写成多行，从第二行开始必须有一个但空格缩进，换行符会被转换为空格</span></span><br><span class="line">str: 这是一段 </span><br><span class="line"> 多行</span><br><span class="line"> 字符串</span><br><span class="line"><span class="comment"># 多行字符串可以使用|保留换行符，也可以用&gt;折叠换行</span></span><br><span class="line">this: |</span><br><span class="line">Foo</span><br><span class="line">Bar</span><br><span class="line">that: &gt;</span><br><span class="line">Foo</span><br><span class="line">Bar</span><br><span class="line">+ 表示保留文字块末尾的换行，- 表示删除字符串末尾的换行</span><br><span class="line">s1: |</span><br><span class="line"> Foo</span><br><span class="line">s1: |+</span><br><span class="line"> Foo</span><br><span class="line">s1: |-</span><br><span class="line"> Foo</span><br><span class="line">```  </span><br><span class="line"></span><br><span class="line"><span class="comment">#### 常用字段说明</span></span><br><span class="line">```bash</span><br><span class="line">kubectl explain &lt;resources&gt; 可查看模板信息,required表示必需字段</span><br><span class="line">kubectl explain pod</span><br><span class="line">kubectl explain pod.api</span><br></pre></td></tr></table></figure></li>
<li>必须存在的对象</li>
</ul>
<table>
<thead>
<tr>
<th align="left">变量名</th>
<th align="center">类型</th>
<th align="left">作用</th>
</tr>
</thead>
<tbody><tr>
<td align="left">verison</td>
<td align="center">String</td>
<td align="left">指k8s API版本，目前是v1，可使用kubectl api-versions命令查看</td>
</tr>
<tr>
<td align="left">kind</td>
<td align="center">String</td>
<td align="left">指yaml文件定义的资源类型和角色，如Pod</td>
</tr>
<tr>
<td align="left">metadata</td>
<td align="center">Object</td>
<td align="left">元数据对象，固定值</td>
</tr>
<tr>
<td align="left">metadata.name</td>
<td align="center">String</td>
<td align="left">元数据对象的名字，自定义，比如命名Pod的名字</td>
</tr>
<tr>
<td align="left">metadata.namespace</td>
<td align="center">String</td>
<td align="left">元数据对象的命名空间，默认default，可自定义</td>
</tr>
<tr>
<td align="left">Spec</td>
<td align="center">Object</td>
<td align="left">详细定义对象，固定值</td>
</tr>
<tr>
<td align="left">spec.containers[]</td>
<td align="center">list</td>
<td align="left">Spec对象的容器列表定义</td>
</tr>
<tr>
<td align="left">spec.containers[].name</td>
<td align="center">String</td>
<td align="left">定义容器的名字</td>
</tr>
<tr>
<td align="left">spec.containers[].image</td>
<td align="center">String</td>
<td align="left">定义要用到的镜像名称</td>
</tr>
</tbody></table>
<ul>
<li>主要对象，不写也可，会有默认值</li>
</ul>
<table>
<thead>
<tr>
<th align="left">变量名</th>
<th align="center">类型</th>
<th align="left">作用</th>
</tr>
</thead>
<tbody><tr>
<td align="left">spec.containers[].name</td>
<td align="center">String</td>
<td align="left">定义容器的名字，默认随机</td>
</tr>
<tr>
<td align="left">spec.containers[].image</td>
<td align="center">String</td>
<td align="left">定义要用到的镜像名称</td>
</tr>
<tr>
<td align="left">spec.containers[].imagePullPolicy</td>
<td align="center">String</td>
<td align="left">定义镜像拉去策略，可选Always（默认值，每次都尝试重新拉取镜像）、Never（仅使用本地镜像）、IfNotPresent（如果本地有镜像就是用本地镜像，没有就拉取在线镜像）</td>
</tr>
<tr>
<td align="left">spec.containers[].command[]</td>
<td align="center">list</td>
<td align="left">指定容器启动命令，因为是数组，可以指定多个，不指定则使用镜像打包时使用的启动命令</td>
</tr>
<tr>
<td align="left">spec.containers[].args[]</td>
<td align="center">list</td>
<td align="left">指定容器启动命令参数，因为是数组可以指定多个</td>
</tr>
<tr>
<td align="left">spec.containers[].workingDir</td>
<td align="center">string</td>
<td align="left">指定容器的工作目录</td>
</tr>
<tr>
<td align="left">spec.containers[].env[].name</td>
<td align="center">string</td>
<td align="left">指定环境变量名称</td>
</tr>
<tr>
<td align="left">spec.containers[].env[].value</td>
<td align="center">string</td>
<td align="left">指定环境变量值</td>
</tr>
<tr>
<td align="left">spec.containers[].resources</td>
<td align="center">object</td>
<td align="left">指定资源限制和资源请求的值（设置容器的资源上限）</td>
</tr>
<tr>
<td align="left">spec.containers[].resources.limits</td>
<td align="center">object</td>
<td align="left">指定设置容器运行时资源的运行上限</td>
</tr>
<tr>
<td align="left">spec.containers[].resources.limits.cpu</td>
<td align="center">string</td>
<td align="left">指定cpu的限制，单位为core数，将用于docker run –cpu-shares参数</td>
</tr>
<tr>
<td align="left">spec.containers[].resources.limits.memory</td>
<td align="center">string</td>
<td align="left">指定MEM内存的限制，单位MiB、GiB</td>
</tr>
<tr>
<td align="left">spec.containers[].resources.requests</td>
<td align="center">object</td>
<td align="left">指定容器启动和调度时的限制设置</td>
</tr>
<tr>
<td align="left">spec.containers[].resources.requests.cpu</td>
<td align="center">string</td>
<td align="left">cpu请求，单位为core数，容器启动时初始化可用数量</td>
</tr>
<tr>
<td align="left">spec.containers[].resources.requests.memory</td>
<td align="center">string</td>
<td align="left">内存请求，单位为MiB、GiB，容器启动时初始化可用数量</td>
</tr>
</tbody></table>
<ul>
<li>额外的参数项spec.restartPolicy</li>
</ul>
<table>
<thead>
<tr>
<th align="left">变量名</th>
<th align="center">类型</th>
<th align="left">作用</th>
</tr>
</thead>
<tbody><tr>
<td align="left">spec.restartPolicy</td>
<td align="center">string</td>
<td align="left">定义Pod的重启策略，可选值为Always（默认值，Pod一旦终止运行，则无论容器是如何终止的，kubelet都将重启它(重启多次将意外退出)）、OnFailure（只有Pod以非0退出码终止时，kubelet才会重启它；如果正常退出(退出码为0)，kubelet则不会重启它）、Never（Pod终止后，kubelet将退出码报告给master，不会重启该Pod）</td>
</tr>
<tr>
<td align="left">spec.nodeSelector</td>
<td align="center">object</td>
<td align="left">定义Node的Label过滤标签，以key:value格式指定</td>
</tr>
<tr>
<td align="left">spec.imagePullSecrets</td>
<td align="center">object</td>
<td align="left">定义pull镜像时使用secret名称，以name:secretkey格式指定</td>
</tr>
<tr>
<td align="left">spec.hostNetwork</td>
<td align="center">boolean</td>
<td align="left">定义是否使用主机网络模式，默认false，设置true表示使用宿主机网络，不使用docker网桥，同时设置了true将无法在同一台宿主机上启动第二个副本</td>
</tr>
</tbody></table>
<h4 id="容器生命周期"><a href="#容器生命周期" class="headerlink" title="容器生命周期"></a>容器生命周期</h4><p><img src="pod_lifecycle.png"><br>Pod能具有多个容器，应用运行在容器里，但是也有可能有一个或多个先于应用容器启动的Init容器</p>
<h5 id="Init容器与普通容器非常像，除了如下两点"><a href="#Init容器与普通容器非常像，除了如下两点" class="headerlink" title="Init容器与普通容器非常像，除了如下两点"></a>Init容器与普通容器非常像，除了如下两点</h5><p>Init容器总是运行到成功完成为止<br>每个Init容器都必须在下一个Init容器启动之前成功完成</p>
<blockquote>
<p>如果Pod的Init容器失败，Kubernetes会不断地重启该Pod，知道Init容器成功为止，但是如果Pod对应的restartPolicy为Never，它不会重新启动</p>
</blockquote>
<h5 id="Init容器启动相关代码优势：（因为Init容器具有与应用程序容器分离的单独镜像，所以有如下优势）"><a href="#Init容器启动相关代码优势：（因为Init容器具有与应用程序容器分离的单独镜像，所以有如下优势）" class="headerlink" title="Init容器启动相关代码优势：（因为Init容器具有与应用程序容器分离的单独镜像，所以有如下优势）"></a>Init容器启动相关代码优势：（因为Init容器具有与应用程序容器分离的单独镜像，所以有如下优势）</h5><p>Init容器可以包含并运行实用工具（出于安全考虑，不建议在应用程序容器镜像中包含这些实用工具）<br>Init容器可以包含使用工具和定制化代码来安装（但是不能出现在应用程序镜像中。例如创建镜像没必要from另一个镜像，会造成MainC的冗余，只需在安装过程中使用类似sed、sek、python或dig这样的工具）<br>应用程序镜像可以分离出创建和部署的角色，而没有必要联合他们构建一个单独的镜像<br>Init容器使用Linux Namespace，所以相对应用程序容器来说具有不通的文件系统视图，因此，他们能够具有访问Secret的权限，而应用程序则不能<br>Init容器必须在应用程序容器启动之前运行完成，而应用程序容器是并行运行的，所以Init容器能够提供一种简单的阻塞或延迟应用容器启动的方法，直到满足了一组先决条件</p>
<h5 id="Init容器的特殊说明"><a href="#Init容器的特殊说明" class="headerlink" title="Init容器的特殊说明"></a>Init容器的特殊说明</h5><p>在Pod启动过程中，Init容器会按顺序在 网络和数据卷初始化（pause中完成）之后启动，每个容器必须在下一个容器启动之前成功退出<br>如果由于运行时或失败退出，将导致容器启动失败，它会根据Pod的restartPolicy指定的策略进行重试。如果Pod的restartPolicy设置为Always，Init容器失败时会使用RestartPolicy策略<br>在所有的Init容器没有成功之前，Pod将不会变成Ready状态。Init容器的端口将不会在Service中进行聚集。正在初始化中的Pod处于Pending状态，但应该会将Initializing状态设置为true<br>如果Pod重启，所有Init容器必须重新执行<br>对Init容器spec的修改被限制在容器image字段，修改其他字段都不会生效，更改Init容器的image字段，等价于重启该Pod<br>Init容器具有应用容器的所有字段，除了readinessProde，因为Init容器无法定义不同于完成（completion）的就绪（readiness）之外的其他状态，这会在验证过程中强制执行<br>在Pod中的每个app和init容器的名称必须唯一，与任何其它容器共享同一个名称，会在验证时抛出错误</p>
<p>start stop</p>
<h5 id="Pod-phase（相位）-可能存在的值"><a href="#Pod-phase（相位）-可能存在的值" class="headerlink" title="Pod phase（相位） 可能存在的值"></a>Pod phase（相位） 可能存在的值</h5><p>挂起（Pending）：Pod已被k8s系统接受，但有1个或多个容器镜像尚未创建。等待时间包括调度Pod的时间和通过网络下载镜像的时间<br>运行中（Running）：该Pod已经绑定到了1个Node上，Pod中所有的容器都已被创建。至少有1个容器正在运行或处于启动或重启状态<br>成功（Succeeded）：Pod中所有容器都被成功终止，并且不会再重启（常出现在job cronjob中，以0状态退出）<br>失败（Failed）：Pod中所有容器都已终止，并且至少有1个容器是因为失败终止（以非0状态退出或被系统终止）<br>未知（Unknown）：因为某些原因无法取得Pod的状态，通常是因为与Pod所在主机通信失败</p>
<h4 id="探针"><a href="#探针" class="headerlink" title="探针"></a>探针</h4><h5 id="探针是由kubelet对容器执行的定期诊断"><a href="#探针是由kubelet对容器执行的定期诊断" class="headerlink" title="探针是由kubelet对容器执行的定期诊断"></a>探针是由kubelet对容器执行的定期诊断</h5><p>要执行诊断，kubelet调用由容器实现的Handler，有三种类型的处理程序：<br>ExecAction：在容器内执行指定命令。如果命令退出时返回码为0则认为诊断成功<br>TCPSocketAction：对指定端口上的容器的IP地址进行TCP检查，如果端口打开，则诊断被认为是成功的<br>HTTPGetAction：对指定的端口和路径上的容器的IP地址执行HTTPGet请求，如果200≤响应的状态码＜400（2xx成功 3xx跳转），则诊断被认为是成功的</p>
<h5 id="探测结果：每次探测都将获得以下三种结果之一："><a href="#探测结果：每次探测都将获得以下三种结果之一：" class="headerlink" title="探测结果：每次探测都将获得以下三种结果之一："></a>探测结果：每次探测都将获得以下三种结果之一：</h5><ul>
<li>成功Success：容器通过了诊断</li>
<li>失败Failure：容器未通过诊断</li>
<li>未知Unknown：诊断失败，因此不会采取任何行动</li>
</ul>
<h5 id="探测方式："><a href="#探测方式：" class="headerlink" title="探测方式："></a>探测方式：</h5><ul>
<li>livenessProbe:指示容器是否正在运行。如果存活探针失败，则kubelet会杀死容器，并且容器将受到其 重启策略 的影响。如果容器不提供存活探针，则默认状态为Success</li>
<li>readinessProbe:指示容器是否准备好服务请求。如果就绪探针失败，端口控制器将从与Pod匹配的所有Service的端点中删除该Pod的IP地址。初始延迟之前的就绪状态默认为Failure。如果容器不提供就绪探针，则默认状态为Success</li>
</ul>
<hr>
<h2 id="Pod控制器（controller，相当于一个状态机用来控制Pod的具体状态和行为）"><a href="#Pod控制器（controller，相当于一个状态机用来控制Pod的具体状态和行为）" class="headerlink" title="Pod控制器（controller，相当于一个状态机用来控制Pod的具体状态和行为）"></a>Pod控制器（controller，相当于一个状态机用来控制Pod的具体状态和行为）</h2><h4 id="ReplicationController"><a href="#ReplicationController" class="headerlink" title="ReplicationController"></a>ReplicationController</h4><p>用来确保容器应用的副本数始终保持在用户定义的副本数<br>如果有容器异常退出，会自动创建新的Pod来替代；如果有异常多出来的，会自动回收<br>新版k8s中建议用rs代替rc</p>
<h4 id="ReplicaSet"><a href="#ReplicaSet" class="headerlink" title="ReplicaSet"></a>ReplicaSet</h4><p>和rc没有本质的不通，只是名字不一样，但rs支持集合式的selector<br>虽然rs可独立使用，但建议用deploy自动管理rs，这样无需担心与其他机制不兼容问题（比如rs不支持rolling-update，但deploy支持）</p>
<h4 id="Deployment"><a href="#Deployment" class="headerlink" title="Deployment"></a>Deployment</h4><p>不负责pod的创建，deploy定义rs，rs创建pod</p>
<ul>
<li>更新策略<ul>
<li>更新的时候停用旧rs，创建新rs</li>
<li>deploy可以保证在升级时只有一定数量的pod是down的，默认会确保至少有比期望pod数量少一个是up状态（最多一个不可用）</li>
<li>同时也确保只创建出超过期望数量的一定数量的pod，默认会确保最多比期望的pod数量多一个的pod是up的（最多一个surge）</li>
<li>未来的k8s版本中，将从1-1变成25%-25%</li>
<li>kubectl describe deploy</li>
</ul>
</li>
<li>为pod和rs提供了一个声明式定义（declarative）方法，用来替代以前的ReplicationController来方便的管理应用，典型的应用场景包括：<ul>
<li>定义deploy来创建pod和rs</li>
<li>滚动升级和回滚应用</li>
<li>扩容和缩容</li>
<li>暂停和继续deploy<blockquote>
<p>（命令式编程：侧重于如何实现程序，需要把程序的实现过程按照逻辑结果一步步写下来<br>声明式编程：侧重于定义想要什么，然后告诉计算机&#x2F;引擎，让其帮你实现）<br>声明式（deploy）：apply（最优） create也可<br>命令式（rs）：create（最优），apply也可</p>
</blockquote>
</li>
</ul>
</li>
</ul>
<h4 id="Horizontal-Pod-Autoscaling"><a href="#Horizontal-Pod-Autoscaling" class="headerlink" title="Horizontal Pod Autoscaling"></a>Horizontal Pod Autoscaling</h4><p>HPA仅适用于deploy和rs，自动平滑扩缩容<br>在v1版本中仅支持根据pod的cpu利用率扩缩容<br>在vlalpha版本中，支持根据内存和用户自定义的metric扩缩容</p>
<h4 id="DaemonSet"><a href="#DaemonSet" class="headerlink" title="DaemonSet"></a>DaemonSet</h4><p>ds确保全部（或一些，比如打了污点的node）Node上运行1个Pod的副本，有且只有1个<br>有Node加入集群时，也会为其新增1个Pod；当有Node从集群移除时，Pod也会被回收<br>删除ds将会删除它创建的全部Pod</p>
<ul>
<li>ds的一些典型用法：<ul>
<li>运行集群存储daemon，例如在每个Node上运行glusterd、ceph</li>
<li>在每个Node上运行日志收集daemon，例如fluentd、logstash</li>
<li>在每个Node上运行监控daemon，例如prometheus node exporter、collectd、datadog代理、new relic代理、或ganglia gmond</li>
</ul>
</li>
</ul>
<h4 id="StatefulSet"><a href="#StatefulSet" class="headerlink" title="StatefulSet"></a>StatefulSet</h4><p>sts为了解决有状态服务的问题（对应deploy和rs是为无状态服务而设计）</p>
<ul>
<li>应用场景：<ul>
<li>稳定的持久化存储，即Pod重新调度后还是能访问到相同的持久化数据，基于PVC实现</li>
<li>稳定的网络标志，即Pod重新调度后其PodName和HostName不变，基于Headless Service（即没有ClusterIP的Service）实现有序部署，有序扩展，即Pod是有顺序的，在部署或扩展的时候要依据定义的顺序依次进行（即从0 - n-1，在下一个Pod运行前所有Pod必须是Running和Ready状态），基于init containers实现</li>
<li>有序收缩，有序删除（即从n-1 - 0）实现很难，目前mysql还不能稳定的在k8s中运行</li>
</ul>
</li>
</ul>
<h4 id="Job"><a href="#Job" class="headerlink" title="Job"></a>Job</h4><p>Job负责处理批任务，即仅执行一次的任务，保证批处理任务的1个或多个Pod成功结束</p>
<ul>
<li>特殊说明<ul>
<li>spec.template格式同pod</li>
<li>restartPolicy仅支持Never或OnFailure</li>
<li>单个Pod时，默认Pod成功运行后Job即结束</li>
<li>.spec.completions标志job结束需要成功运行的pod个数，默认1</li>
<li>.spec.parallelism标志并行运行的pod个数，默认1</li>
<li>spec.activeDeadlineSeconds标志失败Pod的重试最大时间，超过这个时间不会继续重试</li>
</ul>
</li>
</ul>
<h4 id="CronJob"><a href="#CronJob" class="headerlink" title="CronJob"></a>CronJob</h4><p>管理基于时间的Job，即* * * * *<br>在给定时间点只运行一次<br>周期性地在给定时间点运行</p>
<p>使用前提条件：当前使用的k8s集群版本≥1.8（对cronjob）。对于先前版本的集群(版本&lt;1.8)，启动apiserver时，通过传递选项（–runtime-config&#x3D;batch&#x2F;v2alpha1&#x3D;true）可以开启batch&#x2F;v2alpha1API</p>
<p>典型的用法如下：</p>
<ul>
<li>在给定的时间点调度job运行</li>
<li>创建周期性运行的job，例：数据库备份、发送邮件<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment">## 特殊说明</span></span><br><span class="line">spec.template格式同Pod</span><br><span class="line">restartPolicy仅支持Never或OnFailure</span><br><span class="line">单个Pod时，默认Pod成功运行后Job即结束    .spec.completions标志Jov结束需要成功运行的Pod个数，默认为1</span><br><span class="line">.spec.parallelism标志并运行的Pod个数，默认为1</span><br><span class="line">spec.activeDeadlineSeconds标志失败Pod的重试最大时间，超过这个时间不会继续重试    </span><br><span class="line">.spec.schedule：调度，必需字段，指定任务运行周期，格式同Cron</span><br><span class="line">.spec.jobTemplate：job模板，必需字段，指定需要运行的任务，格式同Job    </span><br><span class="line">.spec.startingDeadlineSeconds：启动job的期限（s级别），可选字段。如果因为任何原因错过被调度的时间，那错过执行时间的job被认为是失败的，如果没有指定，则没有期限    		</span><br><span class="line">.spec.concurrencyPolicy：并发策略，可选字段，指定了如何处理被CronJob创建的job的并发执行。只允许指定三种策略之一</span><br><span class="line">Allow（默认）：允许并发运行job</span><br><span class="line">Forbid：禁止并发运行，如果前一个还未完成，直接跳过下一个</span><br><span class="line">Replace：取消当前正运行的job，用新的替换</span><br><span class="line"><span class="comment"># 当前策略只能应用于同一个CronJob创建的Job，如果存在多个CronJob，他们创建的Job之间总是允许并发运行</span></span><br><span class="line">.spec.suspend：挂起，可选字段。默认<span class="literal">false</span>，设置为<span class="literal">true</span>，后续所有执行都会被挂起，对已经开始执行的job不起作用</span><br><span class="line">.spec.successfulJobsHistoryLimit和.spec.faildJobsHistoryLimit：历史限制，可选字段，指定了可以保留多少完成和失败的job。默认分别3（成功保留3个副本） 1（失败保留1个副本），设置限制的值为0，相关类型的job完成后将不会被保留</span><br></pre></td></tr></table></figure>
<blockquote>
<p>cronjob是否成功不好判断，只负责定期创建job，job的成功失败不会链接到cronjob</p>
</blockquote>
</li>
</ul>
<hr>
<h2 id="网络"><a href="#网络" class="headerlink" title="网络"></a>网络</h2><h4 id="Service"><a href="#Service" class="headerlink" title="Service"></a>Service</h4><p>服务发现，客户端想访问一组Pod，通过标签搜寻Pod<br>例：简单的一个svc（1个nginx、3个php Pod）3个pod的信息会记录到svc的负载队列，nginx配置信息只需指定到php的svc；pod如有更新会同步到svc里；nginx反向代理svc，svc会自动更新，不需要在nginx里做任何修改（不管pod扩缩容、更新，都不会对nginx或上一层服务造成影响）</p>
<h5 id="概念："><a href="#概念：" class="headerlink" title="概念："></a>概念：</h5><p>k8s service 定义了这样一种抽象：1个pod的逻辑分组，一种可以访问他们的策略 – 通常称为微服务，每一个svc都是服务。这一组pod能够被service访问到，通常是通过label selector</p>
<blockquote>
<p>svc能提供负载均衡的能力，但是在使用上有以下限制<br>默认只提供4层负载均衡能力，没有7层功能，也就是不能通过主机名、域名方案去负载均衡；有时需要更多的匹配规则来转发请求，这点上4层负载均衡不支持；可通过添加Ingress方案添加7层负载均衡的能力</p>
</blockquote>
<h5 id="svc类型"><a href="#svc类型" class="headerlink" title="svc类型"></a>svc类型</h5><p>在k8s中有以下四种类型：</p>
<ul>
<li>ClusterIP（默认）：自动分配一个仅Cluster内部可以访问的虚拟IP<br>主要在每个node节点使用iptables，将发向ClusterIP对应端口的数据，转发到kube-proxy中。kube-proxy自己内部实现有负载均衡的方法，并可以查询到service下对应pod的地址和端口，进而把数据转发给对应的pod的地址和端口<br><img src="k8s_clusterip.png"><br>为了实现上图的功能，主要需要一下几个组件协同工作：<br>__apiserver__：用户通过kubectl命令向apiserver发送创建service的命令，apiserver接收到请求后将数据存储到etcd中<br>__kube-proxy__：kubernetes的每个节点中都有一个叫作kube-proxy的进程，这个进程负责感知service、pod的变化，并将变化的信息写入本地的iptables规则中<br>__iptables__：使用NAT等技术将virtualIP的流量转至endpoint中<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment">## Headless Service（无头服务，特殊的ClusterIP）</span></span><br><span class="line"><span class="comment"># 有时不需要或不想要负载均衡、以及单独的service ip（虚拟ip），可通过指定clusterip（spec.clusterIP）的值为None来创建Headless Service。这类service不会分配clusterip，kube-proxy不会处理他们，而且平台也不会为他们进行负载均衡和路由</span></span><br><span class="line"></span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Service</span><br><span class="line">metadata:</span><br><span class="line">  name: myapp-headless</span><br><span class="line">  namespace: default</span><br><span class="line">spec:</span><br><span class="line">  selector:</span><br><span class="line">    app: myqpp</span><br><span class="line">  clusterIP: <span class="string">&quot;None&quot;</span></span><br><span class="line">  ports:</span><br><span class="line">  - port: 80</span><br><span class="line">    targetPort: 80</span><br><span class="line">    </span><br><span class="line">(dig命令需yum -y install bind-utils)</span><br><span class="line">dig -t A myapp-headless.default.svc.cluster.local. @10.96.0.10</span><br><span class="line"></span><br><span class="line">无头服务中，虽然没有svc，但可通过域名访问至不同Pod</span><br></pre></td></tr></table></figure></li>
<li>NodePort：在ClusterIP基础上位svc在每台机器上绑定一个端口，这样就可以通过<NodeIP>:<NodePort>来访问该服务<br>在node上开了一个端口，将向该端口的流量导入到kube-proxy，然后由kube-proxy进一步给到对应的pod<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 查询流程</span></span><br><span class="line">netstat -anpt | grep :30715</span><br><span class="line">iptables -t nat -nvL</span><br><span class="line">ipvsadm -Ln</span><br></pre></td></tr></table></figure></NodePort></NodeIP></li>
<li>LoadBalancer：在NodePort基础上，借助cloud provider(云供应商，要收费)创建一个外部负载均衡器，并将请求转发到<NodeIP>:<NodePort><br>和NodePort是同一种方式。区别在于LB比NodePort多了一步，就是可以调用cloud provider去创建LB来向节点导流，LB需花钱<br><img src="k8s_lb.png"></NodePort></NodeIP></li>
<li>ExternalName：把集群外部的服务引入到集群内部来，在集群内部直接使用。没有任何类型代理被创建，这只有k8s1.7或更高版本的kube-dns才支持<br>这种类型的service通过返回CNAME和它的值，可以讲服务映射到externalName字段的内容（例：hub.jade.com）。ExternalName service是service的特例，它没有selector，也没有定义任何的端口和Endpoint。相反的，对于运行在集群外部的服务，它通过返回该外部服务的别名这种方式来提供服务<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">kind: Servcie</span><br><span class="line">apiVersion: v1</span><br><span class="line">metadata:</span><br><span class="line">  name: my-service-1</span><br><span class="line">  namespace: default</span><br><span class="line">spec:</span><br><span class="line">  <span class="built_in">type</span>: ExternalName</span><br><span class="line">  externalName: hub.jade.com</span><br><span class="line">  </span><br><span class="line">dig -t A my-service-1.default.svc.cluster.local. @10.244.0.7</span><br></pre></td></tr></table></figure>
当查询主机my-service.default.svc.cluster.local(SVC_NAME.NAMESPACE.svc.cluster.local)时，集群的DNS服务将返回一个值my.database.example.com的CNAME记录。访问这个服务的工作方式和其他的相同，唯一不同的是重定向发生在DNS层，且不会进行代理或转发<br>相当于DNS的别名操作，将外部服务引入集群内部</li>
</ul>
<h5 id="VIP和SVC代理"><a href="#VIP和SVC代理" class="headerlink" title="VIP和SVC代理"></a>VIP和SVC代理</h5><p>k8s集群中，每个Node运行一个kube-proxy进程。kube-proxy负责为svc实现了一种VIP(虚拟IP)的形式，而不是ExternalName的形式。</p>
<ul>
<li><p>在k8s1.0版本，代理完全在userspace</p>
</li>
<li><p>在k8s1.1版本，新增iptables代理，但并不是默认的运行模式</p>
</li>
<li><p>从k8s1.2起，默认iptables代理</p>
</li>
<li><p>在k8s1.8.0-beata.0中，添加ipvs代理</p>
</li>
<li><p>在k8s1.14版本，开始默认使用ipvs代理<br>（性能递增）</p>
</li>
<li><p>在k8s1.0版本，svc是4层(TCP&#x2F;UDP over IP)概念</p>
</li>
<li><p>在k8s1.1版本，新增Ingress API(beta版)，用来表示7层(HTTP)服务</p>
</li>
</ul>
<blockquote>
<p>？为什么不使用 round-robin DNS进行负载均衡<br>dns会在很多客户端里进行缓存，很多服务访问dns进行域名解析，得到地址后，很多服务都不会清空缓存，意味着一旦有地址信息，不管访问几次还是这个地址信息</p>
</blockquote>
<h5 id="代理模式分类"><a href="#代理模式分类" class="headerlink" title="代理模式分类"></a>代理模式分类</h5><ol>
<li>userspace代理模式<br><img src="k8s_agent_us.png"></li>
<li>iptables代理模式<br><img src="k8s_agent_iptables.png"></li>
<li>ipvs代理模式<br><img src="k8s_agent_ipvs.png"><br> kube-proxy会监视k8s svc对象和endpoints，调用netlink接口以相应地创建ipvs规则并定期与k8s svc对象和endpoints对象同步ipvs规则，以确保ipvs状态与期望一致。访问服务时，流量将被重定向到其中一个后端Pod<br> 与iptables类似，ipvs于netfilter的hook功能，但是用哈希表作为底层数据结构并在内核空间中工作。这意味着ipvs可以更快地重定向流量，并且在同步代理规则时具有更好的性能。此外，ipvs为负载均衡算法提供了更多选项，例如：</li>
</ol>
<ul>
<li>rr：轮询调度</li>
<li>lc：最小连接数</li>
<li>dh：目标哈希</li>
<li>sh：源哈希</li>
<li>sed：最短期望延迟</li>
<li>nq：不排队调度<br><code>ipvs模式假定在运行kube-proxy之前的节点上都已经安装了ipvs内核模块，当kube-proxy以ipvs代理模式启动时，kube-proxy将验证节点上是否安装了ipvs模块，如果未安装，则kube-proxy将回退到iptables代理模式</code></li>
</ul>
<h5 id="svc所需组件"><a href="#svc所需组件" class="headerlink" title="svc所需组件"></a>svc所需组件</h5><p><img src="k8s_svc_module.png"></p>
<h4 id="Ingress"><a href="#Ingress" class="headerlink" title="Ingress"></a>Ingress</h4><p><img src="k8s_ingress.png"><br>其实对于nginx来说，暴露方式依然是NodePort</p>
<h5 id="nginx内部协程沟通方案"><a href="#nginx内部协程沟通方案" class="headerlink" title="nginx内部协程沟通方案"></a>nginx内部协程沟通方案</h5><p><img src="k8s_nginx.png"></p>
<h4 id="网络通讯模式"><a href="#网络通讯模式" class="headerlink" title="网络通讯模式"></a>网络通讯模式</h4><h5 id="定义"><a href="#定义" class="headerlink" title="定义"></a>定义</h5><p>k8s的网络模型假定了所有Pod都在一个可以直接连通的扁平的网络空间中（pod间可通过ip直接访问）<br>这在GCE（Google Compute Engine）里是现成的网络模型，k8s假定这个网络已存在<br>而在私有云里搭建k8s，就不能假定这个网络已存在，需要自己实现网络假设，将不同节点上的docker容器间的互相访问先打通，然后运行k8s</p>
<p>同一个Pod内的多个容器间：lo<br>各Pod之间的通讯：Overlay Network<br>Pod与Service之间的通讯：各节点的iptables规则</p>
<h5 id="Flannel"><a href="#Flannel" class="headerlink" title="Flannel"></a>Flannel</h5><ul>
<li>定义<br>最常用的在k8s中解决网络扁平化的方案，符合cni接口<br>是CoreOS针对k8s设计的一个网络规划服务，简单说是 让集群中不同节点主机创建的docker容器都具有全集群唯一的虚拟IP地址。而且它还能在这些IP地址之间建立一个覆盖网络（Overlay Network），通过这个覆盖网络，将数据包原封不动地传递到目标容器内</li>
<li>ETCD之Flannel提供说明：<br>存储管理Flannel可分配的IP地址段资源  监控ETCD中每个Pod的实际地址，并在内存中建立维护Pod节点路由表</li>
</ul>
<h5 id="通讯方式"><a href="#通讯方式" class="headerlink" title="通讯方式"></a>通讯方式</h5><ul>
<li>同一个Pod内部通讯：<br>同一个Pod共享同一个网络命名空间，共享同一个Linux协议栈（pause基础协议栈），直接使用lo（localhost）通讯</li>
<li>Pod1至Pod2<br>不在同一台主机<br>  Pod的地址是与docker0在同一个网段的，单docker0网段与宿主机网卡是两个完全不同的IP网段，并且不同Node之间的通信只能通过宿主机的物理网卡进行。将Pod的IP和所在Node的IP关联起来，通过这个关联让Pod可以互相访问<br>在同一台机器<br>  由docker0网桥直接转发请求至Pod2，不需要经过Flannel</li>
<li>Pod至Service的网络<br>目前基于性能考虑，全部为iptables维护和转发最新版是lvs进行转发维护</li>
<li>Pod到外网<br>Pod向外网发送请求，查找路由表，转发数据包到宿主机的网卡，宿主网卡完成路由选择后，iptables执行Masquerade（snat），把源IP更改为宿主网卡的IP，然后向外网服务器发送请求</li>
<li>外网访问Pod<br>Service借助service的nodeport方式</li>
</ul>
<p>Service网络（虚拟内部网络）<br>Pod网络（虚拟内部网络）<br>节点网络（真实物理网络）</p>
<hr>
<h2 id="存储"><a href="#存储" class="headerlink" title="存储"></a>存储</h2><h4 id="configmap（配置文件注册中心）"><a href="#configmap（配置文件注册中心）" class="headerlink" title="configmap（配置文件注册中心）"></a>configmap（配置文件注册中心）</h4><h5 id="描述信息"><a href="#描述信息" class="headerlink" title="描述信息"></a>描述信息</h5><p>ConfigMap功能在k8s1.2版本中引入，许多应用程序会从配置文件、命令行参数或环境变量中读取配置信息<br>ConfigMap API给我们提供了向容器中注入配置信息的机制，ConfigMap可以被用来保存单个属性，也可以用来保存整个配置文件或者JSON二进制等对象</p>
<h5 id="创建"><a href="#创建" class="headerlink" title="创建"></a>创建</h5><ol>
<li>使用目录创建<br>kubectl create configmap game-config –from-file&#x3D;..&#x2F;configmap&#x2F;kubectl<br>–from-file指定在目录下的所有文件都会被用在ConfigMap里面创建一个键值对，键：文件名；值：文件内容</li>
<li>使用文件创建<br>只要指定为一个文件就可以从单个文件中创建ConfigMap<br>kubectl create configmap game-config-2 –from-file&#x3D;..&#x2F;configmap&#x2F;kubectl&#x2F;game.properties<br>–from-file这个参数可以使用多次，可以使用两次分别指定上个实例中两个配置文件，效果和指定整个目录是一样的</li>
<li>使用字面值创建<br>使用文字值创建，利用–from-literal参数传递配置信息，该参数可以使用多次，格式如下<br>kubectl create cm special-config –from-literal&#x3D;special.how&#x3D;very –from-literal&#x3D;special.type&#x3D;charm</li>
</ol>
<h5 id="Pod中使用ConfigMap"><a href="#Pod中使用ConfigMap" class="headerlink" title="Pod中使用ConfigMap"></a>Pod中使用ConfigMap</h5><ul>
<li>使用cm替代环境变量（通过cm把环境变量注入到pod内部）<figure class="highlight yml"><table><tr><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ConfigMap</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">special-config</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">default</span></span><br><span class="line"><span class="attr">data:</span></span><br><span class="line">  <span class="attr">special.how:</span> <span class="string">very</span></span><br><span class="line">  <span class="attr">special.type:</span> <span class="string">charm</span></span><br><span class="line"></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ConfigMap</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">env-config</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">default</span></span><br><span class="line"><span class="attr">data:</span></span><br><span class="line">  <span class="attr">log_level:</span> <span class="string">INFO</span></span><br><span class="line"></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">dapi-test-pod</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">test-container</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">hub.jade.com/library/myapp:v1</span></span><br><span class="line">    <span class="attr">command:</span> [<span class="string">&quot;/bin/sh&quot;</span>, <span class="string">&quot;-c&quot;</span>, <span class="string">&quot;env&quot;</span>]</span><br><span class="line">    <span class="attr">env:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">SPECIAL_LEVEL_KEY</span></span><br><span class="line">        <span class="attr">valueFrom:</span></span><br><span class="line">          <span class="attr">configMapKeyRef:</span></span><br><span class="line">            <span class="attr">name:</span> <span class="string">special-config</span></span><br><span class="line">            <span class="attr">key:</span> <span class="string">special.how</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">SPECIAL_TYPE_KEY</span></span><br><span class="line">        <span class="attr">valueFrom:</span></span><br><span class="line">          <span class="attr">configMapKeyRef:</span></span><br><span class="line">            <span class="attr">name:</span> <span class="string">special-config</span></span><br><span class="line">            <span class="attr">key:</span> <span class="string">special.type</span></span><br><span class="line">    <span class="attr">envFrom:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">configMapRef:</span></span><br><span class="line">          <span class="attr">name:</span> <span class="string">env-config</span></span><br><span class="line">  <span class="attr">restartPolicy:</span> <span class="string">Never</span></span><br><span class="line">  </span><br><span class="line"><span class="comment"># kubectl log dapi-test-pod 会看到环境变量</span></span><br></pre></td></tr></table></figure></li>
<li>用ConfigMap设置命令行参数<figure class="highlight yml"><table><tr><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ConfigMap</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">special-config</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">default</span></span><br><span class="line"><span class="attr">data:</span></span><br><span class="line">  <span class="attr">special.how:</span> <span class="string">very</span></span><br><span class="line">  <span class="attr">special.type:</span> <span class="string">charm</span></span><br><span class="line"></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">dapi-test-pod</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">test-container</span></span><br><span class="line">      <span class="attr">image:</span> <span class="string">hub.jade.com/library/myapp:v1</span></span><br><span class="line">      <span class="attr">command:</span> [<span class="string">&quot;/bin/sh&quot;</span>, <span class="string">&quot;-c&quot;</span>, <span class="string">&quot;echo $(SPECIAL_LEVEL_KEY) $(SPECIAL_TYPE_KEY)&quot;</span>]</span><br><span class="line">      <span class="attr">env:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">SPECIAL_LEVEL_KEY</span></span><br><span class="line">          <span class="attr">valueFrom:</span></span><br><span class="line">            <span class="attr">configMapKeyRef:</span></span><br><span class="line">              <span class="attr">name:</span> <span class="string">special-config</span></span><br><span class="line">              <span class="attr">key:</span> <span class="string">special.how</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">SPECIAL_TYPE_KEY</span></span><br><span class="line">          <span class="attr">valueFrom:</span></span><br><span class="line">            <span class="attr">configMapKeyRef:</span></span><br><span class="line">              <span class="attr">name:</span> <span class="string">special-config</span></span><br><span class="line">              <span class="attr">key:</span> <span class="string">special.type</span></span><br><span class="line">  <span class="attr">restartPolicy:</span> <span class="string">Never</span></span><br></pre></td></tr></table></figure></li>
<li>通过数据卷插件使用ConfigMap<figure class="highlight yml"><table><tr><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ConfigMap</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">special-config</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">default</span></span><br><span class="line"><span class="attr">data:</span></span><br><span class="line">  <span class="attr">special.how:</span> <span class="string">very</span></span><br><span class="line">  <span class="attr">special.type:</span> <span class="string">charm</span></span><br></pre></td></tr></table></figure>
在数据卷里面使用这个cm，有不同的选项。<br>最基本的就是将文件填入数据卷，在这个文件中，键：文件名；值：文件内容<figure class="highlight yml"><table><tr><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">dapi-test-pod</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">test-container</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">hub.jade.com/library/myapp:v1</span></span><br><span class="line">    <span class="attr">command:</span> [<span class="string">&quot;/bin/sh&quot;</span>, <span class="string">&quot;-c&quot;</span>, <span class="string">&quot;cat /etc/config/special.how&quot;</span>]</span><br><span class="line">    <span class="attr">volumeMounts:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">config-volume</span></span><br><span class="line">      <span class="attr">mountPath:</span> <span class="string">/etc/config</span></span><br><span class="line">  <span class="attr">volumes:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">config-volume</span></span><br><span class="line">      <span class="attr">configMap:</span></span><br><span class="line">        <span class="attr">name:</span> <span class="string">special-config</span></span><br><span class="line">  <span class="attr">restart Policy:</span> <span class="string">Never</span></span><br><span class="line">  </span><br><span class="line">  <span class="comment"># kubectl exec &lt;pod_name&gt; -it -- /bin/sh </span></span><br><span class="line">  <span class="comment"># cd /etc/config</span></span><br><span class="line">  <span class="comment"># ls 可以看到special-config下的special.how和special.type</span></span><br></pre></td></tr></table></figure></li>
<li>ConfigMap的热更新<figure class="highlight yml"><table><tr><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ConfigMap</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">log-config</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">default</span></span><br><span class="line"><span class="attr">data:</span></span><br><span class="line">  <span class="attr">log_level:</span> <span class="string">INFO</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">extensions/v1beta1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">my-nginx</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">1</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">run:</span> <span class="string">my-nginx</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">my-nginx</span></span><br><span class="line">        <span class="attr">image:</span> <span class="string">hub.jade.com/library/myapp:v1</span></span><br><span class="line">        <span class="attr">ports:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">80</span></span><br><span class="line">        <span class="attr">volumeMounts:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">config-volume</span></span><br><span class="line">          <span class="attr">mountPath:</span> <span class="string">/etc/config</span></span><br><span class="line">      <span class="attr">volumes:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">config-volume</span></span><br><span class="line">          <span class="attr">configMap:</span></span><br><span class="line">            <span class="attr">name:</span> <span class="string">log-config</span></span><br><span class="line">            </span><br><span class="line"><span class="comment"># kubectl exec `kubectl get pods -l run=my-nginx -o=name | cut -d &quot;/&quot; -f2` -it -- cat /etc/config/log_level</span></span><br><span class="line"><span class="string">INFO</span></span><br></pre></td></tr></table></figure>
修改ConfigMap<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">kubectl edit configmap log-config</span><br></pre></td></tr></table></figure></li>
<li>修改log_level的值为DEBUG等待大概10s，再次查看环境变量的值<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">kubectl <span class="built_in">exec</span> `kubectl get pods -l run=my-nginx -o=name | <span class="built_in">cut</span> -d <span class="string">&quot;/&quot;</span> -f2` -it -- <span class="built_in">cat</span> /tmp/log_level</span><br><span class="line">DEBUG</span><br></pre></td></tr></table></figure>
<code>特别注意：cm如果以env的方式挂载至容器，修改cm并不会实现热更新</code><br>cm更新后滚动更新Pod<br>更新cm目前并不会触发相关pod的滚动更新，可以通过修改pod annotations的方式强制触发滚动更新<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">kubectl patch deploy my-nginx --patch <span class="string">&#x27;&#123;&quot;spec&quot;: &#123;&quot;template&quot;: &#123;&quot;metadata&quot;: &#123;&quot;annotations&quot;: &#123;&quot;version/config&quot;: &quot;20230301&quot;&#125;&#125;&#125;&#125;&#125;&#x27;</span></span><br></pre></td></tr></table></figure>
这个例子里我们在.spec.template.metadata.annotations中添加version&#x2F;config，每次通过修改version&#x2F;config来触发滚动更新</li>
</ul>
<p><code>！！！更新ConfigMap后：</code></p>
<ul>
<li>使用该cm挂载的env不会同步更新</li>
<li>使用该cm挂载的volume中的数据需要一段时间（实测大概10s）才能同步更新</li>
</ul>
<h4 id="Secret"><a href="#Secret" class="headerlink" title="Secret"></a>Secret</h4><h5 id="描述信息-1"><a href="#描述信息-1" class="headerlink" title="描述信息"></a>描述信息</h5><p>Secret解决了密码、token、密钥等敏感数据的配置问题，而不需要把这些敏感数据暴露到镜像或者Pod Spec中。Secret可以以Volume或环境变量的方式使用</p>
<h5 id="分类-1"><a href="#分类-1" class="headerlink" title="分类"></a>分类</h5><ul>
<li>Service Account（不常用）<br>用来访问k8s API，由k8s自动创建，并且会自动挂载到Pod的&#x2F;run&#x2F;secrets&#x2F;kubernetes.io&#x2F;serviceaccount目录中<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># $ kubectl run nginx --image nginx</span></span><br><span class="line"><span class="comment"># deployment &quot;nginx&quot; created</span></span><br><span class="line"><span class="comment"># $ kubectl get pods</span></span><br><span class="line">$ kubectl <span class="built_in">exec</span> kube-proxy-fb85x -n kube-system -it -- <span class="built_in">ls</span> /run/secrets/kubernetes.io/serviceaccount</span><br><span class="line">ca.crt</span><br><span class="line">namespace</span><br><span class="line">token</span><br></pre></td></tr></table></figure></li>
<li>Opaque<br>  base64编码格式的Secret，用来存储密码、密钥等<ul>
<li>创建说明<br>Opaque类型的数据是一个map类型，要求value是base64编码格式：<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ <span class="built_in">echo</span> -n <span class="string">&quot;admin&quot;</span> | <span class="built_in">base64</span></span><br><span class="line">YWRtaW4=</span><br><span class="line">$ <span class="built_in">echo</span> -n <span class="string">&quot;1f2d1e2e67df&quot;</span> | <span class="built_in">base64</span></span><br><span class="line">MNYyDFJKS1jidfj</span><br></pre></td></tr></table></figure>
secrets.yml<figure class="highlight yml"><table><tr><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Secret</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">mysecret</span></span><br><span class="line"><span class="attr">type:</span> <span class="string">Opaque</span></span><br><span class="line"><span class="attr">data:</span></span><br><span class="line">  <span class="attr">password:</span> <span class="string">MNYyDFJKS1jidfj</span></span><br><span class="line">  <span class="attr">username:</span> <span class="string">YWRtaW4=</span></span><br></pre></td></tr></table></figure></li>
<li>使用方式<figure class="highlight yml"><table><tr><td class="code"><pre><span class="line"><span class="comment">## 1.将Secret挂载到Volume中</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">secret-test</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">secret-test</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">volumes:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">secrets</span></span><br><span class="line">    <span class="attr">secret:</span></span><br><span class="line">      <span class="attr">secretName:</span> <span class="string">mysecret</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">image:</span> <span class="string">hub.jade.com/library/myapp:v1</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">db</span></span><br><span class="line">    <span class="attr">volumeMounts:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">secrets</span></span><br><span class="line">      <span class="attr">mountPath:</span> <span class="string">&quot;/etc/secrets&quot;</span></span><br><span class="line">      <span class="attr">readOnly:</span> <span class="literal">true</span></span><br><span class="line"><span class="comment"># kubectl exec secret-test -it -- cat /etc/secrets/username</span></span><br><span class="line"><span class="string">admin</span></span><br><span class="line"></span><br><span class="line"><span class="comment">## 2.将Secret导出到环境变量中</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">extensions/v1beta1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">pod-deployment</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">2</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">pod-deployment</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">pod-1</span></span><br><span class="line">        <span class="attr">image:</span> <span class="string">hub.jade.com/library/myapp:v1</span></span><br><span class="line">        <span class="attr">ports:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">80</span></span><br><span class="line">        <span class="attr">env:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">TEST_USER</span></span><br><span class="line">          <span class="attr">valueFrom:</span></span><br><span class="line">            <span class="attr">secretKeyRef:</span></span><br><span class="line">              <span class="attr">name:</span> <span class="string">mysecret</span></span><br><span class="line">              <span class="attr">key:</span> <span class="string">username</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">TEST_PASSWORD</span></span><br><span class="line">          <span class="attr">valueFrom:</span></span><br><span class="line">            <span class="attr">secretKeyRef:</span></span><br><span class="line">              <span class="attr">name:</span> <span class="string">mysecret</span></span><br><span class="line">              <span class="string">key:password</span></span><br><span class="line"><span class="comment"># kubectl exec pod-deployment-782347234-983284 -it -- echo $TEST_USER $TEST_PASSWORD</span></span><br><span class="line"><span class="string">admin</span></span><br><span class="line"><span class="string">1f2d1e2e67df</span></span><br></pre></td></tr></table></figure></li>
</ul>
</li>
<li>kubernetes.io&#x2F;dockerconfigjson<br>用来存储私有docker registry的认证信息<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 使用kubectl创建docker registry认证的secret</span></span><br><span class="line"><span class="comment"># $ kubectl create secret docker-registry myregistrykey --docker-server=DOCKER_REGISTRY_SERVER --docker-username=DOCKER_USER --docker-password=DOCKER_PASSWORD --docker-email=DOCKER_EMAIL</span></span><br><span class="line">$ kubectl create secret docker-registry myregistrykey --docker-server=hub.jade.com --docker-username=admin --docker-password=Harbor12345 --docker-email=281108530@qq.com</span><br><span class="line">secret <span class="string">&quot;myregistrykey&quot;</span> created.</span><br><span class="line"></span><br><span class="line"><span class="comment"># 在创建Pod的时候，通过imagePullSecrets来引用刚创建的myregistrykey</span></span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Pod</span><br><span class="line">metadata:</span><br><span class="line">  name: foo</span><br><span class="line">spec:</span><br><span class="line">  containers:</span><br><span class="line">    - name: foo</span><br><span class="line">      image: hub.jade.com/test/myapp:v2 <span class="comment"># 私有仓库的镜像</span></span><br><span class="line">  imagePullSecrets:</span><br><span class="line">    - name: myregistrykey <span class="comment"># 使用secret docker-registry myregistrykey进行认证</span></span><br></pre></td></tr></table></figure>
<code>如果不指定imagePullSecrets，拉取私有仓库镜像时会报错</code><br><img src="k8s_image_pull.png"></li>
</ul>
<h4 id="Volume"><a href="#Volume" class="headerlink" title="Volume"></a>Volume</h4><h5 id="概念"><a href="#概念" class="headerlink" title="概念"></a>概念</h5><p>容器磁盘上的文件的生命周期是短暂的，这就使得在容器中运行重要应用时会出现一些问题。<br>首先，当容器崩溃时，kubelet会重启它，但是容器中的文件将丢失（容器以镜像初始状态重新启动）；<br>其次，在Pod中同时运行多个容器时，这些容器之间通常需要共享文件，k8s中的Volume抽象可以很好的解决这些问题</p>
<h5 id="背景"><a href="#背景" class="headerlink" title="背景"></a>背景</h5><p>k8s中的卷有明确的寿命（与封装它的Pod相同），所以卷的生命比Pod中所有容器都长，当这个容器重启时，数据仍然得以保存<br>当然，当Pod不再存在时，卷也不复存在<br>k8s支持多种类型的卷，Pod可以同时使用任意数量的卷<br><img src="k8s_volume.png"><br>pod重启后，volume数据还在</p>
<h5 id="卷的类型"><a href="#卷的类型" class="headerlink" title="卷的类型"></a>卷的类型</h5><p>k8s支持以下类型的卷</p>
<ul>
<li>awsElsticVlockStor、azureDisk、azureFile、cephfs、csi、downwardAPI、emptyDir</li>
<li>fc、flocker、gcePersistentDisk、gitRepo、glusterfs、hostPath、iscsi、local、nfs</li>
<li>persistentVolumeClaim、projected、potworxVolume、quobyte、rbd、scaleIO、secret</li>
<li>storagesos、vsphereVolume<br><strong>emptyDir</strong><br>当Pod被分配给节点时，首先创建emptyDir卷，并且只要该Pod在该节点上运行，该卷就会存在<br>正如卷名，它最初是空的<br>Pod中的容器可以读取和写入emptyDir卷中的相同文件，尽管该卷可以挂载到每个容器中的相同或不同路径上<br>当出于任何原因从节点中删除Pod时，emptyDir中的数据被永久删除<br><code>容器崩溃不会从节点中移除Pod，因此emptyDir卷中的数据在容器崩溃时是安全的</code></li>
</ul>
<p>【emptyDir用法】：</p>
<ul>
<li>暂存空间，例如用于基于磁盘的合并排序</li>
<li>用作长时间计算崩溃恢复时的检查点</li>
<li>Web服务器容器提供数据时，保存内容管理器容器提取的文件<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">apiVersion: v1</span><br><span class="line">kind: Pod</span><br><span class="line">metadata:</span><br><span class="line">  name: test-pod-emptyDir</span><br><span class="line">spec:</span><br><span class="line">  containers:</span><br><span class="line">  - name: test-container1</span><br><span class="line">    image: hub.jade.com/test/myapp:v2</span><br><span class="line">    volumeMounts:</span><br><span class="line">    - mountPath: /cache</span><br><span class="line">      name: cache-volume</span><br><span class="line">  containers:</span><br><span class="line">  - name: test-container2</span><br><span class="line">    image: busybox</span><br><span class="line">    imagePullPolicy: IfNotPresent</span><br><span class="line">    <span class="built_in">command</span>: [<span class="string">&quot;/bin/sh&quot;</span>, <span class="string">&quot;-c&quot;</span>, <span class="string">&quot;sleep 6000s&quot;</span>]</span><br><span class="line">    volumeMounts:</span><br><span class="line">    - mountPath: /test</span><br><span class="line">      name: cache-volume</span><br><span class="line">  volumes:</span><br><span class="line">  - name: cache-volue</span><br><span class="line">    emptyDir: &#123;&#125;</span><br><span class="line">    </span><br><span class="line"><span class="comment"># kubectl exec test-pod-emptyDir -it -- ls /cache</span></span><br><span class="line">空的</span><br><span class="line"><span class="comment"># kubectl exec test-pod-emptyDir -c test-container1 -it -- cd /cache date&gt;test.txt</span></span><br><span class="line"><span class="comment"># kubectl exec test-pod-emptyDir -c test-container2 -it -- cd /test date&gt;&gt;test.txt</span></span><br><span class="line">两个目录下都有test.txt且内容相同</span><br></pre></td></tr></table></figure></li>
</ul>
<p><strong>hostPath</strong><br>hostPath卷将主机节点的文件系统中的文件或目录挂载到集群中</p>
<p>【hostPath用途】：</p>
<ul>
<li>运行需要访问Docker内部的容器；使用&#x2F;var&#x2F;lib&#x2F;docker的hostPath</li>
<li>在容器中运行cAdvisor；使用&#x2F;dev&#x2F;cgroups的hostPath</li>
</ul>
<p>除了所需的path属性之外，用户还可以为hostPath卷指定type</p>
<table>
<thead>
<tr>
<th align="left">值</th>
<th align="left">行为</th>
</tr>
</thead>
<tbody><tr>
<td align="left"></td>
<td align="left">空字符串（默认）用于向后兼容，意味着在挂载hostPath卷之前不会执行任何检查</td>
</tr>
<tr>
<td align="left">DirectoryOrCreate</td>
<td align="left">如果在给定的路径上没有任何东西存在，那么将根据需要在那里创建一个空目录，权限设置为0755，与kubelet具有相同的组和所有权</td>
</tr>
<tr>
<td align="left">Directory</td>
<td align="left">给定的路径下必须存在目录</td>
</tr>
<tr>
<td align="left">FileOrCreate</td>
<td align="left">如果在给定的路径上没有任何东西存在，那么会根据需要创建一个空文件，权限设置为0644，与kubelet具有相同的组和所有权</td>
</tr>
<tr>
<td align="left">File</td>
<td align="left">给定的路径下必须存在文件</td>
</tr>
<tr>
<td align="left">Socket</td>
<td align="left">给定的路径下必须存在UNIX套接字</td>
</tr>
<tr>
<td align="left">CharDevice</td>
<td align="left">给定的路径下必须存在字符设备</td>
</tr>
<tr>
<td align="left">BlockDevice</td>
<td align="left">给定的路径下必须存在块设备</td>
</tr>
</tbody></table>
<p>使用hostPath卷类型时请注意：</p>
<ul>
<li>由于每个节点上的文件不同，具有相同配置（例如从podTemplate创建的）的pod在不同节点上的行为可能会有所不同</li>
<li>当k8s按照计划添加资源感知调度时，将无法考虑hostPath使用的资源</li>
<li>在底层主机上创建的文件或目录只能由root写入。需要在特权容器中以root身份运行进程，或修改主机上的文件权限以便写入hostPath卷<figure class="highlight yml"><table><tr><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">test-pd</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">test-container</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">hub.jade.com/test/myapp:v2</span></span><br><span class="line">    <span class="attr">volumeMounts:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">mountPath:</span> <span class="string">/test-pd</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">test-volume</span></span><br><span class="line">  <span class="attr">volumes:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">test-volume</span></span><br><span class="line">    <span class="attr">hostPath:</span></span><br><span class="line">      <span class="comment"># directory location on host</span></span><br><span class="line">      <span class="attr">path:</span> <span class="string">/data</span></span><br><span class="line">      <span class="comment"># this field is optional</span></span><br><span class="line">      <span class="attr">type:</span> <span class="string">Directory</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 进容器写入文件</span></span><br><span class="line"><span class="string">kubectl</span> <span class="string">exec</span> <span class="string">test-pd</span> <span class="string">-it</span> <span class="string">--</span> <span class="string">/bin/sh</span></span><br><span class="line"><span class="string">cd</span> <span class="string">/test-pd/</span></span><br><span class="line"><span class="string">date</span> <span class="string">&gt;</span> <span class="string">test.txt</span></span><br><span class="line"><span class="comment"># 到主机节点查看</span></span><br><span class="line"><span class="string">cat</span> <span class="string">/data/test.txt</span></span><br></pre></td></tr></table></figure></li>
</ul>
<h4 id="Persistent-Volume（PV）持久卷"><a href="#Persistent-Volume（PV）持久卷" class="headerlink" title="Persistent Volume（PV）持久卷"></a>Persistent Volume（PV）持久卷</h4><p><img src="k8s_pv.png"><br>是由管理员设置的存储，它是集群的一部分<br>就像节点是集群中的资源一样，PV也是集群中的资源<br>PV是Volume之类的卷插件，但具有独立于使用PV的Pod的生命周期<br>此API对象包含存储实现的细节，即NFS、iSCSI或特定于云供应商的存储系统</p>
<h5 id="静态pv"><a href="#静态pv" class="headerlink" title="静态pv"></a>静态pv</h5><p>集群管理员创建一些pv，他们带有可供集群用户使用的实际存储的细节，他们存在于k8s api中，可用于消费</p>
<h5 id="动态"><a href="#动态" class="headerlink" title="动态"></a>动态</h5><p>暂时不友好，实现方案较难 价格昂贵<br>当管理员创建的静态pv都不匹配用户的pvc时，集群可能会尝试动态地为pvc创建卷，此配置基于StorageClasses：pvc必须请求【存储类】，并且管理员必须创建并配置该类才能进行动态创建，声明该类为可以有效地禁用其动态配置<br>要启用基于存储级别的动态存储配置，集群管理员需要启用api server上的DefaultStorageClass【准入控制器】。例如，通过确保DefaultStorageClass位于apiServer组件的–admission-control标志，使用逗号分隔的有序值列表中，可以完成此操作</p>
<h5 id="类型"><a href="#类型" class="headerlink" title="类型"></a>类型</h5><p>pv类型以插件形式实现，k8s目前支持以下插件类型</p>
<ul>
<li>GCEPersistentDisk AWSElasticBlockStore AzureFile FC(Fibre Channel)</li>
<li>FlexVolume  Flocker NFS iSCSI RBD(Ceph Block Device) CephFS</li>
<li>Cinder(OpenStack block storage)  Glusterfs  VsphereVolume  Quobyte Volumes</li>
<li>HostPath  VMware Photon  Portwirx Volumes  ScaleIO Volumes  StorageOS</li>
</ul>
<h5 id="pv演示代码"><a href="#pv演示代码" class="headerlink" title="pv演示代码"></a>pv演示代码</h5><figure class="highlight yml"><table><tr><td class="code"><pre><span class="line"><span class="comment"># nfs机制</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">PersistentVolume</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">pv0003</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">capacity:</span></span><br><span class="line">    <span class="attr">storage:</span> <span class="string">5Gi</span></span><br><span class="line">  <span class="attr">volumeMode:</span> <span class="string">Filesystem</span></span><br><span class="line">  <span class="attr">accessModes:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">ReadWriteOnce</span></span><br><span class="line">  <span class="attr">persistentVolumeReclaimPolicy:</span> <span class="string">Recycle</span></span><br><span class="line">  <span class="attr">storageClassName:</span> <span class="string">slow</span></span><br><span class="line">  <span class="attr">mountOptions:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">hard</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">nfsvers=4.1</span></span><br><span class="line">  <span class="attr">nfs:</span></span><br><span class="line">    <span class="attr">path:</span> <span class="string">/tmp</span></span><br><span class="line">    <span class="attr">server:</span> <span class="number">172.17</span><span class="number">.0</span><span class="number">.2</span></span><br></pre></td></tr></table></figure>
<h5 id="pv访问模式"><a href="#pv访问模式" class="headerlink" title="pv访问模式"></a>pv访问模式</h5><p>PersistentVolume可以以资源提供者支持的任何方式挂载到主机上，如下表所示，供应商具有不通的功能，每个pv的访问模式都将被设置为该卷支持的特定模式。例如，nfs可以支持多个读&#x2F;写客户端，但特定的NFS PV可能以只读方式导出到服务器上，每个pv都有一套自己的用来描述特定功能的访问模式</p>
<ul>
<li>ReadWriteOnce–该卷可被单个节点以读写模式挂载</li>
<li>ReadOnlyMany–该卷可被多个节点以只读模式挂载</li>
<li>ReadWriteMany–该卷可被多个节点以读写模式挂载<br>在命令行中，accessModes缩写：RWO ROX RWX<br><code>1个卷1次只能使用1种访问模式挂载，即使它支持很多访问模式，例如GCEPersistentDisk可以由单个节点作为RWO模式挂载，或由多个节点以ROX模式挂载，但不能同时挂载</code><br><img src="k8s_pv_accessmode.png"></li>
</ul>
<h5 id="回收策略"><a href="#回收策略" class="headerlink" title="回收策略"></a>回收策略</h5><ul>
<li>Retain（保留）– 手动回收（pv不再继续使用时也不允许被别人使用，进入保留状态，等待管理员手动释放）<br><del>- Recycle（回收）– 基本擦除(rm -rf &#x2F;thevolume&#x2F;*)已废弃</del></li>
<li>Delete（删除）– 关联的存储资产（例如AWS EVS、GCE PD、Azure Disk和OpenStack Cinder卷）将被删除<br>当前，只有NFS和HostPath支持回收策略。AWS EBS、GCE PD、Azure Disk和Cinder卷支持删除策略</li>
</ul>
<h5 id="状态"><a href="#状态" class="headerlink" title="状态"></a>状态</h5><p>卷可以处于一下某种状态：</p>
<ul>
<li>Available（可用）– 一块空闲资源还没有被任何声明绑定</li>
<li>Bound（已绑定）– 卷已经被声明绑定</li>
<li>Released（已释放）– 声明被删除，但是资源还未被集群重新声明</li>
<li>Failed（失败）– 该卷的自动回收失败<br>命令行会显示绑定到pv的pvc的名称</li>
</ul>
<h4 id="PersistentVolumeClaim（PVC）持久卷声明"><a href="#PersistentVolumeClaim（PVC）持久卷声明" class="headerlink" title="PersistentVolumeClaim（PVC）持久卷声明"></a>PersistentVolumeClaim（PVC）持久卷声明</h4><p>是用户存储的请求，与Pod相似<br>Pod消耗节点资源，pvc消耗pv资源<br>Pod可以请求特定级别的资源（CPU、Memory）<br>声明可以请求特定的大小和访问模式（例如可以以读&#x2F;写一次或只读多次模式挂载）</p>
<h5 id="绑定"><a href="#绑定" class="headerlink" title="绑定"></a>绑定</h5><p>master中的控制环路监视新的pvc，寻找匹配的pv（如果可能），并将他们绑定在一起，如果为新的pvc动态调配pv，则该环路将始终将该pv绑定到pvc。否则，用户总会得到他们所请求的存储，但是容量可能超出要求的数量，一旦pv和pvc绑定后，PersistentVolumeClaim绑定是排他性的，不管他们是如何绑定的，pvc跟pv绑定是一对一的映射</p>
<h5 id="pvc的保护"><a href="#pvc的保护" class="headerlink" title="pvc的保护"></a>pvc的保护</h5><p>pvc保护的目的是确保由pod正在使用的pvc不会从系统中移除，因为如果被移除的话，可能会导致数据丢失<br>注意：当pod状态为Pending且pod已经分配给节点 或 pod为Running状态时，pvc处于活动状态<br>当启用pvc保护alpha功能时，如果用户删除了一个pod正在使用的pvc，则该pvc不会被立即删除，pvc的删除将被推迟，直到ovc不再被任何pod使用</p>
<h5 id="持久化演示说明-NFS"><a href="#持久化演示说明-NFS" class="headerlink" title="持久化演示说明 - NFS"></a>持久化演示说明 - NFS</h5><p><img src="k8s_pvs_nfs.png"></p>
<ol>
<li>安装NFS服务器<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">yum install -y nfs-common nfs-utils recbind</span><br><span class="line"><span class="built_in">mkdir</span> /nfsdata</span><br><span class="line"><span class="built_in">chmod</span> 666 /nfsdata</span><br><span class="line"><span class="built_in">chown</span> nfsnobody /nfsdata</span><br><span class="line"><span class="built_in">cat</span> /etc/exports</span><br><span class="line">    /nfsdata *(rw,no_root_squash,no_all_squash,<span class="built_in">sync</span>)</span><br><span class="line">    /nfsdata1 *(rw,no_root_squash,no_all_squash,<span class="built_in">sync</span>)</span><br><span class="line">    /nfsdata2 *(rw,no_root_squash,no_all_squash,<span class="built_in">sync</span>)</span><br><span class="line">    /nfsdata3 *(rw,no_root_squash,no_all_squash,<span class="built_in">sync</span>)</span><br><span class="line">systemctl start rpcbind</span><br><span class="line">systemctl start nfs</span><br><span class="line"></span><br><span class="line"><span class="comment">## 测试nfs是否可用</span></span><br><span class="line"><span class="built_in">mkdir</span> /test</span><br><span class="line"><span class="comment"># 查看共享目录</span></span><br><span class="line">showmount -e 192.168.66.100</span><br><span class="line"><span class="comment"># 挂载</span></span><br><span class="line">mount -t nfs 192.168.66.100:/nfs /test/</span><br><span class="line"><span class="comment"># 解除挂载</span></span><br><span class="line">umount /test/</span><br></pre></td></tr></table></figure></li>
<li>部署PV<figure class="highlight yml"><table><tr><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">PersistentVolume</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">nfspv1</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">capacity:</span></span><br><span class="line">    <span class="attr">storage:</span> <span class="string">10Gi</span></span><br><span class="line">  <span class="attr">accessModes:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">ReadWriteOnce</span></span><br><span class="line">  <span class="attr">persistentVolumeReclaimPolicy:</span> <span class="string">Retain</span></span><br><span class="line">  <span class="attr">storageClassName:</span> <span class="string">nfs</span></span><br><span class="line">  <span class="attr">nfs:</span></span><br><span class="line">    <span class="attr">path:</span> <span class="string">/nfs</span></span><br><span class="line">    <span class="attr">server:</span> <span class="number">192.168</span><span class="number">.66</span><span class="number">.100</span></span><br></pre></td></tr></table></figure></li>
<li>创建服务并使用pvc<figure class="highlight yml"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 想创建sts，必须先创建无头svc，不需要对应的ip及端口</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">nginx</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">nginx</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">port:</span> <span class="number">80</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">web</span></span><br><span class="line">  <span class="attr">clusterIP:</span> <span class="string">None</span> <span class="comment"># 无头服务</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">nginx</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">StatefuleSet</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">web</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">nginx</span></span><br><span class="line">  <span class="attr">serviceName:</span> <span class="string">&quot;nginx&quot;</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">3</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">nginx</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">nginx</span></span><br><span class="line">        <span class="attr">image:</span> <span class="string">hub.jade.com/library/myapp:v2</span></span><br><span class="line">        <span class="attr">ports:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">80</span></span><br><span class="line">          <span class="attr">name:</span> <span class="string">web</span></span><br><span class="line">        <span class="attr">volumeMounts:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">www</span></span><br><span class="line">          <span class="attr">mountPath:</span> <span class="string">/usr/share/nginx/html</span></span><br><span class="line">  <span class="attr">volumeClaimTemplates:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">www</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">accessModes:</span> [ <span class="string">&quot;ReadWriteOnce&quot;</span> ]</span><br><span class="line">      <span class="attr">storageClassName:</span> <span class="string">&quot;nfs&quot;</span></span><br><span class="line">      <span class="attr">resources:</span></span><br><span class="line">        <span class="attr">requests:</span></span><br><span class="line">          <span class="attr">storage:</span> <span class="string">1Gi</span>  <span class="comment"># ≥此大小即可，优先选符合条件最小的</span></span><br></pre></td></tr></table></figure></li>
</ol>
<h5 id="关于sts"><a href="#关于sts" class="headerlink" title="关于sts"></a>关于sts</h5><ul>
<li>匹配Pod name（网络标识）的模式为：${sts名称}-${序号}，比如上面的示例web-0、web-1、web-2</li>
<li>sts为每个pod副本创建了一个dns域名，这个域名的格式为${podName}.${headless server name}，也就意味着服务间是通过pod域名来通信而非Pod IP，因为当Pod所在node发生故障时，pod会被飘移到其他node上，pod IP会发生变化，但是Pod域名不会有变化</li>
<li>sts使用Headless服务来控制Pod的域名，这个域名的FQDN为${servicename}.${ns}.svc.cluster.local，其中，cluster.local指的是集群的域名</li>
<li>根据volumeClaimTemplates，为每个Pod创建一个pvc，pvc的命名规则匹配模式：${volumeClaimTemplates.name}-${pod_name}，比如上面的volumeMounts.name&#x3D;www，Podname&#x3D;web-[0-2]，因此创建出来的PVC是www-web-0、www-web-1、www-web-2</li>
<li>删除pod不会删除其pvc，手动删除pvc将自动释放pv</li>
</ul>
<h5 id="sts的启停顺序"><a href="#sts的启停顺序" class="headerlink" title="sts的启停顺序"></a>sts的启停顺序</h5><ul>
<li>有序部署：部署sts时，如有多个pod副本，会被按顺序地创建（从0到N-1）并且，在下一个pod运行之前所有pod必须是running和ready状态</li>
<li>有序删除：当pod被删除时，它们被终止的顺序是从n-1到0</li>
<li>有序扩展：当对pod执行扩展时，与部署一样，前边pod必须是running和ready</li>
</ul>
<h5 id="sts使用场景"><a href="#sts使用场景" class="headerlink" title="sts使用场景"></a>sts使用场景</h5><ul>
<li>稳定的持久化存储，即Pod重新调度后还是能访问到相同的持久化数据，基于pvc来实现</li>
<li>稳定的网络标识符，即pod重新调度后其PodName和HostName不变</li>
<li>有序部署，有序扩展，基于init containers来实现</li>
<li>有序收缩</li>
</ul>

      
    </div>
    <footer class="article-footer">
      
        <blockquote class="article-copyright">
    <p><strong><span class="icon-user icon"></span>著者: </strong>本堂主 @ 本堂主Blog</p>
    <p><strong><span class="icon-link icon"></span>パーマリンク: </strong><a href="https://jade-xyy.github.io/ja/2025/04/09/K8s%E5%A4%87%E5%BF%98-%E4%B8%8A/">https://jade-xyy.github.io/ja/2025/04/09/K8s%E5%A4%87%E5%BF%98-%E4%B8%8A/</a></p>
    <p><strong><span class="icon-pencil icon"></span>タイトル: </strong>「K8s备忘 - 上」</p>
    
    
    <p><strong><span class="icon-copyright icon"></span>ライセンス: </strong>本ブログのすべての文書は、特に指定されていない限り、<a href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh" rel="noopener external nofollow noreferrer" target="_blank"><span class="icon-creative-commons"></span>BY-NC-SA</a> ライセンスに従っています。引用の際は出典を明記してください！</p>
    <span class="icon-creative-commons article-copyright-bg"></span>
  </blockquote>
      
      
      
        <div class="share-wrapper">
  
    <a href="http://connect.qq.com/widget/shareqq/index.html?url=https%3A%2F%2Fjade-xyy.github.io%2F2025%2F04%2F09%2FK8s%25E5%25A4%2587%25E5%25BF%2598-%25E4%25B8%258A%2F&amp;title=K8s%E5%A4%87%E5%BF%98%20-%20%E4%B8%8A&amp;desc=K8s%E5%A4%87%E5%BF%98%20-%20%E4%B8%8A&amp;source=https%3A%2F%2Fjade-xyy.github.io" target="_blank" rel="noopener noreferrer" title="K8s备忘 - 上">
      <div class="share-icon icon icon-qq">
        
      </div>
    </a>
  
    <a href="javascript:;"  title="K8s备忘 - 上">
      <div class="share-icon icon icon-weixin">
        
          <div id="share-weixin">
            <div class="share-weixin-dom">
              <div class="share-weixin-content">
                <img id="share-weixin-banner"> 
                <div id="share-weixin-title"></div>
                <div id="share-weixin-desc"></div>
              </div>
              <div class="share-weixin-qrcode">
                <div class="share-weixin-info">
                  <div id="share-weixin-author"></div>
                  <div id="share-weixin-theme">Powered By hexo-theme-reimu</div>
                </div>
                <img id="share-weixin-qr" >
              </div>
            </div>
            <div class="share-weixin-canvas"></div>
          </div>
        
      </div>
    </a>
  
</div>
      
      
        <a data-aos="zoom-in" href="/ja/2025/04/09/K8s%E5%A4%87%E5%BF%98-%E4%B8%8A/#comments" class="article-comment-link">
          <span class="post-comments-count valine-comment-count" data-xid="/ja/2025/04/09/K8s%E5%A4%87%E5%BF%98-%E4%B8%8A/" itemprop="commentCount"></span>
          コメント
        </a>
      
      
      
      
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item" data-aos="zoom-in"><a class="article-tag-list-link" href="/ja/tags/k8s/" rel="tag">k8s</a></li></ul>


    </footer>
  </div>
  
  <nav id="article-nav" data-aos="fade-up">
    
      
      <div class="article-nav-link-wrap article-nav-link-left">
        
          
          
            <img data-src="/covers/bangboo1.jpg" data-sizes="auto" alt="k8s备忘 - 下" class="lazyload">
          
        
        <a href="/ja/2025/04/11/k8s%E5%A4%87%E5%BF%98-%E4%B8%8B/"></a>
        <div class="article-nav-caption">次の記事</div>
        <h3 class="article-nav-title">
          
            k8s备忘 - 下
          
        </h3>
      </div>
    
    
    
    <div class="article-nav-link-wrap article-nav-link-right">
      
        
        
          <img data-src="https://d-sketon.top/img/backimg/bg18.jpg" data-sizes="auto" alt="ansible备忘" class="lazyload">
        
      
      <a href="/ja/2025/04/09/ansible%E5%A4%87%E5%BF%98/"></a>
      <div class="article-nav-caption">前の記事</div>
      <h3 class="article-nav-title">
        
          ansible备忘
        
      </h3>
    </div>
    
  </nav>


</article>









  <section id="comments" data-aos="fade-up">
    <div class="comment-header">
      <h2 class="comment-title">说些什么吧！</h2>
      <div class="comment-selector">
        <div class="comment-selector-wrap">
            
            <div class="selector-item" data-selector="valine">
              <span>valine</span>
            </div>
            
        </div>
      </div>
    </div>
    <div class="comment-content">
      
        <div class="comment valine-comment" data-aos="fade-up"
          id="valine-comment">
        </div>
      
    </div>
  </section>


</section>
        </div>
        
        
        <footer id="footer">
  <div style="width: 100%; overflow: hidden">
    <div class="footer-line"></div>
  </div>
  <div id="footer-info">
    
    <div>
      <span class="icon-copyright"></span>
      
      
      
        2025
      
      <span class="footer-info-sep rotate"></span>
      本堂主
    </div>
    
      <div>
        Powered by&nbsp;<a href="https://hexo.io/" rel="noopener external nofollow noreferrer" target="_blank">Hexo</a>&nbsp;
        Theme.<a href="https://github.com/D-Sketon/hexo-theme-reimu" rel="noopener external nofollow noreferrer" target="_blank">Reimu</a>
      </div>
    
    
      <div>
        <span class="icon-brush"></span>
        57.9k
        &nbsp;|&nbsp;
        <span class="icon-coffee"></span>
        03:58
      </div>
    
    
    
    
      <div>
        <span class="icon-eye"></span>
        <span id="busuanzi_container_site_pv">総閲覧数&nbsp;<span id="busuanzi_value_site_pv"></span></span>
        &nbsp;|&nbsp;
        <span class="icon-user"></span>
        <span id="busuanzi_container_site_uv">総閲覧者数&nbsp;<span id="busuanzi_value_site_uv"></span></span>
      </div>
    
  </div>
</footer>

        
          <div class="sidebar-top">
            <div class="sidebar-top-taichi rotate"></div>
            <div class="arrow-up"></div>
          </div>
        
        <div id="mask" class="hide"></div>
      </div>
      <nav id="mobile-nav">
  <div class="sidebar-wrap">
    
      
        <div class="sidebar-toc-sidebar"><div class="sidebar-toc">
  <h3 class="toc-title">見出し</h3>
  <div class="sidebar-toc-wrapper toc-div-class" >
      
        <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#K8s%E5%A4%87%E5%BF%98"><span class="toc-number">1.</span> <span class="toc-text">K8s备忘</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#k8s%E5%B8%B8%E7%94%A8%E5%91%BD%E4%BB%A4"><span class="toc-number">1.1.</span> <span class="toc-text">k8s常用命令</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E2%80%A6-%E2%80%A6-%E2%80%A6-kubectl-%E2%80%A6-%E2%80%A6-%E2%80%A6-%E2%88%9E"><span class="toc-number">1.1.0.1.</span> <span class="toc-text">… … … kubectl … … … ∞</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E2%80%A6-%E2%80%A6-%E2%80%A6-deployment-%E2%80%A6-%E2%80%A6-%E2%80%A6-%E2%88%9E"><span class="toc-number">1.1.0.2.</span> <span class="toc-text">… … … deployment … … … ∞</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E2%80%A6-%E2%80%A6-%E2%80%A6-ipvs-%E2%80%A6-%E2%80%A6-%E2%80%A6-%E2%88%9E"><span class="toc-number">1.1.0.3.</span> <span class="toc-text">… … … ipvs … … … ∞</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E2%80%A6-%E2%80%A6-%E2%80%A6-docker-%E2%80%A6-%E2%80%A6-%E2%80%A6-%E2%88%9E"><span class="toc-number">1.1.0.4.</span> <span class="toc-text">… … … docker … … … ∞</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#K8s%E7%BB%84%E4%BB%B6"><span class="toc-number">1.2.</span> <span class="toc-text">K8s组件</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#Master%E7%9A%84%E7%BB%84%E4%BB%B6"><span class="toc-number">1.2.0.1.</span> <span class="toc-text">Master的组件</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Node%E7%9A%84%E7%BB%84%E4%BB%B6"><span class="toc-number">1.2.0.2.</span> <span class="toc-text">Node的组件</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%85%B6%E4%BB%96%E6%8F%92%E4%BB%B6"><span class="toc-number">1.2.0.3.</span> <span class="toc-text">其他插件</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Pod"><span class="toc-number">1.3.</span> <span class="toc-text">Pod</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%88%86%E7%B1%BB"><span class="toc-number">1.3.0.1.</span> <span class="toc-text">分类</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%B5%84%E6%BA%90%E6%B8%85%E5%8D%95"><span class="toc-number">1.4.</span> <span class="toc-text">资源清单</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%B5%84%E6%BA%90"><span class="toc-number">1.4.0.1.</span> <span class="toc-text">资源</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%9B%86%E7%BE%A4%E8%B5%84%E6%BA%90%E5%88%86%E7%B1%BB"><span class="toc-number">1.4.0.2.</span> <span class="toc-text">集群资源分类</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%B5%84%E6%BA%90%E6%B8%85%E5%8D%95YAML"><span class="toc-number">1.4.0.3.</span> <span class="toc-text">资源清单YAML</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%AE%B9%E5%99%A8%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F"><span class="toc-number">1.4.0.4.</span> <span class="toc-text">容器生命周期</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#Init%E5%AE%B9%E5%99%A8%E4%B8%8E%E6%99%AE%E9%80%9A%E5%AE%B9%E5%99%A8%E9%9D%9E%E5%B8%B8%E5%83%8F%EF%BC%8C%E9%99%A4%E4%BA%86%E5%A6%82%E4%B8%8B%E4%B8%A4%E7%82%B9"><span class="toc-number">1.4.0.4.1.</span> <span class="toc-text">Init容器与普通容器非常像，除了如下两点</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#Init%E5%AE%B9%E5%99%A8%E5%90%AF%E5%8A%A8%E7%9B%B8%E5%85%B3%E4%BB%A3%E7%A0%81%E4%BC%98%E5%8A%BF%EF%BC%9A%EF%BC%88%E5%9B%A0%E4%B8%BAInit%E5%AE%B9%E5%99%A8%E5%85%B7%E6%9C%89%E4%B8%8E%E5%BA%94%E7%94%A8%E7%A8%8B%E5%BA%8F%E5%AE%B9%E5%99%A8%E5%88%86%E7%A6%BB%E7%9A%84%E5%8D%95%E7%8B%AC%E9%95%9C%E5%83%8F%EF%BC%8C%E6%89%80%E4%BB%A5%E6%9C%89%E5%A6%82%E4%B8%8B%E4%BC%98%E5%8A%BF%EF%BC%89"><span class="toc-number">1.4.0.4.2.</span> <span class="toc-text">Init容器启动相关代码优势：（因为Init容器具有与应用程序容器分离的单独镜像，所以有如下优势）</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#Init%E5%AE%B9%E5%99%A8%E7%9A%84%E7%89%B9%E6%AE%8A%E8%AF%B4%E6%98%8E"><span class="toc-number">1.4.0.4.3.</span> <span class="toc-text">Init容器的特殊说明</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#Pod-phase%EF%BC%88%E7%9B%B8%E4%BD%8D%EF%BC%89-%E5%8F%AF%E8%83%BD%E5%AD%98%E5%9C%A8%E7%9A%84%E5%80%BC"><span class="toc-number">1.4.0.4.4.</span> <span class="toc-text">Pod phase（相位） 可能存在的值</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%8E%A2%E9%92%88"><span class="toc-number">1.4.0.5.</span> <span class="toc-text">探针</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%8E%A2%E9%92%88%E6%98%AF%E7%94%B1kubelet%E5%AF%B9%E5%AE%B9%E5%99%A8%E6%89%A7%E8%A1%8C%E7%9A%84%E5%AE%9A%E6%9C%9F%E8%AF%8A%E6%96%AD"><span class="toc-number">1.4.0.5.1.</span> <span class="toc-text">探针是由kubelet对容器执行的定期诊断</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%8E%A2%E6%B5%8B%E7%BB%93%E6%9E%9C%EF%BC%9A%E6%AF%8F%E6%AC%A1%E6%8E%A2%E6%B5%8B%E9%83%BD%E5%B0%86%E8%8E%B7%E5%BE%97%E4%BB%A5%E4%B8%8B%E4%B8%89%E7%A7%8D%E7%BB%93%E6%9E%9C%E4%B9%8B%E4%B8%80%EF%BC%9A"><span class="toc-number">1.4.0.5.2.</span> <span class="toc-text">探测结果：每次探测都将获得以下三种结果之一：</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%8E%A2%E6%B5%8B%E6%96%B9%E5%BC%8F%EF%BC%9A"><span class="toc-number">1.4.0.5.3.</span> <span class="toc-text">探测方式：</span></a></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Pod%E6%8E%A7%E5%88%B6%E5%99%A8%EF%BC%88controller%EF%BC%8C%E7%9B%B8%E5%BD%93%E4%BA%8E%E4%B8%80%E4%B8%AA%E7%8A%B6%E6%80%81%E6%9C%BA%E7%94%A8%E6%9D%A5%E6%8E%A7%E5%88%B6Pod%E7%9A%84%E5%85%B7%E4%BD%93%E7%8A%B6%E6%80%81%E5%92%8C%E8%A1%8C%E4%B8%BA%EF%BC%89"><span class="toc-number">1.5.</span> <span class="toc-text">Pod控制器（controller，相当于一个状态机用来控制Pod的具体状态和行为）</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#ReplicationController"><span class="toc-number">1.5.0.1.</span> <span class="toc-text">ReplicationController</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#ReplicaSet"><span class="toc-number">1.5.0.2.</span> <span class="toc-text">ReplicaSet</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Deployment"><span class="toc-number">1.5.0.3.</span> <span class="toc-text">Deployment</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Horizontal-Pod-Autoscaling"><span class="toc-number">1.5.0.4.</span> <span class="toc-text">Horizontal Pod Autoscaling</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#DaemonSet"><span class="toc-number">1.5.0.5.</span> <span class="toc-text">DaemonSet</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#StatefulSet"><span class="toc-number">1.5.0.6.</span> <span class="toc-text">StatefulSet</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Job"><span class="toc-number">1.5.0.7.</span> <span class="toc-text">Job</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#CronJob"><span class="toc-number">1.5.0.8.</span> <span class="toc-text">CronJob</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%BD%91%E7%BB%9C"><span class="toc-number">1.6.</span> <span class="toc-text">网络</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#Service"><span class="toc-number">1.6.0.1.</span> <span class="toc-text">Service</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%A6%82%E5%BF%B5%EF%BC%9A"><span class="toc-number">1.6.0.1.1.</span> <span class="toc-text">概念：</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#svc%E7%B1%BB%E5%9E%8B"><span class="toc-number">1.6.0.1.2.</span> <span class="toc-text">svc类型</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#VIP%E5%92%8CSVC%E4%BB%A3%E7%90%86"><span class="toc-number">1.6.0.1.3.</span> <span class="toc-text">VIP和SVC代理</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E4%BB%A3%E7%90%86%E6%A8%A1%E5%BC%8F%E5%88%86%E7%B1%BB"><span class="toc-number">1.6.0.1.4.</span> <span class="toc-text">代理模式分类</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#svc%E6%89%80%E9%9C%80%E7%BB%84%E4%BB%B6"><span class="toc-number">1.6.0.1.5.</span> <span class="toc-text">svc所需组件</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Ingress"><span class="toc-number">1.6.0.2.</span> <span class="toc-text">Ingress</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#nginx%E5%86%85%E9%83%A8%E5%8D%8F%E7%A8%8B%E6%B2%9F%E9%80%9A%E6%96%B9%E6%A1%88"><span class="toc-number">1.6.0.2.1.</span> <span class="toc-text">nginx内部协程沟通方案</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%BD%91%E7%BB%9C%E9%80%9A%E8%AE%AF%E6%A8%A1%E5%BC%8F"><span class="toc-number">1.6.0.3.</span> <span class="toc-text">网络通讯模式</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%AE%9A%E4%B9%89"><span class="toc-number">1.6.0.3.1.</span> <span class="toc-text">定义</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#Flannel"><span class="toc-number">1.6.0.3.2.</span> <span class="toc-text">Flannel</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E9%80%9A%E8%AE%AF%E6%96%B9%E5%BC%8F"><span class="toc-number">1.6.0.3.3.</span> <span class="toc-text">通讯方式</span></a></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AD%98%E5%82%A8"><span class="toc-number">1.7.</span> <span class="toc-text">存储</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#configmap%EF%BC%88%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6%E6%B3%A8%E5%86%8C%E4%B8%AD%E5%BF%83%EF%BC%89"><span class="toc-number">1.7.0.1.</span> <span class="toc-text">configmap（配置文件注册中心）</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%8F%8F%E8%BF%B0%E4%BF%A1%E6%81%AF"><span class="toc-number">1.7.0.1.1.</span> <span class="toc-text">描述信息</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%88%9B%E5%BB%BA"><span class="toc-number">1.7.0.1.2.</span> <span class="toc-text">创建</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#Pod%E4%B8%AD%E4%BD%BF%E7%94%A8ConfigMap"><span class="toc-number">1.7.0.1.3.</span> <span class="toc-text">Pod中使用ConfigMap</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Secret"><span class="toc-number">1.7.0.2.</span> <span class="toc-text">Secret</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%8F%8F%E8%BF%B0%E4%BF%A1%E6%81%AF-1"><span class="toc-number">1.7.0.2.1.</span> <span class="toc-text">描述信息</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%88%86%E7%B1%BB-1"><span class="toc-number">1.7.0.2.2.</span> <span class="toc-text">分类</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Volume"><span class="toc-number">1.7.0.3.</span> <span class="toc-text">Volume</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%A6%82%E5%BF%B5"><span class="toc-number">1.7.0.3.1.</span> <span class="toc-text">概念</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E8%83%8C%E6%99%AF"><span class="toc-number">1.7.0.3.2.</span> <span class="toc-text">背景</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%8D%B7%E7%9A%84%E7%B1%BB%E5%9E%8B"><span class="toc-number">1.7.0.3.3.</span> <span class="toc-text">卷的类型</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Persistent-Volume%EF%BC%88PV%EF%BC%89%E6%8C%81%E4%B9%85%E5%8D%B7"><span class="toc-number">1.7.0.4.</span> <span class="toc-text">Persistent Volume（PV）持久卷</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E9%9D%99%E6%80%81pv"><span class="toc-number">1.7.0.4.1.</span> <span class="toc-text">静态pv</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%8A%A8%E6%80%81"><span class="toc-number">1.7.0.4.2.</span> <span class="toc-text">动态</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E7%B1%BB%E5%9E%8B"><span class="toc-number">1.7.0.4.3.</span> <span class="toc-text">类型</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#pv%E6%BC%94%E7%A4%BA%E4%BB%A3%E7%A0%81"><span class="toc-number">1.7.0.4.4.</span> <span class="toc-text">pv演示代码</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#pv%E8%AE%BF%E9%97%AE%E6%A8%A1%E5%BC%8F"><span class="toc-number">1.7.0.4.5.</span> <span class="toc-text">pv访问模式</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%9B%9E%E6%94%B6%E7%AD%96%E7%95%A5"><span class="toc-number">1.7.0.4.6.</span> <span class="toc-text">回收策略</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E7%8A%B6%E6%80%81"><span class="toc-number">1.7.0.4.7.</span> <span class="toc-text">状态</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#PersistentVolumeClaim%EF%BC%88PVC%EF%BC%89%E6%8C%81%E4%B9%85%E5%8D%B7%E5%A3%B0%E6%98%8E"><span class="toc-number">1.7.0.5.</span> <span class="toc-text">PersistentVolumeClaim（PVC）持久卷声明</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E7%BB%91%E5%AE%9A"><span class="toc-number">1.7.0.5.1.</span> <span class="toc-text">绑定</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#pvc%E7%9A%84%E4%BF%9D%E6%8A%A4"><span class="toc-number">1.7.0.5.2.</span> <span class="toc-text">pvc的保护</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%8C%81%E4%B9%85%E5%8C%96%E6%BC%94%E7%A4%BA%E8%AF%B4%E6%98%8E-NFS"><span class="toc-number">1.7.0.5.3.</span> <span class="toc-text">持久化演示说明 - NFS</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%85%B3%E4%BA%8Ests"><span class="toc-number">1.7.0.5.4.</span> <span class="toc-text">关于sts</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#sts%E7%9A%84%E5%90%AF%E5%81%9C%E9%A1%BA%E5%BA%8F"><span class="toc-number">1.7.0.5.5.</span> <span class="toc-text">sts的启停顺序</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#sts%E4%BD%BF%E7%94%A8%E5%9C%BA%E6%99%AF"><span class="toc-number">1.7.0.5.6.</span> <span class="toc-text">sts使用场景</span></a></li></ol></li></ol></li></ol></li></ol></li></ol>
      
  </div>
</div>
</div>
        <div class="sidebar-common-sidebar hidden"><div class="sidebar-author">
  <img data-src="/avatar/Omen.jpg" data-sizes="auto" alt="本堂主" class="lazyload">
  <div class="sidebar-author-name">本堂主</div>
  <div class="sidebar-description"></div>
</div>
<div class="sidebar-state">
  <div class="sidebar-state-article">
    <div>投稿</div>
    <div class="sidebar-state-number">13</div>
  </div>
  <div class="sidebar-state-category">
    <div>カテゴリー</div>
    <div class="sidebar-state-number">5</div>
  </div>
  <div class="sidebar-state-tag">
    <div>タグ</div>
    <div class="sidebar-state-number">9</div>
  </div>
</div>
<div class="sidebar-social">
  
</div>
<div class="sidebar-menu">
  
    
      <div class="sidebar-menu-link-wrap">
        <a class="sidebar-menu-link-dummy" href="/ja/" aria-label="ホーム"></a>
        <div class="sidebar-menu-icon icon rotate">
          &#xe62b;
        </div>
        <div class="sidebar-menu-link">ホーム</div>
      </div>
    
      <div class="sidebar-menu-link-wrap">
        <a class="sidebar-menu-link-dummy" href="/ja/archives" aria-label="アーカイブ"></a>
        <div class="sidebar-menu-icon icon rotate">
          &#xe62b;
        </div>
        <div class="sidebar-menu-link">アーカイブ</div>
      </div>
    
      <div class="sidebar-menu-link-wrap">
        <a class="sidebar-menu-link-dummy" href="/ja/about" aria-label="プロフィール"></a>
        <div class="sidebar-menu-icon icon rotate">
          &#xe62b;
        </div>
        <div class="sidebar-menu-link">プロフィール</div>
      </div>
    
      <div class="sidebar-menu-link-wrap">
        <a class="sidebar-menu-link-dummy" href="/ja/friend" aria-label="フレンド"></a>
        <div class="sidebar-menu-icon icon rotate">
          &#xe62b;
        </div>
        <div class="sidebar-menu-link">フレンド</div>
      </div>
    
  
</div>
</div>
      
    
  </div>
  
    
      <div class="sidebar-btn-wrapper">
        <div class="sidebar-toc-btn current"></div>
        <div class="sidebar-common-btn"></div>
      </div>
    
  
</nav>

    </div>
    
      <div class="site-search">
        <div class="reimu-popup popup">
          <div class="reimu-search">
            <div class="reimu-search-input-icon"></div>
            <div class="reimu-search-input" id="reimu-search-input"></div>
            <div class="popup-btn-close"></div>
          </div>
          <div class="reimu-results">
            <div id="reimu-stats"></div>
            <div id="reimu-hits"></div>
            <div id="reimu-pagination" class="reimu-pagination"></div>
          </div>
          <img class="reimu-bg" src="/images/reimu.png"/>
        </div>
      </div>
    
    
<script src="https://npm.webcache.cn/lazysizes@5.3.2/lazysizes.min.js" integrity="sha384-3gT&#x2F;vsepWkfz&#x2F;ff7PpWNUeMzeWoH3cDhm&#x2F;A8jM7ouoAK0&#x2F;fP&#x2F;9bcHHR5kHq2nf+e" crossorigin="anonymous"></script>


<script src="https://npm.webcache.cn/clipboard@2.0.11/dist/clipboard.min.js" integrity="sha384-J08i8An&#x2F;QeARD9ExYpvphB8BsyOj3Gh2TSh1aLINKO3L0cMSH2dN3E22zFoXEi0Q" crossorigin="anonymous"></script>





<script src="/js/script.js"></script>



  
<script src="/js/aos.js"></script>

  <script>
    var aosInit = () => {
      AOS.init({
        duration: 1000,
        easing: "ease",
        once: true,
        offset: 50,
      });
    };
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', aosInit);
    } else {
      aosInit();
    }
  </script>



<script src="/js/pjax_script.js" data-pjax></script>



  
<script src="/js/generator_search.js" defer></script>






  
<script src="https://npm.webcache.cn/mouse-firework@0.1.1/dist/index.umd.js" integrity="sha384-8LyaidD9GPxQQgLJO&#x2F;WRw&#x2F;O2h3BoNq&#x2F;ApI&#x2F;ecpvM6RsrCz2qP2ppBXUKihP4V&#x2F;2d" crossorigin="anonymous"></script>

  <script>
    window.firework && window.firework(JSON.parse('{"excludeElements":["a","button"],"particles":[{"shape":"circle","move":["emit"],"easing":"easeOutExpo","colors":["var(--red-1)","var(--red-2)","var(--red-3)","var(--red-4)"],"number":20,"duration":[1200,1800],"shapeOptions":{"radius":[16,32],"alpha":[0.3,0.5]}},{"shape":"circle","move":["diffuse"],"easing":"easeOutExpo","colors":["var(--red-0)"],"number":1,"duration":[1200,1800],"shapeOptions":{"radius":20,"alpha":[0.2,0.5],"lineWidth":6}}]}'))
  </script>









  
<script src="https://npm.webcache.cn/quicklink@2.3.0/dist/quicklink.umd.js" integrity="sha384-aD7FsuQkS1ohgFKY41fJfeA+Wd&#x2F;QRNnrOd9Bs58K3FzKdJJv8yPnYU8Tnp5z1agS" crossorigin="anonymous"></script>

  <script data-pjax>
    window.quicklink?.listen({
      timeout: 3000,
      priority: true,
      ignores: []
    });
  </script>


<div id="lazy-script">
  <div>
    
      
      
      <script data-pjax>
        window.REIMU_POST = {
          author: "本堂主",
          title: "K8s备忘 - 上",
          url: "https://jade-xyy.github.io/2025/04/09/K8s%E5%A4%87%E5%BF%98-%E4%B8%8A/",
          excerpt: "",
          description: "",
          stripContent: "K8s备忘k8s常用命令… … … kubectl … … … ∞#查看命名空间nsA下pod1的日志最近100行kubectl logs -f pod1 -n nsA --tail=100#查日志kubectl logs --tail=1000 $&amp;#123;podname&amp;#125; -n cloudpath &amp;gt; $&amp;#123;podname&amp;#125;.log#查看服务配置信息kubectl -n kubernetes-dashboard get service kubernetes",
          date: "Wed Apr 09 2025 17:05:17 GMT+0800",
          updated: "Mon Apr 14 2025 14:43:42 GMT+0800",
          cover: "/images/banner.webp",
        };
      </script>
       
    
    
      
        
<script src="/js/insert_highlight.js" data-pjax></script>

        
          
<script src="https://npm.webcache.cn/html-to-image@1.11.11/dist/html-to-image.js" integrity="sha384-UbfRVKN3&#x2F;elS1r7JcK2FhmPP+KlJ4CvYwbyYD7tH+uTkbT9bNJr9eJeQ0FoFbAgz" crossorigin="anonymous" defer data-pjax></script>

          
<script src="https://npm.webcache.cn/qrcode@1.4.4/build/qrcode.min.js" integrity="sha384-0RsG1yo&#x2F;crf&#x2F;1Qc14sho26SXXOTngNCjgJw7fuvXBt9W&#x2F;OChF&#x2F;Ijx+aUuBDqQwEk" crossorigin="anonymous" defer data-pjax></script>

        
      
    
    
      <script type="module" data-pjax>
        const PhotoSwipeLightbox = (await safeImport("https://npm.webcache.cn/photoswipe@5.4.4/dist/photoswipe-lightbox.esm.min.js", "sha384-DiL6M/gG+wmTxmCRZyD1zee6lIhawn5TGvED0FOh7fXcN9B0aZ9dexSF/N6lrZi/")).default;
        
        const pswp = () => {
          if (_$$('.article-entry a.article-gallery-item').length > 0) {
            new PhotoSwipeLightbox({
              gallery: '.article-entry',
              children: 'a.article-gallery-item',
              pswpModule: () => safeImport("https://npm.webcache.cn/photoswipe@5.4.4/dist/photoswipe.esm.min.js", "sha384-WkkO3GCmgkC3VQWpaV8DqhKJqpzpF9JoByxDmnV8+oTJ7m3DfYEWX1fu1scuS4+s")
            }).init();
          }
          if(_$$('.article-gallery a.article-gallery-item').length > 0) {
            new PhotoSwipeLightbox({
              gallery: '.article-gallery',
              children: 'a.article-gallery-item',
              pswpModule: () => safeImport("https://npm.webcache.cn/photoswipe@5.4.4/dist/photoswipe.esm.min.js", "sha384-WkkO3GCmgkC3VQWpaV8DqhKJqpzpF9JoByxDmnV8+oTJ7m3DfYEWX1fu1scuS4+s")
            }).init();
          }
          window.lightboxStatus = 'done';
          window.removeEventListener('lightbox:ready', pswp);
        }
        if(window.lightboxStatus === 'ready') {
          pswp()
        } else {
          window.addEventListener('lightbox:ready', pswp);
        }
      </script>
      








<script data-pjax>
  var loadScript = (src, integrity) => {
    const script = document.createElement('script');
    script.src = src;
    if (integrity) script.integrity = integrity;
    script.crossOrigin = 'anonymous';
    return script;
  };

  var commentConfigKeys = ['valine', 'waline', 'twikoo', 'gitalk', 'giscus'];
  var commentConfig = {
    valine: {
      enable: true,
      load: () => {
        const container = document.querySelector('.valine-comment');
        if (!container) return;
        container.style.display = 'block';

        const script = loadScript(
          'https://npm.webcache.cn/valine@1.5.1/dist/Valine.min.js',
          'sha384-3ma91AExDeMAZ1rjTjaP8V2A2obQE+s5ltKRwYlwdpArz9xVbp0tF3b0VV2ACNPn'
        );
        script.onload = () => {
          var GUEST_INFO = ['nick', 'mail', 'link'];
          var guest_info = 'nick,mail,link'.split(',').filter((item) => {
            return GUEST_INFO.indexOf(item) > -1
          });
          var recordIP = JSON.parse('true');
          var highlight = JSON.parse('true');
          var visitor = JSON.parse('false');

          if (window.Valine) {
            new Valine({
              el: '.valine-comment',
              appId: "e8feHL9uKMe2cBgp29tyFCdv-gzGzoHsz",
              appKey: "Z289QNdRm4m1Im6mWjAWqW4P",
              placeholder: "Just go go",
              pageSize: '10',
              avatar: 'mp',
              lang: 'zh-cn',
              recordIP: recordIP,
              highlight: highlight,
              visitor: visitor,
              requiredFields: guest_info,
              path: window.location.pathname
            });
          }
        };
        document.head.appendChild(script);
      }
    },
    waline: {
      enable: false,
      load: async () => {
        const container = document.querySelector('.waline-comment');
        if (!container) return;
        container.style.display = 'block';

        let walineInit;
        const walineCdn = 'https://npm.webcache.cn/@waline/client@2.15.8/dist/waline.mjs';
        const walineIntegrity = 'sha384-9sbqJjrfGjbkI6/PI4nU/MvBfEmkkPC4YK9I4zBeMIf1CVCZdCMH/KinBEAZII/5';

        const module = await safeImport(walineCdn, walineIntegrity);
        walineInit = module.init;

        window.walineInstance = walineInit({
          el: '.waline-comment',
          serverURL: '',
          lang: 'zh-CN',
          locale: {},
          emoji: ["https://unpkg.com/@waline/emojis@1.2.0/weibo","https://unpkg.com/@waline/emojis@1.2.0/alus","https://unpkg.com/@waline/emojis@1.2.0/bilibili","https://unpkg.com/@waline/emojis@1.2.0/qq","https://unpkg.com/@waline/emojis@1.2.0/tieba","https://unpkg.com/@waline/emojis@1.2.0/tw-emoji"],
          meta: ["nick","mail","link"],
          requiredMeta: ["nick","mail"],
          wordLimit: JSON.parse('0'),
          comment: true,
          pageSize: JSON.parse('10'),
          dark: 'html[data-theme="dark"]',
          pageview: JSON.parse('true'),
        });
      }
    },
    twikoo: {
      enable: false,
      load: () => {
        const container = document.querySelector('.twikoo-comment');
        if (!container) return;
        container.style.display = 'block';

        const script = loadScript(
          'https://npm.webcache.cn/twikoo@1.6.16/dist/twikoo.all.min.js',
          'sha384-lDHsr5aZmkMS0eKnsUu6e9RWP+dRmn7sgjRAKGOAoXfMyzbUK6Qi86zZK7R+KvRV'
        );

        script.onload = () => {
          if (window.twikoo) {
            twikoo.init({
              envId: '',
              el: '.tcomment',
              region: '',
            })
          }
        } 
        document.head.appendChild(script);
      }
    },
    gitalk: {
      enable: false,
      load: () => {
        const container = document.querySelector('.gitalk-comment');
        if (!container) return;
        container.style.display = 'block';

        const script = loadScript(
          'https://npm.webcache.cn/gitalk@1.8.0/dist/gitalk.min.js',
          'sha384-kspnZUWBoSWwoJHa0hBCXYbHGbhvU/lcEH5O8eVbSDhbPwsiVUTp/aGX/z/5EuMA'
        );

        script.onload = () => {
          if (false) {
            const md5Script = loadScript(
              'https://npm.webcache.cn/blueimp-md5@2.19.0/js/md5.min.js',
              'sha384-JmVtRz6RWiXnA14QbIOJzPuU3MidULOpBP66deeLLyyoF4Tr/gZlbkHkL6vTthxH'
            );
            md5Script.onload = initGitalk;
            document.head.appendChild(md5Script);
          } else {
            initGitalk();
          }
        }
        document.head.appendChild(script);

        function initGitalk() {
          var gitalkId = location.pathname;
          var gitalk = new Gitalk({
            clientID: '',
            clientSecret: '',
            repo: '',
            owner: '',
            admin: null,
            id: gitalkId, // Ensure uniqueness and length less than 50
            distractionFreeMode: false // Facebook-like distraction free mode
          })
          gitalk.render('gitalk-comment');
        }
      }
    },
    giscus: {
      enable: false,
      load: () => {
        const container = document.querySelector('.giscus-comment');
        if (!container) return;
        container.style.display = 'block';

        // 删除可能已存在的 giscus 脚本和 iframe
        const existingScript = container.querySelector('script[src*="giscus.app/client.js"]');
        if (existingScript) existingScript.remove();
        const existingFrame = document.querySelector('iframe.giscus-frame');
        if (existingFrame) existingFrame.remove();

        const giscusScript = document.createElement('script');
        const domMode = document.documentElement.getAttribute("data-theme");
        giscusScript.src = 'https://giscus.app/client.js';
        giscusScript.setAttribute('data-repo', '');
        giscusScript.setAttribute('data-repo-id', '');
        giscusScript.setAttribute('data-category', ''); 
        giscusScript.setAttribute('data-category-id', '');
        giscusScript.setAttribute('data-mapping', '0');
        giscusScript.setAttribute('data-strict', '0');
        giscusScript.setAttribute('data-reactions-enabled', '1');
        giscusScript.setAttribute('data-emit-metadata', '0');
        giscusScript.setAttribute('data-input-position', 'bottom');
        giscusScript.setAttribute('data-theme', domMode === 'dark' ? 'dark' : 'light');
        giscusScript.setAttribute('data-lang', 'zh-CN');
        giscusScript.setAttribute('crossorigin', 'anonymous');
        giscusScript.async = true;
        container.appendChild(giscusScript);
        document.body.addEventListener('light-theme-set', () => {
          const iframe = document.querySelector('iframe.giscus-frame');
          if (!iframe) return;
          iframe.contentWindow.postMessage({ giscus: { setConfig: { theme: 'light' } } }, 'https://giscus.app');
        });
        document.body.addEventListener('dark-theme-set', () => {
          const iframe = document.querySelector('iframe.giscus-frame');
          if (!iframe) return;
          iframe.contentWindow.postMessage({ giscus: { setConfig: { theme: 'dark' } } }, 'https://giscus.app');
        });
      }
    }
  }
  commentConfig.enable = commentConfigKeys.some(key => commentConfig[key].enable);

  var defaultComment = '';
  if (commentConfig.enable) {
    // 1. 首先检查localStorage中是否有保存的评论类型
    var savedCommentType = localStorage.getItem('commentType');
    
    // 2. 如果localStorage中有值且对应的评论系统可用，就使用它
    if (savedCommentType) {
      if (commentConfig[savedCommentType]?.enable) {
        defaultComment = savedCommentType;
      }
    }
    
    // 3. 如果localStorage无效，检查配置的默认评论系统
    if (!defaultComment) {
      var configDefault = 'valine';
      if (commentConfig[configDefault]?.enable) {
        defaultComment = configDefault;
      }
    }
    
    // 4. 如果前两项都无效，按指定顺序找到第一个可用的评论系统
    if (!defaultComment) {
      defaultComment = commentConfigKeys.find(sys => commentConfig[sys].enable) || '';
    }
  }
  function loadComments() {
    if (!commentConfig.enable) return;
    // 评论组件加载状态跟踪
    const loadedComments = {
      valine: false,
      waline: false,
      twikoo: false,
      gitalk: false,
      giscus: false
    };

    // 隐藏所有评论容器
    const hideAllComments = () => {
      const commentContainers = document.querySelectorAll('.comment');
      commentContainers.forEach(container => {
        container.style.display = 'none';
      });
    };

    // 按需加载评论系统
    const loadCommentSystem = (type) => {
      if (loadedComments[type]) {
        // 如果已加载，只需显示对应容器
        document.querySelector(`.${type}-comment`).style.display = 'block';
        return;
      }

      // 根据类型加载对应的脚本
      commentConfig[type]?.load();
      loadedComments[type] = true;
    };

    // 评论组件选择器
    const changeActiveCommentItems = (item) => {
      const commentItems = document.querySelectorAll('.selector-item');
      for (let i = 0; i < commentItems.length; i++) {
        commentItems[i].classList.remove('active');
      }
      item.classList.add('active');

      // 获取要加载的评论系统类型
      const commentType = item.getAttribute('data-selector');

      // 隐藏所有评论系统
      hideAllComments();

      // 加载选中的评论系统
      loadCommentSystem(commentType);
    };

    const commentInit = () => {
      // 评论组件选择器点击事件
      const commentItems = document.querySelectorAll('.selector-item');
      for (let item of commentItems) {
        item.addEventListener('click', () => {
          // 保存选择器状态
          const commentType = item.getAttribute('data-selector');
          window.localStorage.setItem('commentType', commentType);
          // 切换选中状态
          changeActiveCommentItems(item);
        });
      }

      // 检查是否需要加载默认评论系统
      if (defaultComment) {
        const defaultSelectorItem = document.querySelector(`[data-selector="${defaultComment}"]`);
        if (!defaultSelectorItem) return;
        defaultSelectorItem.style.display = 'block';
        defaultSelectorItem.classList.add('active');
        loadCommentSystem(defaultComment);
      }
    }

    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', commentInit);
    } else {
      commentInit();
    }
  };
  loadComments();
</script>

    
  </div>
</div>


  <script>
    console.log(String.raw`%c 
 ______     ______     __     __    __     __  __    
/\  == \   /\  ___\   /\ \   /\ "-./  \   /\ \/\ \   
\ \  __<   \ \  __\   \ \ \  \ \ \-./\ \  \ \ \_\ \  
 \ \_\ \_\  \ \_____\  \ \_\  \ \_\ \ \_\  \ \_____\ 
  \/_/ /_/   \/_____/   \/_/   \/_/  \/_/   \/_____/ 
                                                  
`,'color: #ff5252;')
    console.log('%c Theme.Reimu v' + '1.6.0' + ' %c https://github.com/D-Sketon/hexo-theme-reimu ', 'color: white; background: #ff5252; padding:5px 0;', 'padding:4px;border:1px solid #ff5252;')
  </script>
  



  
<script src="https://npm.webcache.cn/busuanzi@2.3.0/bsz.pure.mini.js" integrity="sha384-0M75wtSkhjIInv4coYlaJU83+OypaRCIq2SukQVQX04eGTCBXJDuWAbJet56id+S" crossorigin="anonymous" async></script>




<script>
  if ('serviceWorker' in navigator) {
    navigator.serviceWorker.getRegistrations().then((registrations) => {
      for (let registration of registrations) {
        registration.unregister();
      }
    });
  }
</script>









    
  </body>
  </html>

