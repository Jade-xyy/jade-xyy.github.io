
  <!DOCTYPE html>
  <html lang="zh-CN"  
    
      data-theme-mode="false"
    
  >
  <head>
  
  <meta charset="utf-8">
  

  

  
    <meta name="baidu-site-verification" content="codeva-eNDxNiE4HI" />


  <script>window.REIMU_CONFIG = {};window.REIMU_CONFIG.icon_font = '4552607_0khxww3tj3q9';window.REIMU_CONFIG.clipboard_tips = {"success":"复制成功(*^▽^*)","fail":"复制失败 (ﾟ⊿ﾟ)ﾂ","copyright":{"enable":false,"count":50,"content":"本文版权：本博客所有文章除特别声明外，均采用 BY-NC-SA 许可协议。转载请注明出处！"}};window.REIMU_CONFIG.anchor_icon = 'D7';window.REIMU_CONFIG.code_block = {"expand":30};window.REIMU_CONFIG.base = 'https://jade-xyy.github.io';window.REIMU_CONFIG.i18n_languages = ["en","ja"];</script>
  
  <title>
    K8s备忘 - 下 |
    
    本堂主Blog
  </title>
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  
  
    <link rel="preconnect" href="https://fonts.gstatic.com/" crossorigin><link rel="preload" as="style" href="https://fonts.googleapis.com/css?family=Mulish:400,400italic,700,700italic%7CNoto%20Serif%20SC:400,400italic,700,700italic&display=swap"><link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Mulish:400,400italic,700,700italic%7CNoto%20Serif%20SC:400,400italic,700,700italic&display=swap" media="print" onload="this.media&#x3D;&#39;all&#39;">
  
  
    <link rel="preload" href="//at.alicdn.com/t/c/font_4552607_0khxww3tj3q9.woff2" as="font" type="font/woff2" crossorigin="anonymous">
  
  
    
<link rel="stylesheet" href="/css/loader.css">

  
  
    <meta name="description" content="调度简介Scheduler是k8s的调度器，主要任务是定义的pod分配到集群的节点上 调度原则 公平：保证每个节点都能被分配资源 资源高效利用：集群所有资源最大化被使用 效率：调度的性能要好，能够尽快地对大批量的pod完成调度工作 灵活：允许用户根据自己的需求控制调度的逻辑Scheduler是作为单独的程序运行的，启动之后会一直坚挺（持续连接）APIServer，获取PodSpec.NodeNam">
<meta property="og:type" content="article">
<meta property="og:title" content="K8s备忘 - 下">
<meta property="og:url" content="https://jade-xyy.github.io/ja/2025/04/11/k8sNote2/index.html">
<meta property="og:site_name" content="本堂主Blog">
<meta property="og:description" content="调度简介Scheduler是k8s的调度器，主要任务是定义的pod分配到集群的节点上 调度原则 公平：保证每个节点都能被分配资源 资源高效利用：集群所有资源最大化被使用 效率：调度的性能要好，能够尽快地对大批量的pod完成调度工作 灵活：允许用户根据自己的需求控制调度的逻辑Scheduler是作为单独的程序运行的，启动之后会一直坚挺（持续连接）APIServer，获取PodSpec.NodeNam">
<meta property="og:locale" content="ja_JP">
<meta property="og:image" content="https://jade-xyy.github.io/ja/2025/04/11/k8sNote2/_posts/k8sNote1/k8s_apiserver.png">
<meta property="og:image" content="https://jade-xyy.github.io/ja/2025/04/11/k8sNote2/_posts/k8sNote1/k8s_auth.png">
<meta property="og:image" content="https://jade-xyy.github.io/source/_posts/k8sNote1/k8s_auth_https.png">
<meta property="og:image" content="https://jade-xyy.github.io/ja/2025/04/11/k8sNote2/_posts/k8sNote1/k8s_auth_node.png">
<meta property="og:image" content="https://jade-xyy.github.io/ja/2025/04/11/k8sNote2/_posts/k8sNote1/k8s_auth_rbac.png">
<meta property="og:image" content="https://jade-xyy.github.io/ja/2025/04/11/k8sNote2/_posts/k8sNote1/k8s_auth_rbac_exam.png">
<meta property="og:image" content="https://jade-xyy.github.io/ja/2025/04/11/k8sNote2/_posts/k8sNote1/k8s_heml.png">
<meta property="og:image" content="https://jade-xyy.github.io/ja/2025/04/11/k8sNote2/_posts/k8sNote1/k8s_helm_efk.png">
<meta property="article:published_time" content="2025-04-11T06:57:07.000Z">
<meta property="article:modified_time" content="2025-04-18T07:56:07.569Z">
<meta property="article:author" content="本堂主">
<meta property="article:tag" content="k8s">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://jade-xyy.github.io/ja/2025/04/11/k8sNote2/_posts/k8sNote1/k8s_apiserver.png">
  
  
    <link rel="alternate" href="/atom.xml" title="本堂主Blog" type="application/atom+xml">
  
  
    <link rel="shortcut icon" href="/images/favicon.ico">
  
  
<link rel="stylesheet" href="/css/style.css">

  <link rel="preload" href="https://npm.webcache.cn/photoswipe@5.4.4/dist/photoswipe.css" as="style" onload="this.onload=null;this.rel='stylesheet'">
  
  
    
      
<link rel="stylesheet" href="https://npm.webcache.cn/@waline/client@2.15.8/dist/waline.css">

    
  
  
  
    
<script src="https://npm.webcache.cn/pace-js@1.2.4/pace.min.js" integrity="sha384-k6YtvFUEIuEFBdrLKJ3YAUbBki333tj1CSUisai5Cswsg9wcLNaPzsTHDswp4Az8" crossorigin="anonymous"></script>

  
  
    
<link rel="stylesheet" href="https://npm.webcache.cn/@reimujs/aos@0.1.0/dist/aos.css">

  
  
  
<meta name="generator" content="Hexo 7.3.0"></head>

  <body>
    
    
  <div id='loader'>
    <div class="loading-left-bg loading-bg"></div>
    <div class="loading-right-bg loading-bg"></div>
    <div class="spinner-box">
      <div class="loading-taichi rotate">
        
          <svg width="150" height="150" viewBox="0 0 1024 1024" class="icon" version="1.1" xmlns="https://www.w3.org/2000/svg" shape-rendering="geometricPrecision">
            <path d="M303.5 432A80 80 0 0 1 291.5 592A80 80 0 0 1 303.5 432z" fill="var(--red-1, #ff5252)" />
            <path d="M512 65A447 447 0 0 1 512 959L512 929A417 417 0 0 0 512 95A417 417 0 0 0 512 929L512 959A447 447 0 0 1 512 65z 
           M512 95A417 417 0 0 1 929 512A208.5 208.5 0 0 1 720.5 720.5L720.5 592A80 80 0 0 0 720.5 432A80 80 0 0 0 720.5 592L720.5 720.5A208.5 208.5 0 0 1 512 512A208.5 208.5 0 0 0 303.5 303.5A208.5 208.5 0 0 0 95 512A417 417 0 0 1 512 95z" fill="var(--red-1, #ff5252)" />
          </svg>
        
      </div>
      <div class="loading-word">Wait a moment ...</div>
    </div>
  </div>
  </div>
  <script>
    var time = null;
    var startLoading = () => {
      time = Date.now();
      document.getElementById('loader').classList.remove("loading");
    }
    var endLoading = () => {
      if (!time) {
        document.body.style.overflow = 'auto';
        document.getElementById('loader').classList.add("loading");
      } else {
        if (Date.now() - time > 500) {
          time = null;
          document.body.style.overflow = 'auto';
          document.getElementById('loader').classList.add("loading");
        } else {
          setTimeout(endLoading, 500 - (Date.now() - time));
          time = null;
        }
      }
    }
    window.addEventListener('DOMContentLoaded', endLoading);
    document.getElementById('loader').addEventListener('click', endLoading);
  </script>

<div id="copy-tooltip" style="pointer-events: none; opacity: 0; transition: all 0.2s ease; position: fixed;top: 50%;left: 50%;z-index: 999;transform: translate(-50%, -50%);color: white;background: rgba(0, 0, 0, 0.5);padding: 10px 15px;border-radius: 10px;">
</div>


    <div id="container">
      <div id="wrap">
        <div id="header-nav">
  <nav id="main-nav">
    
      
        <span class="main-nav-link-wrap">
          <div class="main-nav-icon icon rotate">
            &#xe62b;
          </div>
          <a class="main-nav-link" href="/ja/">ホーム</a>
        </span>
      
        <span class="main-nav-link-wrap">
          <div class="main-nav-icon icon rotate">
            &#xe62b;
          </div>
          <a class="main-nav-link" href="/ja/archives">アーカイブ</a>
        </span>
      
        <span class="main-nav-link-wrap">
          <div class="main-nav-icon icon rotate">
            &#xe62b;
          </div>
          <a class="main-nav-link" href="/ja/about">プロフィール</a>
        </span>
      
        <span class="main-nav-link-wrap">
          <div class="main-nav-icon icon rotate">
            &#xe62b;
          </div>
          <a class="main-nav-link" href="/ja/friend">フレンド</a>
        </span>
      
    
    <a id="main-nav-toggle" class="nav-icon"></a>
  </nav>
  <nav id="sub-nav">
    
      <a id="nav-rss-link" class="nav-icon" href="/atom.xml" title="RSS フィード" target="_blank"></a>
    
    
    
      <a id="nav-search-btn" class="nav-icon popup-trigger" title="検索"></a>
    
  </nav>
  
    
    <nav id="i18n-nav">
      <div class="custom-dropdown">
        <div class="select-selected" id="select-selected">
          <span id="nav-language-btn" class="nav-icon" style="padding: 0 20px 0 0"></span>
          <span id="selected-lang">日本語</span>
        </div>
        <ul class="select-items" id="select-items">
          
            <li data-value="zh-CN" >简体中文</li>
          
            <li data-value="en" >English</li>
          
            <li data-value="ja" class="selected">日本語</li>
          
        </ul>
      </div>
      <script>
        var selectSelected = document.getElementById("select-selected");
        var selectedLang = document.getElementById("selected-lang");
        var selectItems = document.getElementById("select-items");
        var selectOptions = selectItems.querySelectorAll("li");

        selectSelected.addEventListener("click", () => {
          selectItems.classList.toggle("show");
        });

        selectOptions.forEach((item) => {
          item.addEventListener("click", () => {
            const langMap = {};
            
              langMap['zh-CN'] = '/2025/04/11/k8sNote2/';
            
              langMap['en'] = '/en/2025/04/11/k8sNote2/';
            
              langMap['ja'] = '/ja/2025/04/11/k8sNote2/';
            
            selectedLang.textContent = item.textContent;
            selectItems.classList.remove("show");
            selectOptions.forEach((option) => {
              option.classList.remove("selected");
            });
            item.classList.add("selected");
            window.location = langMap[item.dataset.value];
          });
        });

        document.addEventListener("click", (event) => {
          if (!event.target.closest(".custom-dropdown")) {
            selectItems.classList.remove("show");
          }
        });
      </script>
    </nav>
  
</div>
<header id="header">
  
    
      
        <picture>
          
            
              <source media="(max-width: 479px)" srcset="/images/zzz_cjjxrrdpts-600w.webp">
            
              <source media="(max-width: 799px)" srcset="/images/zzz_cjjxrrdpts-800w.webp">
            
              <source media="(min-width: 800px)" srcset="/images/zzz_cjjxrrdpts.webp">
            
            <img  fetchpriority="high" src="/images/zzz_cjjxrrdpts.webp" alt="K8s备忘 - 下">
          
        </picture>
        
          <img alt="K8s备忘 - 下" style="visibility: hidden;">
        
      
    
  
  <div id="header-outer">
    <div id="header-title">
      
        
        
          <a href="/" id="logo">
            <h1 data-aos="slide-up">K8s备忘 - 下</h1>
          </a>
        
      
      
        
        <h2 id="subtitle-wrap" data-aos="slide-down">
          
        </h2>
      
    </div>
  </div>
</header>

        <div id="content"  class="sidebar-right" >
          <aside id="sidebar">
  
  
  
  <div class="sidebar-wrapper wrap-sticky">
    <div class="sidebar-wrap" data-aos="fade-up">
      
        
          <div class="sidebar-toc-sidebar"><div class="sidebar-toc">
  <h3 class="toc-title">見出し</h3>
  <div class="sidebar-toc-wrapper toc-div-class" >
      
        <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%B0%83%E5%BA%A6"><span class="toc-text">调度</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%AE%80%E4%BB%8B"><span class="toc-text">简介</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%B0%83%E5%BA%A6%E5%8E%9F%E5%88%99"><span class="toc-text">调度原则</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%87%AA%E5%AE%9A%E4%B9%89%E8%B0%83%E5%BA%A6%E5%99%A8"><span class="toc-text">自定义调度器</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%B0%83%E5%BA%A6%E4%BA%B2%E5%92%8C%E6%80%A7"><span class="toc-text">调度亲和性</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E8%8A%82%E7%82%B9%E4%BA%B2%E5%92%8C%E6%80%A7%EF%BC%88pod%E5%92%8Cnode%E9%97%B4%EF%BC%89"><span class="toc-text">节点亲和性（pod和node间）</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#Pod%E4%BA%B2%E5%92%8C%E6%80%A7%EF%BC%88pod%E5%92%8Cpod%E9%97%B4%EF%BC%89"><span class="toc-text">Pod亲和性（pod和pod间）</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E4%BA%B2%E5%92%8C%E6%80%A7-%E5%8F%8D%E4%BA%B2%E5%92%8C%E6%80%A7%E8%B0%83%E5%BA%A6%E7%AD%96%E7%95%A5%E6%AF%94%E8%BE%83%E5%A6%82%E4%B8%8B%EF%BC%9A"><span class="toc-text">亲和性&#x2F;反亲和性调度策略比较如下：</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Taint%E5%92%8CToleration"><span class="toc-text">Taint和Toleration</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%B1%A1%E7%82%B9%EF%BC%88Taint%EF%BC%89"><span class="toc-text">污点（Taint）</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%AE%B9%E5%BF%8D%EF%BC%88Tolerations%EF%BC%89"><span class="toc-text">容忍（Tolerations）</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%8C%87%E5%AE%9A%E8%B0%83%E5%BA%A6%E8%8A%82%E7%82%B9"><span class="toc-text">指定调度节点</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AE%89%E5%85%A8"><span class="toc-text">安全</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%9C%BA%E5%88%B6%E8%AF%B4%E6%98%8E"><span class="toc-text">机制说明</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%AE%A4%E8%AF%81%EF%BC%88Authentication%EF%BC%89"><span class="toc-text">认证（Authentication）</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#HTTPS%E8%AF%81%E4%B9%A6%E8%AE%A4%E8%AF%81"><span class="toc-text">HTTPS证书认证</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E9%9C%80%E8%A6%81%E8%AE%A4%E8%AF%81%E7%9A%84%E8%8A%82%E7%82%B9"><span class="toc-text">需要认证的节点</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#kubeconfig"><span class="toc-text">kubeconfig</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#ServiceAccount"><span class="toc-text">ServiceAccount</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#Secret%E5%92%8CSA%E5%85%B3%E7%B3%BB"><span class="toc-text">Secret和SA关系</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%89%B4%E6%9D%83%EF%BC%88Authorization%EF%BC%89"><span class="toc-text">鉴权（Authorization）</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#API-Server%E7%9B%AE%E5%89%8D%E6%94%AF%E6%8C%81%E4%B8%80%E4%B8%8B%E5%87%A0%E7%A7%8D%E6%8E%88%E6%9D%83%E7%AD%96%E7%95%A5"><span class="toc-text">API Server目前支持一下几种授权策略</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#RBAC%E6%8E%88%E6%9D%83%E6%A8%A1%E5%BC%8F"><span class="toc-text">RBAC授权模式</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%AE%9E%E8%B7%B5"><span class="toc-text">实践</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%87%86%E5%85%A5%E6%8E%A7%E5%88%B6%EF%BC%88Admission-Control%EF%BC%89"><span class="toc-text">准入控制（Admission Control）</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Helm"><span class="toc-text">Helm</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%AE%9A%E4%B9%89"><span class="toc-text">定义</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#chart"><span class="toc-text">chart</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#release"><span class="toc-text">release</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%BB%84%E4%BB%B6"><span class="toc-text">组件</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Helm%E9%83%A8%E7%BD%B2"><span class="toc-text">Helm部署</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Helm%E8%87%AA%E5%AE%9A%E4%B9%89%E6%A8%A1%E6%9D%BF"><span class="toc-text">Helm自定义模板</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#Debug"><span class="toc-text">Debug</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8Helm%E9%83%A8%E7%BD%B2dashboard"><span class="toc-text">使用Helm部署dashboard</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8Helm%E9%83%A8%E7%BD%B2metrics-server"><span class="toc-text">使用Helm部署metrics-server</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8Helm%E9%83%A8%E7%BD%B2prometheus"><span class="toc-text">使用Helm部署prometheus</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E7%BB%84%E4%BB%B6%E8%AF%B4%E6%98%8E"><span class="toc-text">组件说明</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E9%83%A8%E7%BD%B2"><span class="toc-text">部署</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#Horizontal-Pod-Autoscaling"><span class="toc-text">Horizontal Pod Autoscaling</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E8%B5%84%E6%BA%90%E9%99%90%E5%88%B6-Pod"><span class="toc-text">资源限制 - Pod</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E8%B5%84%E6%BA%90%E9%99%90%E5%88%B6-%E5%90%8D%E7%A7%B0%E7%A9%BA%E9%97%B4"><span class="toc-text">资源限制 - 名称空间</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E8%AE%BF%E9%97%AEprometheus"><span class="toc-text">访问prometheus</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E8%AE%BF%E9%97%AEgrafana"><span class="toc-text">访问grafana</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8Helm%E9%83%A8%E7%BD%B2EFK%E5%B9%B3%E5%8F%B0"><span class="toc-text">使用Helm部署EFK平台</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%AF%81%E4%B9%A6"><span class="toc-text">证书</span></a></li></ol>
      
  </div>
</div>
</div>
          <div class="sidebar-common-sidebar hidden"><div class="sidebar-author">
  <img data-src="/avatar/Omen.jpg" data-sizes="auto" alt="本堂主" class="lazyload">
  <div class="sidebar-author-name">本堂主</div>
  <div class="sidebar-description"></div>
</div>
<div class="sidebar-state">
  <div class="sidebar-state-article">
    <div>投稿</div>
    <div class="sidebar-state-number">17</div>
  </div>
  <div class="sidebar-state-category">
    <div>カテゴリー</div>
    <div class="sidebar-state-number">5</div>
  </div>
  <div class="sidebar-state-tag">
    <div>タグ</div>
    <div class="sidebar-state-number">10</div>
  </div>
</div>
<div class="sidebar-social">
  
</div>
<div class="sidebar-menu">
  
    
      <div class="sidebar-menu-link-wrap">
        <a class="sidebar-menu-link-dummy" href="/ja/" aria-label="ホーム"></a>
        <div class="sidebar-menu-icon icon rotate">
          &#xe62b;
        </div>
        <div class="sidebar-menu-link">ホーム</div>
      </div>
    
      <div class="sidebar-menu-link-wrap">
        <a class="sidebar-menu-link-dummy" href="/ja/archives" aria-label="アーカイブ"></a>
        <div class="sidebar-menu-icon icon rotate">
          &#xe62b;
        </div>
        <div class="sidebar-menu-link">アーカイブ</div>
      </div>
    
      <div class="sidebar-menu-link-wrap">
        <a class="sidebar-menu-link-dummy" href="/ja/about" aria-label="プロフィール"></a>
        <div class="sidebar-menu-icon icon rotate">
          &#xe62b;
        </div>
        <div class="sidebar-menu-link">プロフィール</div>
      </div>
    
      <div class="sidebar-menu-link-wrap">
        <a class="sidebar-menu-link-dummy" href="/ja/friend" aria-label="フレンド"></a>
        <div class="sidebar-menu-icon icon rotate">
          &#xe62b;
        </div>
        <div class="sidebar-menu-link">フレンド</div>
      </div>
    
  
</div>
</div>
        
      
      
        
          <div class="sidebar-btn-wrapper" style="position:static">
            <div class="sidebar-toc-btn current"></div>
            <div class="sidebar-common-btn"></div>
          </div>
        
      
    </div>
  </div>

  <div class="sidebar-widget">
  
  </div>
  
</aside>

          <section id="main"><article id="post-k8sNote2" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-inner" data-aos="fade-up">
    <div class="article-meta">
      <div class="article-date">
  <span class="article-date-link" data-aos="zoom-in">
    <time datetime="2025-04-11T06:57:07.000Z" itemprop="datePublished">2025-04-11</time>
    <time style="display: none;" id="post-update-time">2025-04-18</time>
  </span>
</div>

      
  <div class="article-category">
    <a class="article-category-link" href="/ja/categories/notes/" data-aos="zoom-in">notes</a><a class="article-category-link" href="/ja/categories/study/" data-aos="zoom-in">study</a>
  </div>


    </div>
    <div class="hr-line"></div>
    

    <div class="e-content article-entry" itemprop="articleBody">
      
      
        <h2 id="调度"><a href="#调度" class="headerlink" title="调度"></a>调度</h2><h4 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h4><p>Scheduler是k8s的调度器，主要任务是定义的pod分配到集群的节点上</p>
<h4 id="调度原则"><a href="#调度原则" class="headerlink" title="调度原则"></a>调度原则</h4><ul>
<li>公平：保证每个节点都能被分配资源</li>
<li>资源高效利用：集群所有资源最大化被使用</li>
<li>效率：调度的性能要好，能够尽快地对大批量的pod完成调度工作</li>
<li>灵活：允许用户根据自己的需求控制调度的逻辑<br>Scheduler是作为单独的程序运行的，启动之后会一直坚挺（持续连接）APIServer，获取PodSpec.NodeName为空的pod，对每个pod都会创建一个binding，表明该pod应该放到哪个节点上<br>指定了PodSpec.NodeName后scheduler不需要参与进来，除此外都会参与<br>-#### 调度过程</li>
</ul>
<p>调度分为几个部分：首先是predicate（预选）：过滤掉<code>不满足条件</code>的节点；然后是priority（优选）：对通过的节点按照<code>优先级</code>排序；最后是从中选择优先级最高的节点，如果中间任何一步有错，则直接返回错误<br>【Predicate常见算法】</p>
<ul>
<li>PodFitsResources：节点上剩余的资源是否大于pod请求的资源</li>
<li>PodFitsHost：如果pod指定了NodeName，检查节点名称是否和NodeName匹配</li>
<li>PodFitsHostPorts：节点上已经使用的port是否和pod申请的port冲突</li>
<li>PodSelectorMatches：过滤掉和pod指定的label不匹配的节点</li>
<li>NoDiskConflict：已经mount的volume和pod指定的volume不冲突，除非他们都是只读</li>
</ul>
<p>如果在predicate过程中没有合适的节点，pod会一直在pending状态，不断重试调度，直到有节点满足条件。<br>经过这个步骤，如果有多个节点满足条件，就继续priorities过程：按照优先级大小对节点排序：<br>【优先级】由键值对组成，键是名称，值是权重：</p>
<ul>
<li>LeastRequestedPriority：通过计算CPU和Memory的使用率来决定权重，使用率越低权重越高，换句话说，这个优先级指标倾向于<code>资源使用比例更低</code>的节点</li>
<li>BalancedResourceAllocation：节点上CPU和Memory<code>使用率越近，权重越高</code>。这个应该和上面的一起使用，不应该单独使用</li>
<li>ImageLocalityPriority：倾向于已经有要使用镜像的节点，镜像总大小值越大，权重越高<br>通过算法对所有的优先级项目和权重进行计算，得出最终的结果</li>
</ul>
<h4 id="自定义调度器"><a href="#自定义调度器" class="headerlink" title="自定义调度器"></a>自定义调度器</h4><p>（不满足于官方提供的调度器，可自行编写）<br>通过<code>spec:schedulername</code>参数指定调度器的名称，可以为pod选择某个调度器进行调度，比如下面的pod选择my-scheduler进行调度。而不是默认的default-scheduler：</p>
<figure class="highlight yml"><table><tr><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">annotation-second-scheduler</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">mulischeduler-example</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">schedulername:</span> <span class="string">my-scheduler</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">pod-with-second-annotation-container</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">gcr.io/google_containers/pause:2.0</span></span><br></pre></td></tr></table></figure>
<h4 id="调度亲和性"><a href="#调度亲和性" class="headerlink" title="调度亲和性"></a>调度亲和性</h4><h5 id="节点亲和性（pod和node间）"><a href="#节点亲和性（pod和node间）" class="headerlink" title="节点亲和性（pod和node间）"></a>节点亲和性（pod和node间）</h5><p><code>pod.spec.nodeAffinity</code>下声明</p>
<ul>
<li>preferredDuringSchedulingIgnoredDuringExecution：软策略</li>
<li>requiredDuringSchedulingIgnoredDuringExecution：硬策略<blockquote>
<p>举例：分班级，我更倾向于张三老师的班级，如果我是pod，张三老师就是node，这就是所谓的节点亲和性。有个说法就是，我必须去 硬策略、我想去，典型的软策略</p>
</blockquote>
</li>
</ul>
<figure class="highlight yml"><table><tr><td class="code"><pre><span class="line"><span class="comment">## 硬策略：不满足就不运行</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">affinity</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">node-affinity-pod</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">with-node-affinity</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">hub.jade.com/library/myapp:v1</span></span><br><span class="line">  <span class="attr">affinity:</span></span><br><span class="line">    <span class="attr">nodeAffinity:</span></span><br><span class="line">      <span class="attr">requiredDuringSchedulingIgnoreDuringExecution:</span></span><br><span class="line">        <span class="attr">nodeSelectorTerms:</span></span><br><span class="line">        <span class="comment"># notin 只要不是kubernetes.io/hostname标签，值为k8s-node02的节点就行</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">matchExpressions:</span></span><br><span class="line">          <span class="bullet">-</span> <span class="attr">key:</span> <span class="string">kubernetes.io/hostname</span></span><br><span class="line">            <span class="attr">operator:</span> <span class="string">NotIn</span></span><br><span class="line">            <span class="attr">values:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">k8s-node02</span></span><br><span class="line"><span class="comment"># 结果始终运行在node02</span></span><br><span class="line">          </span><br><span class="line"><span class="comment">## 软策略：如果有的话就运行，没有就算了</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">affinity</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">node-affinity-pod</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">with-node-affinity</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">hub.jade.com/library/myapp:v1</span></span><br><span class="line">  <span class="attr">affinity:</span></span><br><span class="line">    <span class="attr">nodeAffinity:</span></span><br><span class="line">      <span class="attr">preferredDuringSchedulingIgnoredDuringExecution:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">weight:</span> <span class="number">1</span></span><br><span class="line">        <span class="attr">prefernece:</span></span><br><span class="line">          <span class="attr">matchExpressions:</span></span><br><span class="line">          <span class="bullet">-</span> <span class="attr">key:</span> <span class="string">kubernetes.io/hostname</span></span><br><span class="line">            <span class="attr">operator:</span> <span class="string">In</span></span><br><span class="line">            <span class="attr">values:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">k8s-node03</span></span><br><span class="line"><span class="comment"># 结果 不存在node03，到node01上运行</span></span><br><span class="line">            </span><br><span class="line"><span class="comment">## 合体：先满足硬策略再满足软策略</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">affinity</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">node-affinity-pod</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">with-node-affinity</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">hub.jade.com/library/myapp:v1</span></span><br><span class="line">  <span class="attr">affinity:</span></span><br><span class="line">    <span class="attr">nodeAffinity:</span></span><br><span class="line">      <span class="attr">requiredDuringSchedulingIgnoreDuringExecution:</span></span><br><span class="line">        <span class="attr">nodeSelectorTerms:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">matchExpressions:</span></span><br><span class="line">          <span class="bullet">-</span> <span class="attr">key:</span> <span class="string">kubernetes.io/hostname</span></span><br><span class="line">            <span class="attr">operator:</span> <span class="string">NotIn</span></span><br><span class="line">            <span class="attr">values:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">k8s-node02</span></span><br><span class="line">      <span class="attr">preferredDuringSchedulingIgnoredDuringExecution:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">weight:</span> <span class="number">1</span></span><br><span class="line">        <span class="attr">preference:</span></span><br><span class="line">          <span class="attr">matchExpressions:</span></span><br><span class="line">          <span class="bullet">-</span> <span class="attr">key:</span> <span class="string">kubernetes.io/hostname</span></span><br><span class="line">            <span class="attr">operator:</span> <span class="string">In</span></span><br><span class="line">            <span class="attr">values:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">k9s-node03</span></span><br></pre></td></tr></table></figure>
<p>【键值运算关系】：</p>
<ul>
<li>In：label的值在某个列表中</li>
<li>NotIn：label的值不在某个列表中</li>
<li>Gt：label的值大于某个值</li>
<li>Lt：label的值小于某个值</li>
<li>Exists：某个label存在</li>
<li>DoesNotExist：某个label不存在<br><em>如果nodeSelectorTerms下面有多个选项的话，满足任何一个条件就可以了</em><br><em>如果matchExpressions有多个选项，则必须同时满足这些条件才能正常调度pod</em></li>
</ul>
<h5 id="Pod亲和性（pod和pod间）"><a href="#Pod亲和性（pod和pod间）" class="headerlink" title="Pod亲和性（pod和pod间）"></a>Pod亲和性（pod和pod间）</h5><p><code>pod.spec.affinity.podAffinity/podAntiAffinity</code>下声明</p>
<ul>
<li>preferredDuringSchedulingIgnoredDuringExecution：软策略</li>
<li>requiredDuringSchedulingIgnoredDuringExecution：硬策略<blockquote>
<p>举例：原来同桌叫李四，我想和李四一个班级，这就是pod亲和性，李四在的班级我一定要去 硬策略，一不去不行；李四在的班级我想去 软策略，想的概念就是不去也可以</p>
</blockquote>
</li>
</ul>
<figure class="highlight yml"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 首先新建一个在node01上的pod-1</span></span><br><span class="line"><span class="comment"># 然后创建pod-3利用亲和性和pod1在一个node</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">king:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">pod-3</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">pod-3</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">pod-3</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">hub.jade.com/library/myapp:v1</span></span><br><span class="line">  <span class="attr">affinity:</span></span><br><span class="line">    <span class="string">podAffinity:#</span> <span class="string">想让两个pod运行在同一个node用pod亲和性</span></span><br><span class="line">      <span class="attr">requiredDuringSchedulingIgnoreDuringExecution:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">labelSelector:</span></span><br><span class="line">          <span class="attr">matchExpressions:</span></span><br><span class="line">          <span class="bullet">-</span> <span class="attr">key:</span> <span class="string">app</span></span><br><span class="line">            <span class="attr">operator:</span> <span class="string">In</span></span><br><span class="line">            <span class="attr">values:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">node01</span></span><br><span class="line">            <span class="comment"># 当pod标签app存在pod-1时就选择，不存在就不运行</span></span><br><span class="line">        <span class="attr">topologykey:</span> <span class="string">kubernetes.io/hostname</span> <span class="comment"># 通过这个值判断两个pod是否在同一node上</span></span><br><span class="line">    <span class="string">podAntiAffinity:#</span> <span class="string">不想让两个pod运行在同一个node上用pod反亲和性</span></span><br><span class="line">      <span class="attr">preferredDuringSchedulingSchedulingIgnoreDuringExecution:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">weight:</span> <span class="number">1</span></span><br><span class="line">        <span class="attr">podAffinityTerm:</span></span><br><span class="line">          <span class="attr">labelSelector:</span></span><br><span class="line">            <span class="attr">matchExpressions:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">key:</span> <span class="string">app</span></span><br><span class="line">              <span class="attr">operator:</span> <span class="string">In</span></span><br><span class="line">              <span class="attr">values:</span></span><br><span class="line">              <span class="bullet">-</span> <span class="string">node01</span></span><br></pre></td></tr></table></figure>
<h5 id="亲和性-反亲和性调度策略比较如下："><a href="#亲和性-反亲和性调度策略比较如下：" class="headerlink" title="亲和性&#x2F;反亲和性调度策略比较如下："></a>亲和性&#x2F;反亲和性调度策略比较如下：</h5><p>(同一拓扑域：同一labels下)</p>
<table>
<thead>
<tr>
<th align="left">调度策略</th>
<th align="center">匹配标签</th>
<th align="left">操作符</th>
<th align="center">拓扑域支持</th>
<th align="left">调度目标</th>
</tr>
</thead>
<tbody><tr>
<td align="left">nodeAffinity</td>
<td align="center">主机</td>
<td align="left">In<br>NotIn<br>Exists<br>DoesNotExist<br>Gt<br>Lt</td>
<td align="center">否</td>
<td align="left">指定主机</td>
</tr>
<tr>
<td align="left">podAffinity</td>
<td align="center">POD</td>
<td align="left">In<br>NotIn<br>Exists<br>DoesNotExist</td>
<td align="center">是</td>
<td align="left">pod与指定pod同一拓扑域</td>
</tr>
<tr>
<td align="left">podAnitAffinity</td>
<td align="center">POD</td>
<td align="left">In<br>NotIn<br>Exists<br>DoesNotExist</td>
<td align="center">是</td>
<td align="left">pod与指定pod不在同一拓扑域</td>
</tr>
</tbody></table>
<h4 id="Taint和Toleration"><a href="#Taint和Toleration" class="headerlink" title="Taint和Toleration"></a>Taint和Toleration</h4><p>节点亲和性，是pod的一种属性（偏好或硬性要求），它使pod被吸引到一类特定的节点<br>Taint则相反，是node的属性，它<code>使节点能够排斥一类特定的pod</code><br>Taint和toleration相互配合，可以用来避免pod被分配到不合适的节点上。每个节点上都可以应用一个或多个taint，这表示对于那些不能容忍这些taint的pod，是不会被该节点接受的。如果将toleration应用于pod上，则表示这些pod可以（但不要求）被调度到具有匹配taint的节点上<br>(举例：相亲，有些人不喜欢对方打呼，容忍不了)</p>
<h5 id="污点（Taint）"><a href="#污点（Taint）" class="headerlink" title="污点（Taint）"></a>污点（Taint）</h5><p><strong>污点的组成</strong><br>使用<code>kubectl taint</code>命令可以给某个node设置污点，Node被设置上污点之后就和pod之间存在了一种互斥的关系，可以让Node拒绝Pod的调度执行，甚至将Node已经存在的Pod驱逐出去<br>每个污点的组成如下</p>
<figure class="highlight yml"><table><tr><td class="code"><pre><span class="line"><span class="string">key=value:effect</span></span><br><span class="line"><span class="comment"># 每个污点有一个key和value作为污点的标签，其中value可为空，effect描述污点的作用</span></span><br></pre></td></tr></table></figure>
<p>当前taint effect支持如下三个选项：</p>
<ul>
<li>NoSchedule：表示k8s将不会调度到具有该污点的node上；master节点天生就被打了这个污点标签，所以pod不会运行到master上</li>
<li>PreferNoSchedule：表示k8s将尽量避免将pod调度到具有该污点的node上</li>
<li>NoExecute：表示k8s将不会将pod调度到具有该污点的node上，同时会将node上已经存在的Pod驱逐出去</li>
</ul>
<p><strong>污点的设置、查看和去除</strong></p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 设置污点</span></span><br><span class="line">kubectl taint nodes node1 key1=value1:NoSchedule</span><br><span class="line"></span><br><span class="line"><span class="comment"># 节点说明中查找Taints字段</span></span><br><span class="line">kubectl describe pod pod-name</span><br><span class="line"></span><br><span class="line"><span class="comment"># 去除污点</span></span><br><span class="line">kubectl taint nodes node1 key1:NoSchedule-</span><br></pre></td></tr></table></figure>
<h5 id="容忍（Tolerations）"><a href="#容忍（Tolerations）" class="headerlink" title="容忍（Tolerations）"></a>容忍（Tolerations）</h5><p>设置了污点的node将根据taint的effect：NoSchedule、PreferNoSchedule、NoExecute和pod之间产生互斥的关系，pod将在一定程度上不会被调度到node上，<br>但我们可以在pod上设置容忍（Toleration），意思是设置了容忍的pod将可以容忍污点的存在，可以被调度到存在污点的node上<br><code>pod.spec.tolerations</code></p>
<figure class="highlight yml"><table><tr><td class="code"><pre><span class="line"><span class="attr">tolerations:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">key:</span> <span class="string">&quot;key1&quot;</span></span><br><span class="line">  <span class="attr">operator:</span> <span class="string">&quot;Equal&quot;</span></span><br><span class="line">  <span class="attr">value:</span> <span class="string">&quot;value1&quot;</span></span><br><span class="line">  <span class="attr">effect:</span> <span class="string">&quot;NoSchedule&quot;</span></span><br><span class="line">  <span class="attr">tolerationSeconds:</span> <span class="number">3600</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">key:</span> <span class="string">&quot;key1&quot;</span></span><br><span class="line">  <span class="attr">operator:</span> <span class="string">&quot;Equal&quot;</span></span><br><span class="line">  <span class="attr">value:</span> <span class="string">&quot;value1&quot;</span></span><br><span class="line">  <span class="attr">effect:</span> <span class="string">&quot;NoExecute&quot;</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">key:</span> <span class="string">&quot;key2&quot;</span></span><br><span class="line">  <span class="attr">operator:</span> <span class="string">&quot;Exists&quot;</span></span><br><span class="line">  <span class="attr">effect:</span> <span class="string">&quot;NoSchedule&quot;</span></span><br></pre></td></tr></table></figure>
<ul>
<li>其中key、value、effect要与Node上设置的taint保持一致</li>
<li>operator的值为Exists将会忽略value值</li>
<li>tolerationSeconds用于描述当pod需要被驱逐时可以在pod上继续保留运行的时间<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 1.当不指定key时，表示容忍所有的污点key</span></span><br><span class="line">tolerations:</span><br><span class="line">- operator: <span class="string">&quot;Exists&quot;</span></span><br><span class="line"><span class="comment"># 2.当不指定effect值时，表示容忍所有的污点作用</span></span><br><span class="line">tolerations:</span><br><span class="line">- key: <span class="string">&quot;key&quot;</span></span><br><span class="line">  operator: <span class="string">&quot;Exists&quot;</span></span><br><span class="line"><span class="comment"># 3.有多个master存在时，防止资源浪费，可以设置如下</span></span><br><span class="line">kubectl taint nodes Node-Name node-role.kubernetes.io/master=:PreferNoSchedule <span class="comment"># 尽可能不在该节点运行</span></span><br></pre></td></tr></table></figure></li>
</ul>
<h4 id="指定调度节点"><a href="#指定调度节点" class="headerlink" title="指定调度节点"></a>指定调度节点</h4><p>pod.spec.nodeName将pod直接调度到指定的node节点上，会跳过Scheduler的调度策略，该匹配规则是强制匹配</p>
<figure class="highlight yml"><table><tr><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">extensions/v1beta1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">myweb</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">7</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">label:</span></span><br><span class="line">        <span class="string">app:myweb</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">nodeName:</span> <span class="string">k8s-node01</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">myweb</span></span><br><span class="line">        <span class="attr">image:</span> <span class="string">hub.jade.com/library/myapp:v1</span></span><br><span class="line">        <span class="attr">ports:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">80</span></span><br></pre></td></tr></table></figure>
<p>pod.spec.nodeSelector：通过kubernetes的label-selector机制选择节点，由调度器调度策略匹配label，而后调度pod到目标节点，该匹配规则属于强制约束</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 没有匹配标签会一直peding</span></span><br><span class="line">kubectl label node k8s-node01 disk=ssd</span><br><span class="line"></span><br><span class="line">apiVersion: extensions/v1beta1</span><br><span class="line">kind: Deployment</span><br><span class="line">metadata:</span><br><span class="line">  name: myweb2</span><br><span class="line">spec:</span><br><span class="line">  replicas: 2</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      label:</span><br><span class="line">        app:myweb2</span><br><span class="line">    spec:</span><br><span class="line">      nodeSelector:</span><br><span class="line">        disk: ssd</span><br><span class="line">      containers:</span><br><span class="line">      - name: myweb2</span><br><span class="line">        image: hub.jade.com/library/myapp:v1</span><br><span class="line">        ports:</span><br><span class="line">        - containerPort: 80</span><br></pre></td></tr></table></figure>

<hr>
<h2 id="安全"><a href="#安全" class="headerlink" title="安全"></a>安全</h2><h4 id="机制说明"><a href="#机制说明" class="headerlink" title="机制说明"></a>机制说明</h4><p>k8s作为一个分布式集群的管理工具，保证集群的安全性是一个重要的任务<br>apiServer是集群内部各个组件通信的中介，也是外部控制的入口。<br>所以k8s的安全机制基本就是围绕保护apiServer来设计的<br>k8s使用了认证(Authentication)、鉴权(Authorization)、准入控制(Admission Control)三步来保证APIServer的安全<br><img src="_posts/k8sNote1/k8s_apiserver.png"></p>
<h4 id="认证（Authentication）"><a href="#认证（Authentication）" class="headerlink" title="认证（Authentication）"></a>认证（Authentication）</h4><p><img src="_posts/k8sNote1/k8s_auth.png"></p>
<ul>
<li>HTTP Token认证：通过一个Token来识别合法用户<ul>
<li>HTTP Token的认证是用一个很长的特殊编码方式且难以被模仿的字符串-Token来表达客户的一种方式<br>每一个token对应一个用户名存储在APiServer能访问的文件中，当客户端发起API调用请求时，需要在HTTP Header里放入Token</li>
</ul>
</li>
<li>HTTP Base认证：通过用户名+密码的方式认证<ul>
<li>用户名+:+密码 用base64算法进行编码后的字符串放在HTTP Request中的Heather Authorization域里发送给服务端，服务端收到后进行编码，获取用户名及密码</li>
</ul>
</li>
<li>HTTPS证书认证（最严格的）：基于CA根证书签名的客户端身份认证方式（服务端客户端双向认证）</li>
</ul>
<h5 id="HTTPS证书认证"><a href="#HTTPS证书认证" class="headerlink" title="HTTPS证书认证"></a>HTTPS证书认证</h5><p><img src="/source/_posts/k8sNote1/k8s_auth_https.png"></p>
<h5 id="需要认证的节点"><a href="#需要认证的节点" class="headerlink" title="需要认证的节点"></a>需要认证的节点</h5><p><img src="_posts/k8sNote1/k8s_auth_node.png"><br><strong>两种类型</strong></p>
<ul>
<li>k8s组件对APIServer的访问：kubectl、ControllerManager、Scheduler、Kubelet、Kube-proxy</li>
<li>k8s管理的pod对容器的访问：Pod（dashboard也是以pod形式运行）</li>
</ul>
<p><strong>安全性说明</strong></p>
<ul>
<li>（本机访问）ControllerManager、Scheduler与APIServer在同一台机器，所以直接使用APIServer的非安全端口访问，–insecure-bind-address&#x3D;127.0.0.1</li>
<li>（远程访问，需防止第三方攻击）kubectl、kubelet、kube-proxy访问APIServer就都需要证书进行HTTPS双向认证</li>
</ul>
<p><strong>证书颁发</strong></p>
<ul>
<li>手动签发：通过k8s集群的根ca进行签发HTTPS证书（kubeadm安装，不涉及手动，都是自动）</li>
<li>自动签发：kubelet首次访问APIServer时，使用token做认证，通过后，ControllerManager会为kubelet生产一个证书，以后的访问都是用证书做认证了</li>
</ul>
<h5 id="kubeconfig"><a href="#kubeconfig" class="headerlink" title="kubeconfig"></a>kubeconfig</h5><p>kubeconfig文件包含集群参数（CA证书、APIServer地址），客户端参数（上面生成的证书和私钥），集群context信息（集群名称、用户名）<br>k8s组件通过启动时指定不同的kubeconfig文件可以切换到不同的集群<br>【位置】：.kube</p>
<h5 id="ServiceAccount"><a href="#ServiceAccount" class="headerlink" title="ServiceAccount"></a>ServiceAccount</h5><p>pod中的容器访问APIServer，因为pod的创建销毁是动态的，所以要为pod手动生成证书不可行，</p>
<h5 id="Secret和SA关系"><a href="#Secret和SA关系" class="headerlink" title="Secret和SA关系"></a>Secret和SA关系</h5><p>k8s设计了一种资源对象叫做Secret，分为两类，一种是用于sa的service-accout-token，另一种是用于保存用户自定义保密信息的Opaque<br>sa中用到包含三个部分：Token、ca.crt、ns</p>
<ul>
<li>token：使用apiserver私钥签名的JWT，用于访问apiServer时服务端认证</li>
<li>ca.crt：根证书，用于client端验证APIServer发送的证书</li>
<li>ns：标识这个service-account-token的作用域名空间<blockquote>
<p>Json web token（JWT）：是为了在网络应用环境间传递声明而执行的一种基于JSON的开放标准（[RFC 7519]），该token被设计为紧凑且安全的，特别适用于分布式站点的单点登录（SSO）场景。JWT的声明一般被用来在身份提供者和服务提供者间传递被认证的用户身份信息，以便于从资源服务器获取资源，也可以增加一些额外的其它业务逻辑所必须的声明信息，该token也可直接被用于认证，也可被加密</p>
</blockquote>
</li>
</ul>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">kubectl get secret --all-namespaces</span><br><span class="line">kubectl describe secret default-token-5gm9r --namespace=kube-system</span><br></pre></td></tr></table></figure>

<p>默认情况下，每个ns都会有一个sa，如果pod在创建时没有指定sa，就会使用pod所属的ns的sa<br><code>默认挂载目录：/run/secrets/kubernetes.io/serviceaccount/</code></p>
<h4 id="鉴权（Authorization）"><a href="#鉴权（Authorization）" class="headerlink" title="鉴权（Authorization）"></a>鉴权（Authorization）</h4><p>认证通过后并不意味着拥有访问资源的可能，还需鉴权后才能有访问具体对象的能力<br>上面认证过程，只是确认通信的双方都确认了对方是可信的，可以相互通信<br>而鉴权，是确定请求方有哪些资源的权限</p>
<h5 id="API-Server目前支持一下几种授权策略"><a href="#API-Server目前支持一下几种授权策略" class="headerlink" title="API Server目前支持一下几种授权策略"></a>API Server目前支持一下几种授权策略</h5><p>（通过API Server的启动参数–authorization-mode设置）</p>
<ul>
<li>AlwaysDeny：表示拒绝所有请求，一般用于测试</li>
<li>AlwaysAllow：允许接收所有请求，如果集群不需要授权流程，则可以采用该策略</li>
<li>ABAC（Attribute-Based Access Control）：基于属性的访问控制，表示使用用户配置的授权规则对用户请求进行匹配和控制</li>
<li>Webhook：通过调用外部REST服务对用户进行授权</li>
<li>RBAC（Role-Based Access Control）：基于角色的访问控制，现行默认规则</li>
</ul>
<h5 id="RBAC授权模式"><a href="#RBAC授权模式" class="headerlink" title="RBAC授权模式"></a>RBAC授权模式</h5><p>RBAC（Role-Based Access Control）：基于角色的访问控制，在k8s1.5中引入，现行版本成为默认标准，相对其他访问控制方式，拥有一下优势：</p>
<ul>
<li>对集群中的资源和非资源均拥有完整的覆盖</li>
<li>整个RBAC完全由几个API对象完成，同其他API对象一样，可以用kubectl或API进行操作</li>
<li>可以在运行时进行调整，无需重启API Server（ABAC修改完还需重启）</li>
</ul>
<ol>
<li>RBAC的API资源对象说明<br>RBAC引入了4个新的顶级资源对象：Role、ClusterRole、RoleBinding、ClusterRoleBinding，4种对象类型均可以通过kubectl与API操作<br><img src="_posts/k8sNote1/k8s_auth_rbac.png"><br>需要注意的是k8s并不会提供用户管理，那么User、Group、ServiceAccount指定的用户又是从哪里来的呢？<br>Kubernetes组件（kubectl、kube-proxy）或是其他自定义的用户在向CA申请证书时，需要提供一个证书请求文件<figure class="highlight json"><table><tr><td class="code"><pre><span class="line"># API Server会把客户端证书的CN字段作为User，把names<span class="number">.0</span>字段作为Group</span><br><span class="line"></span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;CN&quot;</span><span class="punctuation">:</span> <span class="string">&quot;admin&quot;</span><span class="punctuation">,</span> # 用户名</span><br><span class="line">    <span class="attr">&quot;hosts&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;key&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;algo&quot;</span><span class="punctuation">:</span> <span class="string">&quot;rsa&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;size&quot;</span><span class="punctuation">:</span> <span class="number">2048</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;names&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;C&quot;</span><span class="punctuation">:</span> <span class="string">&quot;CN&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;ST&quot;</span><span class="punctuation">:</span> <span class="string">&quot;HangZhou&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;L&quot;</span><span class="punctuation">:</span> <span class="string">&quot;XS&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;O&quot;</span><span class="punctuation">:</span> <span class="string">&quot;system:masters&quot;</span><span class="punctuation">,</span># 组</span><br><span class="line">        <span class="attr">&quot;OU&quot;</span><span class="punctuation">:</span> <span class="string">&quot;System&quot;</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">]</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>
kubelet使用TLS Bootstraping认证时，APIServer可以使用Bootstrap Tokens或者Token authentication file验证&#x3D;token，无论哪一种，k8s都会为token绑定一个默认的User和Group</li>
</ol>
<p>Pod使用sa认证时，service-account-token中JWT会保存User信息</p>
<p>有了用户信息，再创建一对角色&#x2F;角色绑定（集群角色&#x2F;集群角色绑定）资源对象，就可以完成权限绑定了</p>
<ol start="2">
<li>Role and ClusterRole<br>在RBAC API中，Role表示一组规则权限，权限只会增加（累加），不存在一个资源一开始就有很多权限而通过RBAC对其进行减少的操作；Role可以定义在一个ns中，如果想要跨ns则可以创建ClusterRole<figure class="highlight yml"><table><tr><td class="code"><pre><span class="line"><span class="attr">kind:</span> <span class="string">Role</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">rbac.authorization.k8s.io/v1beta1</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">default</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">pod-reader</span></span><br><span class="line"><span class="attr">rules:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">apiGroups:</span> [<span class="string">&quot;&quot;</span>] <span class="comment"># &quot;&quot; indicates the core API group</span></span><br><span class="line">  <span class="attr">resources:</span> [<span class="string">&quot;pods&quot;</span>]</span><br><span class="line">  <span class="attr">verbs:</span> [<span class="string">&quot;get&quot;</span>, <span class="string">&quot;watch&quot;</span>, <span class="string">&quot;list&quot;</span>]</span><br><span class="line">  </span><br><span class="line"><span class="string">kubectl</span> <span class="string">create</span> <span class="string">role</span> <span class="string">pod-reader</span> <span class="string">--verb=get,watch,list</span> <span class="string">--resource=pods</span></span><br></pre></td></tr></table></figure></li>
</ol>
<p>ClusterRole具有与Role相同的权限角色控制能力，不同的是ClusterRole是集群级别的，ClusterRole可以用于：</p>
<ul>
<li>集群级别的资源控制（例如node访问权限）</li>
<li>非资源型endpoints（例如&#x2F;healthz访问）</li>
<li>所有命名空间资源控制（例如pods）<figure class="highlight yml"><table><tr><td class="code"><pre><span class="line"><span class="attr">kind:</span> <span class="string">ClusterRole</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">rbac.authorization.k8s.io/v1beta1</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="comment"># &quot;namespace&quot; omitted since ClusterRoles are not namespaced</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">secret-reader</span></span><br><span class="line"><span class="attr">rules:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">apiGroups:</span> [<span class="string">&quot;&quot;</span>]</span><br><span class="line">  <span class="attr">resources:</span> [<span class="string">&quot;secrets&quot;</span>]</span><br><span class="line">  <span class="attr">verbs:</span> [<span class="string">&quot;get&quot;</span>, <span class="string">&quot;watch&quot;</span>, <span class="string">&quot;list&quot;</span>]</span><br><span class="line">  </span><br><span class="line"><span class="string">kubectl</span> <span class="string">create</span> <span class="string">clusterrole</span> <span class="string">secret-reader</span> <span class="string">--verb=get,watch,list</span> <span class="string">--resource=secrets</span></span><br></pre></td></tr></table></figure></li>
</ul>
<ol start="3">
<li>RoleBinding and ClusterRoleBinding<br>RoleBinding可以将角色中定义的权限授予用户或用户组<br>RoleBinding包含一组权限列表（subjects），权限列表中包含有不同形式的待授予权限资源类型（users，groups，or service accounts）<br>RoleBinding同样包含对被bind的role引用<br>RoleBinding适用于某个ns内授权，而ClusterRoleBinding适用于集群范围内的授权<br>rolebinding可以绑定role、clusterrole；clusterrolebinding只能绑定clusterrole</li>
</ol>
<p>将default命名空间的pod-reader Role授予jane用户，伺候jane用户在default ns中将具有pod-reader的权限</p>
<figure class="highlight yml"><table><tr><td class="code"><pre><span class="line"><span class="attr">kind:</span> <span class="string">RoleBinding</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">rbac.authorization.k8s.io/v1beta1</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">read-pods</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">default</span></span><br><span class="line"><span class="attr">subjects:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">kind:</span> <span class="string">User</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">jane</span></span><br><span class="line">  <span class="attr">apiGroup:</span> <span class="string">rbac.authorization.k8s.io</span></span><br><span class="line"><span class="attr">roleRef:</span></span><br><span class="line">  <span class="attr">kind:</span> <span class="string">Role</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">pod-reader</span></span><br><span class="line">  <span class="attr">apiGroup:</span> <span class="string">rbac.authorization.k8s.io</span></span><br></pre></td></tr></table></figure>

<p>RoleBinding同样可以引用ClusterRole来对当前ns内用户、用户组或SA进行授权，这种操作允许集群管理员在整个集群内定义一些通用的ClusterRole，然后在不通的ns中使用RoleBinding来引用</p>
<p>例如，以下RoleBinding引用了一个ClusterRole，这个ClusterROle具有整个集群内对secrets的访问权限；但是其授权用户dave只能访问development空间中的secrets（因为RoleBinding定义在develop命名空间）</p>
<figure class="highlight yml"><table><tr><td class="code"><pre><span class="line"><span class="comment"># This role binding allows &quot;dave&quot; to read secrets in the &quot;deployment&quot; namespcae.</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">RoleBinding</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">rbac.authorization.k8s.io/v1beta1</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">read-secrets</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">development</span> <span class="comment"># This only grants permissions within the &quot;development&quot; namespace.</span></span><br><span class="line"><span class="attr">subjects:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">kind:</span> <span class="string">User</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">dave</span></span><br><span class="line">  <span class="attr">apiGroup:</span> <span class="string">rbac.authorization.k8s.io</span></span><br><span class="line"><span class="attr">roleRef:</span></span><br><span class="line">  <span class="attr">kind:</span> <span class="string">ClusterRole</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">secret-reader</span></span><br><span class="line">  <span class="attr">apiGroup:</span> <span class="string">rbac.authorization.k8s.io</span></span><br></pre></td></tr></table></figure>

<p>使用ClusterRoleBinding可以对整个集群中的所有ns资源权限进行授权；以下ClusterRolebinding样例展示了授权manager组内所有用户在全部ns中对secrets进行访问</p>
<figure class="highlight yml"><table><tr><td class="code"><pre><span class="line"><span class="comment"># This cluster role binding allows anyone in the &quot;manager&quot; group to read secrets in any namespace</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ClusterRoleBinding</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">rbac.authorization.k8s.io/v1beta1</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">read-secrets-global</span></span><br><span class="line"><span class="attr">subjects:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">kind:</span> <span class="string">Group</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">manager</span></span><br><span class="line">  <span class="attr">apiGroup:</span> <span class="string">tbac.authorization.k8s.io</span></span><br><span class="line"><span class="attr">roleRef:</span></span><br><span class="line">  <span class="attr">kind:</span> <span class="string">ClusterRole</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">secret-reader</span></span><br><span class="line">  <span class="attr">apiGroup:</span> <span class="string">rbac.authorization.k8s.io</span></span><br></pre></td></tr></table></figure>

<ol start="4">
<li>Resources<br>k8s集群内一些资源一般以其名称字符串来表示，这些字符串一般会在API的URL地址中出现<br>同时某些资源也会包含子资源，例如logs资源就属于pods的子资源，API中URL样例如下<blockquote>
<p>GET &#x2F;api&#x2F;v1&#x2F;namespaces&#x2F;{namespace}&#x2F;pods&#x2F;{name}&#x2F;log</p>
</blockquote>
</li>
</ol>
<p>如果要在RBAC授权模型中控制这些子资源的访问权限，可以通过 &#x2F; 分隔符来实现，以下是一个定义pods子资源logs访问权限的Role定义样例</p>
<figure class="highlight yml"><table><tr><td class="code"><pre><span class="line"><span class="attr">kind:</span> <span class="string">Role</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">rbac.authorization.k8s.io/v1beta1</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">default</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">pod-and-pod-logs-reader</span></span><br><span class="line"><span class="attr">rules:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">apiGroups:</span> [<span class="string">&quot;&quot;</span>]</span><br><span class="line">  <span class="attr">resources:</span> [<span class="string">&quot;pods&quot;</span>, <span class="string">&quot;pods/log&quot;</span>]</span><br><span class="line">  <span class="attr">verbs:</span> [<span class="string">&quot;get&quot;</span>, <span class="string">&quot;list&quot;</span>]</span><br></pre></td></tr></table></figure>

<ol start="5">
<li>to Subjects<br>RoleBinding和ClusterRoleBinding可以将Role绑定到Subjects；<br>Subjects可以是groups、users或者service accounts</li>
</ol>
<p>Subjects中Users使用字符串表示，它可以是一个普通的名字字符串，如”alice”；<br>也可以是email格式的邮箱地址，如”<a href="mailto:&#106;&#97;&#100;&#101;&#64;&#113;&#x71;&#x2e;&#99;&#x6f;&#x6d;">&#106;&#97;&#100;&#101;&#64;&#113;&#x71;&#x2e;&#99;&#x6f;&#x6d;</a>“<br>甚至是一组字符串形式的数字ID<br>但是Users的前缀system:是系统保留的，集群管理员应该确保普通用户不会使用这个前缀格式</p>
<p>Groups书写格式与Users相同，都为一个字符串，并且没有特定的格式要求；同样system:前缀为系统保留</p>
<h5 id="实践"><a href="#实践" class="headerlink" title="实践"></a>实践</h5><p><img src="_posts/k8sNote1/k8s_auth_rbac_exam.png"><br>创建一个用户只能管理dev空间</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 创建用户</span></span><br><span class="line">useradd devuser</span><br><span class="line">passwd devuser</span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建devuser的证书请求</span></span><br><span class="line"><span class="built_in">cd</span> /user/local/install-k8s</span><br><span class="line"><span class="built_in">mkdir</span> -p cert/devuser</span><br><span class="line"><span class="built_in">cd</span> cert/devuser &amp;&amp; vim devuser-csr.json</span><br><span class="line">&#123;</span><br><span class="line">    <span class="string">&quot;CN&quot;</span>: <span class="string">&quot;devuser&quot;</span>,</span><br><span class="line">    <span class="string">&quot;hosts&quot;</span>: [], <span class="comment"># 不写代表所有</span></span><br><span class="line">    <span class="string">&quot;key&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;algo&quot;</span>: <span class="string">&quot;rsa&quot;</span>,</span><br><span class="line">        <span class="string">&quot;size&quot;</span>: 2048</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="string">&quot;names&quot;</span>: [&#123;</span><br><span class="line">        <span class="string">&quot;C&quot;</span>: <span class="string">&quot;CN&quot;</span>,</span><br><span class="line">        <span class="string">&quot;ST&quot;</span>: <span class="string">&quot;BeiJing&quot;</span>,</span><br><span class="line">        <span class="string">&quot;L&quot;</span>: <span class="string">&quot;BeiJing&quot;</span>,</span><br><span class="line">        <span class="string">&quot;O&quot;</span>: <span class="string">&quot;k8s&quot;</span>,</span><br><span class="line">        <span class="string">&quot;OU&quot;</span>: <span class="string">&quot;System&quot;</span></span><br><span class="line">    &#125;]</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 下载证书生成工具</span></span><br><span class="line">wget https://pkg.cfssl.org/R1.2/cfssl_linux-amd64</span><br><span class="line"><span class="built_in">mv</span> cfssl_linux-amd64 /usr/local/bin/cfssl</span><br><span class="line"></span><br><span class="line">wget https://pkg.cfssl.org/R1.2/cfssljson_linux-amd64</span><br><span class="line"><span class="built_in">mv</span> cfssljson_linux-amd64 /usr/local/bin/cfssljson</span><br><span class="line"></span><br><span class="line">wget https://pkg.cfssl.org/R1.2/cfssl-certinfo_linux-amd64</span><br><span class="line"><span class="built_in">mv</span> cfssl-certinfo_linux-amd64 /usr/local/bin/cfssl-certinfo</span><br><span class="line"></span><br><span class="line"><span class="built_in">cd</span> /usr/local/bin/</span><br><span class="line"><span class="built_in">chmod</span> a+x *</span><br><span class="line"></span><br><span class="line"><span class="built_in">cd</span> /etc/kubernetes/pki/ <span class="comment"># 存放的都是密钥信息</span></span><br><span class="line">cfssl gencert -ca=ca.crt -ca-key=ca.key -profile=kubernetes /usr/local/install-k8s/cert/devuser/devuser-csr.json | cfssljson -bare devuser</span><br><span class="line"></span><br><span class="line"><span class="comment"># 设置集群参数</span></span><br><span class="line"><span class="built_in">cd</span> /usr/local/install-k8s/cert/devuser</span><br><span class="line"><span class="built_in">export</span> KUBE_APISERVER=<span class="string">&quot;https://192.168.66.10:6443&quot;</span></span><br><span class="line">kubectl config set-cluster kubernetes \</span><br><span class="line">--certificate-authority=/etc/kubernetes/pki/ca.crt \</span><br><span class="line">--embed-certs=<span class="literal">true</span> \</span><br><span class="line">--server-<span class="variable">$&#123;KUBE APISERVER&#125;</span> \</span><br><span class="line">--kubeconfig=devuser.kubeconfig</span><br><span class="line"><span class="built_in">cat</span> devuser.kubeconfig</span><br><span class="line"></span><br><span class="line"><span class="comment">#设置客户端认证参数</span></span><br><span class="line">kubectl config set-credentials devuser \</span><br><span class="line">--client-certificate=/etc/kubernetes/pki/devuser.pem \ <span class="comment"># 指定证书</span></span><br><span class="line">--client-key=/etc/kubernetes/pki/devuser -key.pem \ <span class="comment"># 指定私钥</span></span><br><span class="line">--embed-certs=<span class="literal">true</span> \ <span class="comment"># 开启证书认证</span></span><br><span class="line">--kubeconfig=devuser.kubeconfig <span class="comment"># 写入kubeconfig文件</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#设置上下文参数（绑定至某一个空间）</span></span><br><span class="line">kubectl create namespace dev</span><br><span class="line">kubectl config <span class="built_in">set</span> -context kubernetes \</span><br><span class="line">--cluster=kubernetes \ <span class="comment"># 默认集群名称</span></span><br><span class="line">--user=devuser \</span><br><span class="line">--namespace=dev \</span><br><span class="line">--kubeconfig=devuser.kubeconfig</span><br><span class="line"></span><br><span class="line"><span class="comment"># devuser可以在dev中拥有admin权限</span></span><br><span class="line">kubectl create rolebinding devuser-admin-binding --clusterrole=admin --user=devuser --namespace=dev</span><br><span class="line"></span><br><span class="line"><span class="built_in">cp</span> -f ./devuser.kubeconfig /home/.kube/config</span><br><span class="line"><span class="built_in">chown</span> devuser:devuser /home/.kube/config</span><br><span class="line"></span><br><span class="line"><span class="comment">#设置默认上下文（切换）</span></span><br><span class="line">kubectl config use-context kubernetes --kubeconfig=config</span><br><span class="line"></span><br><span class="line">kubectl run nginx --image=hub.jade.com/library/myapp:v2</span><br><span class="line">kubectl get pod会展示刚刚创建的nginx</span><br><span class="line">默认nv是dev，查看default无权限</span><br></pre></td></tr></table></figure>

<h4 id="准入控制（Admission-Control）"><a href="#准入控制（Admission-Control）" class="headerlink" title="准入控制（Admission Control）"></a>准入控制（Admission Control）</h4><p>准入控制是API Server的插件集合，通过添加不通的插件，实现额外的准入控制规则。甚至于APIServer的一些主要的功能都需要通过Admission Controllers实现，比如SA</p>
<p>官方文档上有一份针对不同版本的准入控制器推荐列表，其中最新的1.14的推荐列表是</p>
<blockquote>
<p>NamespaceLifecycle,LimitRanger,ServiceAccount,DefaultStorageClass,DefaultTolerationSeconds,MutatingAdmissionWebhook,ValidatingAdmissionWebhook,ResourceQuota</p>
</blockquote>
<p>列举几个插件的功能：</p>
<ul>
<li>NamespaceLifecycle：防止在不存在的namespace上创建对象，防止删除系统预置ns，删除ns时，连带删除它的所有资源对象</li>
<li>LimitRanger：确保请求的资源不会超过资源所在的ns的LimitRange的限制</li>
<li>ServiceAccount：实现了自动化添加ServiceAccount</li>
<li>ResourceQuota：确保请求的资源不会超过资源的ResourceQuota限制</li>
</ul>
<hr>
<h2 id="Helm"><a href="#Helm" class="headerlink" title="Helm"></a>Helm</h2><h4 id="定义"><a href="#定义" class="headerlink" title="定义"></a>定义</h4><p>没使用helm之前，向k8s部署应用，我们要依次部署deployment、svc等，步骤较繁琐。<br>况且随着很多项目微服务化，复杂的应用在容器中部署以及管理显得较为复杂，helm通过打包的方式，支持发布的版本管理和控制，很大程度简化了k8s应用的部署和管理</p>
<p>helm本质就是让k8s的应用管理（deploy、svc等）可配置，能动态生产。通过动态生产k8s资源清单文件（deploy.yaml、svc.yaml），然后调用kubectl自动执行k8s资源部署</p>
<p>Helm是官方提供的类似于YUM的包管理器，是部署环境的流程封装。</p>
<p>Helm有两个重要的概念：chart和release</p>
<h5 id="chart"><a href="#chart" class="headerlink" title="chart"></a>chart</h5><p>是创建一个应用的信息集合，包括各种k8s对象的配置模板、参数定义、依赖关系、文档说明等。<br>chart是应用部署的自包含逻辑单元。可以将chart想象成apt、yum中的软件安装包</p>
<h5 id="release"><a href="#release" class="headerlink" title="release"></a>release</h5><p>是chart的运行实例，代表了一个正在运行的应用<br>当chart被安装到k8s集群，就生产一个release<br>chart能够多次安装到同一个集群，每次安装都是一个release</p>
<h4 id="组件"><a href="#组件" class="headerlink" title="组件"></a>组件</h4><p>Helm包含两个组件：Helm客户端和Tiller服务器，如下图所示<br><img src="_posts/k8sNote1/k8s_heml.png"><br><u>Helm客户端<u>负责chart和release的创建和管理以及和Tiller的交互<br><u>Tiller服务器<u>运行在k8s集群中，处理Helm客户端的请求，与k8s API Server交互</u></u></u></u></p>
<h4 id="Helm部署"><a href="#Helm部署" class="headerlink" title="Helm部署"></a>Helm部署</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 下载helm命令行工具到master节点的/usr/local/bin下，这里下载2.13.1版本</span></span><br><span class="line">ntpdate ntp1.aliyun.com</span><br><span class="line">wget https://storage.googleapis.com/kubernetes-helm/helm-v2.13.1-linux-amd64.tar.gz</span><br><span class="line"><span class="built_in">cd</span> /usr/local/install-k8s</span><br><span class="line"><span class="built_in">mkdir</span> helm</span><br><span class="line"><span class="built_in">mv</span> helm-v2.13.1-linux-amd64.tar.gz ./helm</span><br><span class="line"><span class="built_in">cd</span> helm</span><br><span class="line">tar -zxvf helm-v2.13.1-linux-amd64.tar.gz</span><br><span class="line"><span class="built_in">cd</span> linux-amd64/</span><br><span class="line"><span class="built_in">cp</span> helm /usr/local/bin/</span><br><span class="line"><span class="built_in">chmod</span> a+x /usr/local/bin/helm</span><br></pre></td></tr></table></figure>

<p>为了安装服务端tiller，还需要在这台机器上配置好kubectl工具和kubeconfig文件，确保kubectl工具可以在这台机器上访问apiserver且正常使用，这里的node1节点已经配置好了kubectl</p>
<p>因为kubernetes APIServer开启了RBAC访问控制，所以需要创建tiller使用的service account:tiller并分配合适的角色给它。详细内容可以查看helm文档中的Role-based Access Control 这里简单起见直接分配cluster-admin这个集群内置的ClusterRole给它。创建rbac-config.yaml文件</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">vim rbac.yaml</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: ServiceAccount</span><br><span class="line">metadata:</span><br><span class="line">  name: tiller</span><br><span class="line">  namespace: kube-system</span><br><span class="line">---</span><br><span class="line">apiVersion: rbac.authorization.k8s.io/vlbeta1</span><br><span class="line">kind: ClusterRoleBinding</span><br><span class="line">metadata:</span><br><span class="line">  name: tiller</span><br><span class="line">roleRef:</span><br><span class="line">  apiGroup: rbac.authorization.k8s.io</span><br><span class="line">  kind: ClusterRole</span><br><span class="line">  name: cluster-admin</span><br><span class="line">subjects:</span><br><span class="line">- kind: ServiceAccount</span><br><span class="line">  name: tiller</span><br><span class="line">  namespace: kube-system</span><br><span class="line">  </span><br><span class="line">kubectl create -f rbac-config.yaml</span><br><span class="line">serviceaccount/tiller created</span><br><span class="line">clusterrolebinding.rbac.authorization.k8s.io/tiller created</span><br><span class="line"></span><br><span class="line">helm init --service-account tiller --skip-refresh</span><br><span class="line"></span><br><span class="line"><span class="comment"># tiller默认被部署在k8s集群中的kube-system这个ns下</span></span><br><span class="line">kubectl get pod -n kube-system -I app=helm</span><br><span class="line">NAME                          READY STATUS  RESTARTSAGE</span><br><span class="line">tiller-deploy-c4fd4cd68-dwkhv  1/1  Running  83s</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看当前版本信息</span></span><br><span class="line">helm version</span><br><span class="line">Client: &amp;version.Vension&#123;SemVer:<span class="string">&quot;v2.13.1&quot;</span>，GitCommit;<span class="string">&quot;618447cbf203d147601b4b9bd7f8c37a5d39fbb4&quot;</span>, GitTreeState:<span class="string">&quot;clean&quot;</span>&#125;</span><br><span class="line">Server: &amp;version.Vension&#123;SemVer:<span class="string">&quot;v2.13.1&quot;</span>，GitCommit:<span class="string">&quot;618447cbf203d147601b4b9bd7f8c37a5d39fbb4&quot;</span>, GitTreeState:<span class="string">&quot;clean&quot;</span>&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 页面查看helm仓库</span></span><br><span class="line">helm.sh</span><br><span class="line">hub.helm.sh</span><br></pre></td></tr></table></figure>

<h4 id="Helm自定义模板"><a href="#Helm自定义模板" class="headerlink" title="Helm自定义模板"></a>Helm自定义模板</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 创建文件夹</span></span><br><span class="line">$ <span class="built_in">mkdir</span> ./hello-world</span><br><span class="line">$ <span class="built_in">cd</span> ./hello-world</span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建自描述文件 Chart.yaml ，这个文件必须有 name 和 version 定义</span></span><br><span class="line">$ <span class="built_in">cat</span> &lt;&lt;<span class="string">&#x27;EOF&#x27;</span> &gt; ./Chart.yaml</span><br><span class="line">name: hel1o-world</span><br><span class="line">version: 1.0.@</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建模板文件，用于生成 Kubernetes 资源清单 (manifests)</span></span><br><span class="line">$ <span class="built_in">mkdir</span> ./templates</span><br><span class="line">$ <span class="built_in">cat</span> &lt;&lt;<span class="string">&#x27;EOF&#x27;</span> &gt; ./templates/deployment .yaml</span><br><span class="line">apiVersion: extensions/vibeta1</span><br><span class="line">kind: Deployment</span><br><span class="line">metadata:</span><br><span class="line">  name: hello-world</span><br><span class="line">spec:</span><br><span class="line">  replicas: 1</span><br><span class="line">  template:</span><br><span class="line">    metadata :</span><br><span class="line">      labels:</span><br><span class="line">        app: hello-world</span><br><span class="line">    spec:</span><br><span class="line">      containers:</span><br><span class="line">      - name: hello-world</span><br><span class="line">        image: hub.atguigu.com/library/myapp:v1</span><br><span class="line">        ports:</span><br><span class="line">        - containerPort: 80</span><br><span class="line">          protocol: TCP</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line">$ <span class="built_in">cat</span> &lt;&lt;<span class="string">&#x27;EOF&#x27;</span> &gt; ./templates/service.yaml</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Service</span><br><span class="line">metadata:</span><br><span class="line">  name: hello-world</span><br><span class="line">spec:</span><br><span class="line">  <span class="built_in">type</span>: NodePort</span><br><span class="line">  ports:</span><br><span class="line">  - port: 80</span><br><span class="line">    targetPort: 80</span><br><span class="line">    protocol: TCP</span><br><span class="line">  selector:</span><br><span class="line">    app: hello-world</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 使用命令 helm install RELATIVE PATH TO_CHART 创建一次Release</span></span><br><span class="line">$ helm install .</span><br><span class="line"></span><br><span class="line"><span class="comment"># 列出已经部署的 Release</span></span><br><span class="line">$ helm <span class="built_in">ls</span></span><br><span class="line"><span class="comment"># 获取pod发现镜像下载失败，修改为本地镜像后更新helm</span></span><br><span class="line">kubectl get pod </span><br><span class="line"><span class="comment"># 更新helm</span></span><br><span class="line">$ helm uograde nobby-eel .</span><br><span class="line"><span class="comment"># 查看helm历史</span></span><br><span class="line">$ helm <span class="built_in">history</span> nobby-eel</span><br><span class="line"><span class="comment">#查询一个特定的 Release 的状态</span></span><br><span class="line">$ helm status <span class="variable">$&#123;RELEASE_NAME&#125;</span></span><br><span class="line"><span class="comment"># 移除所有与这个 Release 相关的 Kubernetes 资源</span></span><br><span class="line">$ helm delete nobby-eel</span><br><span class="line"><span class="comment"># helm rollback $&#123;RELEASE_NAME&#125; $&#123;REVISION_NUMBER&#125;</span></span><br><span class="line">$ helm rollback nobby-eel 1</span><br><span class="line"><span class="comment"># 使用 helm delete --purge $&#123;RELEASE_NAME&#125; 移除所有与指定 Release 相关的 Kubernetes 资源和所有这个Release 的记录</span></span><br><span class="line">$ helm delete --purge nobby-eel</span><br><span class="line">$ helm <span class="built_in">ls</span> --deleted</span><br></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment">## 灵活使用helm，使用配置文件、引用；更改配置文件即可修改镜像 或者通过--set的方式指定镜像</span></span><br><span class="line"><span class="comment"># 1.配置体现在配置文件 values.yaml</span></span><br><span class="line">$ <span class="built_in">cat</span> &lt;&lt;<span class="string">&#x27;EOF&#x27;</span> &gt; ./values.yaml</span><br><span class="line">image:</span><br><span class="line">  repository: hub.jade.com/library/myapp</span><br><span class="line">  tag: <span class="string">&#x27;v1&#x27;</span></span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line"><span class="comment"># 这个文件中定义的值，在模板文件中可以通过 .VAlues对象访问到</span></span><br><span class="line">$ <span class="built_in">cat</span> &lt;&lt;<span class="string">&#x27;EOF&#x27;</span> &gt; ./templates/deployment.yaml</span><br><span class="line">apiVersion: extensions/vibeta1</span><br><span class="line">kind: Deployment</span><br><span class="line">metadata:</span><br><span class="line">  name: hello-world</span><br><span class="line">spec :</span><br><span class="line">  replicas: 1</span><br><span class="line">  template:</span><br><span class="line">    metadata :</span><br><span class="line">      labels :</span><br><span class="line">        app: hello-world</span><br><span class="line">    spec:</span><br><span class="line">      containers:</span><br><span class="line">      - name: hello-world</span><br><span class="line">        image: (( .Values.image.repository ]&#125;:&#123;&#123; .Values.image.tag &#125;&#125;</span><br><span class="line">        ports :</span><br><span class="line">        - containerPort: <span class="number">888</span></span><br><span class="line">          protocol: TCP</span><br><span class="line">EOF</span><br><span class="line"># 修改版本为v2后更新</span><br><span class="line">$ helm uograde nobby-eel .</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># <span class="number">2</span>.在 values.yam1 中的值可以被部署 release 时用到的参数 --values YAML_FILE_PATH 或 --setkey1=value1，key2=value2 覆盖掉</span><br><span class="line">$ helm install --set image.tag=&#x27;v3&quot; .</span><br><span class="line">helm upgrade -f values.yaml nobby-eel .</span><br><span class="line">or</span><br><span class="line"># 覆盖版本为v3并直接升级</span><br><span class="line">$ helm uograde nobby-eel --set image.tag=&#x27;v3&quot; .</span><br></pre></td></tr></table></figure>

<h5 id="Debug"><a href="#Debug" class="headerlink" title="Debug"></a>Debug</h5><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 使用模板动态生成K8s资源清单，非常需要能提前预览生成的结果。</span></span><br><span class="line"><span class="comment"># 使用--dry-run --debug 选项来打印出生成的清单文件内容，而不执行部署</span></span><br><span class="line">helm install .--dry-run --debug --<span class="built_in">set</span> image.tag=latest</span><br></pre></td></tr></table></figure>

<h4 id="使用Helm部署dashboard"><a href="#使用Helm部署dashboard" class="headerlink" title="使用Helm部署dashboard"></a>使用Helm部署dashboard</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="built_in">cd</span> /usr/local/install-k8s/plugin</span><br><span class="line"><span class="built_in">mkdir</span> dashboard &amp;&amp; <span class="built_in">cd</span> dashboard</span><br><span class="line"><span class="comment"># 更新chart仓库</span></span><br><span class="line">helm repo update</span><br><span class="line"><span class="comment"># 查看</span></span><br><span class="line">helm repo list</span><br><span class="line"><span class="comment"># 下载</span></span><br><span class="line">helm fetch stable/kubernetes-dashboard</span><br><span class="line"></span><br><span class="line"><span class="comment"># kubernetes-dashboard.yaml</span></span><br><span class="line">vim kubernetes-dashboard.yaml</span><br><span class="line">image:</span><br><span class="line">  repository: k8s.gcr.io/kubernetes-dashboard-amd64</span><br><span class="line">  tag: v1.19.1</span><br><span class="line">ingress:</span><br><span class="line">  enabled: <span class="literal">true</span></span><br><span class="line">  hosts:</span><br><span class="line">  - k8s.frognew.com</span><br><span class="line">  annotations:</span><br><span class="line">    nginx.ingress.kubernetes.io/ssl-redirect: <span class="string">&quot;true&quot;</span></span><br><span class="line">    nginx.ingress.kubernetes.io/backend-protocol: <span class="string">&quot;HTTPS&quot;</span></span><br><span class="line">  tls:</span><br><span class="line">  - secretName: frognew-com-tls-secret</span><br><span class="line">    hosts:</span><br><span class="line">    - k8s.frognew.com</span><br><span class="line">rbac:</span><br><span class="line">  clusterAdminRole: <span class="literal">true</span></span><br></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">helm install . -n kubernetes-dashboard --namespace kube-system -f kubernetes-dashboard.yaml</span><br></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 查询dashboard token以便登录dashboard</span></span><br><span class="line">kubectl -n kube-system get secret | grep kubernetes-dashboard-token</span><br><span class="line">kubernetes .io/service-account-token   3   3m7s kubectl describe -n kube-system</span><br><span class="line">secret/kubernetes-dashboard-token-pkm2s Name:kubernetes-dashboard-token-pkm2sNamespace:kube-system Labels:&lt;none&gt; Annotations: kubernetes.io/service-account.name:kubernetes-dashboard kubernetes,io/service-account,uid: 2f0781dd-156a-11e9-b0f0-080027bb7c43Type: kubernetes.io/service-account-token Data ==== ca.crt:1025 bytes namespace: 11 bytes</span><br><span class="line">token:</span><br><span class="line">eyJhbGci0iJSUzI1NiIsImtpZCI6Ii9.eyJpc3Mi0iJrdwJlcm51dGVzL3N1cnZpy2VhY2NvdW50Iiwia3VizXJuzXRlcy5pby9zzXJ2aWNIYWNjb3VudC9uYW11c3BhY2Ui0iJrdWJ1LXN5c3RIbSIsImt1YmVybmV@ZXMuaM8vc2VydmljzWFjY291bn0Vc2VjcmV9Lm5hbwUi0iJrdWlcm5ldGVzLWRhc2hib2FyZC10b2tlbi1wa20ycyIsImt1YmVybmV@zXMuaW8vc2VydmljzwjY291bnOvc2VydmljZS1hY2NvdW50Lm5hbwUi0iJrdWJlcm51dGZLWRhc2hib2FyzcIsImt1YmVybmV@zXMuaW8vc2VydmliZWFiY291bn0vc2VvamliZS1Y2NvdM50LnVZCI6IJmMDC4MRKLTE1NmEMTF10S1MGYWLTA4MDAVN2JiN2MOMVISIn1YiI6InN5C3RIbTpzzXJ2aMN1YWNjb3VudDprdWJ1LXN5C3RIbTprdwJlcm51dGVzLWRhc2hib2FyzCJ9.24ad6ZgZMxdydpwlmYAiMxZ9VSIN7dDR706-RLWOqC81ajXoQKHAyrEGpIonfld3ggbE0x08nis skpmlkQra72-9X6sBPoBygIKyTs083BO1ME2sfoJemWDOHazwsCiySOax-bUlg9HgH2vEXzpFuSS6Sv7RbfzLX1EuggNoC4MfA4E2hF10X m18iAKx-49y1B00e5FGWyCyBSi1TDZpVs44H5gIvsGK2kcvi0JT4oHXtWjjQBKLIWL7xxyRCSE4HmUZT2StIHn0w1X7IEIB0oBX4mPg2 xNGnqwcu-80ERU9IOgAAE2cZav3b50:IPrcxrVOukYRIUMA</span><br></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">kubectl edit svc kubernetes-dashboard -n kube-system</span><br><span class="line">修改 ClusterIP 为 NodePort</span><br></pre></td></tr></table></figure>

<h4 id="使用Helm部署metrics-server"><a href="#使用Helm部署metrics-server" class="headerlink" title="使用Helm部署metrics-server"></a>使用Helm部署metrics-server</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># metrics-server.yaml</span></span><br><span class="line">args:</span><br><span class="line">- --logtostderr</span><br><span class="line">- --kubelet-insecure-tls</span><br><span class="line">- --kubelet-preferred-address-types=InternalIp</span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">helm install stable/metrics-server -n metrics-server --namespace kubesystem -f metrics-server.yaml</span><br></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 使用下面的命令可以获取到关于集群节点基本的指标信息</span></span><br><span class="line">kubectl top node</span><br><span class="line">NAME     CPU(cores)  CPU%   MEMORY(bytes)  MEMORY%</span><br><span class="line">node1    65m         32%    1276Mi         73%</span><br><span class="line">node2    73m         3%     527Mi          30%</span><br><span class="line"></span><br><span class="line">kubectl top pod --all-namespaces</span><br></pre></td></tr></table></figure>

<h4 id="使用Helm部署prometheus"><a href="#使用Helm部署prometheus" class="headerlink" title="使用Helm部署prometheus"></a>使用Helm部署prometheus</h4><p>metrics-server和prometheus只能选一种使用，因为prometheus集成了metrics-server<br>[prometheus github地址]：<a target="_blank" rel="noopener" href="https://github.com/coreos/kube-prometheus">https://github.com/coreos/kube-prometheus</a></p>
<h5 id="组件说明"><a href="#组件说明" class="headerlink" title="组件说明"></a>组件说明</h5><ul>
<li>MetricServer：是k8s集群资源使用情况的聚合器，收集数据给k8s集群内使用，如kubectl，hpa，scheduler等</li>
<li>PrometheusOperator：是一个系统监测和警报工具箱，用来存储监控数据</li>
<li>NodeExporter：用于各node的关键度量指标状态数据</li>
<li>KubeStateMetrics：收集k8s集群内资源对象数据，制定告警规则</li>
<li>Prometheus：采用pull方式收集apiserver，scheduler，controller-manager，kubelet组件数据，通过http协议传输</li>
<li>Grafana：是可视化数据统计和监控平台</li>
</ul>
<h5 id="部署"><a href="#部署" class="headerlink" title="部署"></a>部署</h5><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="built_in">cd</span> /usr/local/install-k8s/plugin</span><br><span class="line"><span class="built_in">mkdir</span> prometheus &amp;&amp; <span class="built_in">cd</span> prometheus</span><br><span class="line"></span><br><span class="line"><span class="comment"># 下载prometheus</span></span><br><span class="line">git <span class="built_in">clone</span> https://github.com/coreos/kube-prometheus.git</span><br><span class="line"><span class="built_in">cd</span> kube-prometheus/mainfests</span><br><span class="line"></span><br><span class="line"><span class="comment"># 修改grafana-service.yaml文件，使用nodeport方式访问grafana：</span></span><br><span class="line">vim grafana-service.yaml</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Service</span><br><span class="line">metadata:</span><br><span class="line">  name: grafana</span><br><span class="line">  namespace: monitoring</span><br><span class="line">spec:</span><br><span class="line">  <span class="built_in">type</span>: NodePort  <span class="comment"># 添加内容</span></span><br><span class="line">  ports:</span><br><span class="line">  - name: http</span><br><span class="line">    port: 3000</span><br><span class="line">    targetPort: http</span><br><span class="line">    nodePort: 30100  <span class="comment"># 添加内容</span></span><br><span class="line">  selector:</span><br><span class="line">    app: grafana</span><br><span class="line">    </span><br><span class="line"><span class="comment"># 修改prometheus-service.yaml，改为nodeport</span></span><br><span class="line">vim prometheus-service.yaml</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Service</span><br><span class="line">metadata:</span><br><span class="line">  labels:</span><br><span class="line">    prometheus: k8s</span><br><span class="line">  name: prometheus-k8s</span><br><span class="line">  namespace: monitoring</span><br><span class="line">spec:</span><br><span class="line">  <span class="built_in">type</span>: NodePort  <span class="comment"># 添加内容</span></span><br><span class="line">  ports:</span><br><span class="line">  - name: web</span><br><span class="line">    port: 9090</span><br><span class="line">    targetPort: web</span><br><span class="line">    nodePort: 30200  <span class="comment"># 添加内容</span></span><br><span class="line">  selector:</span><br><span class="line">    app: prometheus</span><br><span class="line">    prometheus: k8s</span><br><span class="line">    </span><br><span class="line"><span class="comment"># 修改alertmanager-service.yaml，改为ndeport</span></span><br><span class="line">vim alertmanager-service.yaml</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Service</span><br><span class="line">metadata:</span><br><span class="line">  labels:</span><br><span class="line">    alertmanager: main</span><br><span class="line">  name: alertmanager-main</span><br><span class="line">  namespace: monitoring</span><br><span class="line">spec:</span><br><span class="line">  <span class="built_in">type</span>: NodePort  <span class="comment"># 添加内容</span></span><br><span class="line">  ports:</span><br><span class="line">  - name: web</span><br><span class="line">    port: 9093</span><br><span class="line">    targetPort: web</span><br><span class="line">    nodePort: 30300  <span class="comment"># 添加内容</span></span><br><span class="line">  selector:</span><br><span class="line">    alertmanager: main</span><br><span class="line">    app: alertmanager</span><br><span class="line">    </span><br><span class="line"><span class="comment"># 部署（部署前可以先导入要用的镜像）</span></span><br><span class="line">kubectl apply -f ../manifests/</span><br><span class="line"><span class="comment"># 查看</span></span><br><span class="line">kubectl get pod -n monitoring</span><br><span class="line">kubectl top node</span><br><span class="line">kubectl get svc --all-namespaces</span><br></pre></td></tr></table></figure>

<h5 id="Horizontal-Pod-Autoscaling"><a href="#Horizontal-Pod-Autoscaling" class="headerlink" title="Horizontal Pod Autoscaling"></a>Horizontal Pod Autoscaling</h5><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># Horizontal Pod Autoscaling 可以根据CPU利用率自动伸缩一个Replication Controller、Deployment或者Replica Set中的Pod数量</span></span><br><span class="line"><span class="comment"># hpa-example镜像：谷歌做的hpa测试镜像，基于php，非常消耗资源的应用程序，通过循环调用造成资源占用，来演示hpa扩展</span></span><br><span class="line">kubectl run php-apache --image=gcr.io/google_containers/hpa-example --requests=cpu=200m --expose --port=80</span><br><span class="line"></span><br><span class="line">kubectl top pod php-apache-2342343-5df</span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建HPA控制器</span></span><br><span class="line">kubectl autoscale deployment php-apache --cpu-percent=50 --min=1 --max=10</span><br><span class="line"><span class="comment"># 阈值 cpu利用率一旦超过50就开始创建新的pod，最大10个，cpu利用率减少会回收（回收较慢），最少1个</span></span><br><span class="line">kubectl get hpa</span><br><span class="line"></span><br><span class="line"><span class="comment"># 增加负载，查看负载节点数目</span></span><br><span class="line">kubectl run -i --<span class="built_in">tty</span> load-generator --image=busybox /bin/sh</span><br><span class="line"><span class="keyword">while</span> <span class="literal">true</span>; <span class="keyword">do</span> wget -1 -O- https://php-apache.default.svc.cluster.local; <span class="keyword">done</span></span><br><span class="line"><span class="comment"># 新开窗口</span></span><br><span class="line">kubectl get hpa -w</span><br><span class="line">kubectl get pod -w</span><br></pre></td></tr></table></figure>

<h5 id="资源限制-Pod"><a href="#资源限制-Pod" class="headerlink" title="资源限制 - Pod"></a>资源限制 - Pod</h5><p>k8s对资源的限制实际上是通过cgroup来控制的，cgroup是容器的一组用来控制内核如何运行进程的相关属性集合。针对内存、CPU和各种设备都有对应的cgroup</p>
<p>默认情况下，pod运行没有cpu和内存的限额。这意味着系统中的任何pod将能够像执行该pod所在的节点一样，消耗足够多的cpu和内存。一般会针对某些应用的pod资源进行资源限制，这个资源限制是通过resources的requests和limits来实现</p>
<figure class="highlight yml"><table><tr><td class="code"><pre><span class="line"><span class="attr">spec:</span></span><br><span class="line">    <span class="attr">containers:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">image:</span> <span class="string">xxxx</span></span><br><span class="line">      <span class="attr">imagePullPolicy:</span> <span class="string">Always</span></span><br><span class="line">      <span class="attr">name :</span> <span class="string">auth</span></span><br><span class="line">      <span class="attr">ports:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">8888</span></span><br><span class="line">        <span class="attr">protocol:</span> <span class="string">TCP</span></span><br><span class="line">      <span class="attr">resources:</span></span><br><span class="line">        <span class="attr">limits:</span></span><br><span class="line">          <span class="attr">cpu:</span> <span class="string">&quot;4&quot;</span></span><br><span class="line">          <span class="attr">memory:</span> <span class="string">2Gi</span></span><br><span class="line">      <span class="attr">requests :</span></span><br><span class="line">          <span class="attr">cpu:</span> <span class="string">250m</span></span><br><span class="line">          <span class="attr">memory:</span> <span class="string">250Mi</span></span><br></pre></td></tr></table></figure>
<p>requests要分配的资源，limits为最高请求的资源值。可以简单理解为初始值和最大值</p>
<h5 id="资源限制-名称空间"><a href="#资源限制-名称空间" class="headerlink" title="资源限制 - 名称空间"></a>资源限制 - 名称空间</h5><figure class="highlight yml"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 1.计算资源配额</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ResourceQuota</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">compute-resources</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">spark-cluster</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">hard:</span></span><br><span class="line">    <span class="attr">pods:</span> <span class="string">&quot;20&quot;</span></span><br><span class="line">    <span class="attr">requests.cpu:</span> <span class="string">&quot;20&quot;</span></span><br><span class="line">    <span class="attr">requests.memory:</span> <span class="string">100Gi</span></span><br><span class="line">    <span class="attr">limits.cpu:</span> <span class="string">&quot;40&quot;</span></span><br><span class="line">    <span class="attr">limits.memory:</span> <span class="string">200Gi</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 2.配置对象数量配额限制</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ResourceQuota</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">object-counts</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">spark-cluster</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">hard:</span></span><br><span class="line">    <span class="attr">configmaps:</span> <span class="string">&quot;10&quot;</span></span><br><span class="line">    <span class="attr">persistentvolumeclaims:</span> <span class="string">&quot;4&quot;</span></span><br><span class="line">    <span class="attr">replicationcontrollers:</span> <span class="string">&quot;20&quot;</span></span><br><span class="line">    <span class="attr">secrets:</span> <span class="string">&quot;10&quot;</span></span><br><span class="line">    <span class="attr">services:</span> <span class="string">&quot;10&quot;</span></span><br><span class="line">    <span class="attr">services.loadbalancers:</span> <span class="string">&quot;2&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 3.配置CPU和内存LimitRange</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">LimitRange</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">mem-limit-range</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">limits:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">default:</span></span><br><span class="line">      <span class="attr">memory:</span> <span class="string">50Gi</span></span><br><span class="line">      <span class="attr">cpu:</span> <span class="number">5</span></span><br><span class="line">    <span class="attr">defaultRequest:</span></span><br><span class="line">      <span class="attr">memory:</span> <span class="string">1Gi</span></span><br><span class="line">      <span class="attr">cpu:</span> <span class="number">1</span></span><br><span class="line">      <span class="attr">type:</span> <span class="string">Container</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># default 即limit的值</span></span><br><span class="line"><span class="comment"># defaultRequest 即request的值</span></span><br></pre></td></tr></table></figure>

<h5 id="访问prometheus"><a href="#访问prometheus" class="headerlink" title="访问prometheus"></a>访问prometheus</h5><p>prometheus对应的nodeport端口为30200<br><a target="_blank" rel="noopener" href="http://masterip:30200/">http://masterIP:30200</a></p>
<p>prometheus web界面提供了基本的查询k8s集群中每个pod的cpu使用情况<br>sum by (pod_name)( rate(container_cpu_usage_seconds_total{image!&#x3D;””, pod_name!&#x3D;””}[1m] ) )</p>
<h5 id="访问grafana"><a href="#访问grafana" class="headerlink" title="访问grafana"></a>访问grafana</h5><p>查看grafana服务暴露的端口号<br>kubectl get service -n monitoring | grep grafana<br>grafana  NodePort  10.107.56.143  <node>  3000:30100&#x2F;TCP  20h<br><a target="_blank" rel="noopener" href="http://masterip:30100/">http://masterIP:30100</a> 默认admin&#x2F;admin</node></p>
<h4 id="使用Helm部署EFK平台"><a href="#使用Helm部署EFK平台" class="headerlink" title="使用Helm部署EFK平台"></a>使用Helm部署EFK平台</h4><p><img src="_posts/k8sNote1/k8s_helm_efk.png"></p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 节点上的pod日志信息目录</span></span><br><span class="line">/var/log/containers</span><br><span class="line"></span><br><span class="line"><span class="built_in">cd</span> /usr/local/install-k8s</span><br><span class="line"><span class="built_in">mkdir</span> efk &amp;&amp; <span class="built_in">cd</span> efk</span><br><span class="line"></span><br><span class="line"><span class="comment"># 添加Google incubator仓库</span></span><br><span class="line">helm repo add incubator http://storage.googleapis.com/kubernetes-charts-incubator</span><br><span class="line"></span><br><span class="line"><span class="comment"># 部署Elasticsearch</span></span><br><span class="line">kubectl create namespace efk</span><br><span class="line">helm fetch incubator/elasticsearch</span><br><span class="line">helm install --name els1 --namespace=efk -f values.yaml uncubator/elasticsearch</span><br><span class="line">kubectl run cirror-<span class="variable">$&#123;RANDOM&#125;</span> --<span class="built_in">rm</span> -it --image=cirros -- /bin/sh</span><br><span class="line">    curel Elasticsearch:Port/_cat/nodes</span><br><span class="line">    </span><br><span class="line"><span class="comment"># 部署Fluentd</span></span><br><span class="line">helm fetch stable/fluentd-elasticsearch</span><br><span class="line">vim values.yaml <span class="comment"># 更改其中 Elasticsearch 访问地址</span></span><br><span class="line">helm install --name flul --namespace=efk -f values.yaml stable/fluentd-elasticsearch</span><br><span class="line"></span><br><span class="line"><span class="comment"># 部署kibana</span></span><br><span class="line">helm fetch stable/kibana --version.14.8</span><br><span class="line">helm install --name kibl --namespace=efk -f values.yaml stable/kibana --version 0.14.8</span><br><span class="line"></span><br><span class="line"><span class="comment"># 修改为NodePort，访问后可查看收集的日志</span></span><br><span class="line">kubectl edit svc kib1-kibana -n efk</span><br></pre></td></tr></table></figure>

<hr>
<h2 id="证书"><a href="#证书" class="headerlink" title="证书"></a>证书</h2><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 查看证书</span></span><br><span class="line"><span class="built_in">cd</span> /etc/kubernetes/pki</span><br><span class="line">openssl x509 -<span class="keyword">in</span> apiserver.crt -text -noout（有效期1年）</span><br><span class="line">openssl x509 -<span class="keyword">in</span> ca.crt -text -noout（有效期10年）</span><br></pre></td></tr></table></figure>
<ol>
<li>go环境部署<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">百度<span class="string">&quot;go 中文社区&quot;</span> -&gt; 下载 -&gt; Linux</span><br><span class="line">或者wget</span><br><span class="line">wget https://dl.google.com/go/go1.12.7.linux-amd64.tar.gz</span><br><span class="line">tar -zxvf go…… -C /usr/local/</span><br><span class="line">vim /etc/profile</span><br><span class="line">	<span class="built_in">export</span> PATH=<span class="variable">$PATH</span>:/usr/local/go/bin</span><br><span class="line"><span class="built_in">source</span> /etc/profile</span><br><span class="line">go version</span><br></pre></td></tr></table></figure></li>
<li>下载源码<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="built_in">mkdir</span> /data &amp;&amp; <span class="built_in">cd</span> /data</span><br><span class="line">git <span class="built_in">clone</span> https://github.com/kubernetes/kubernetes.git</span><br><span class="line"><span class="built_in">cd</span> kubernetes/</span><br><span class="line">kubeadm version</span><br><span class="line">git checkout -b remotes/origin/release-1.15.1 v1.15.1</span><br></pre></td></tr></table></figure></li>
<li>修改kubeadm源码包更新证书策略<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">vim staging/src/k8s.io/client-go/util/cert/cert.go <span class="comment"># kubeamd1.14版本前</span></span><br><span class="line">vim cmd/kubeadm/app/util/pkiutil/pki_helpers.go <span class="comment"># kubeadm1.14之后</span></span><br><span class="line">1.16之后查看kubernetes官网查看开发者手册应该修改哪个文件</span><br><span class="line">	const duration3650d = time.Hour * 24 * 365  *10</span><br><span class="line">	NotAfter:    time.Now().Add(duration3650d).UTC(),</span><br><span class="line"></span><br><span class="line"><span class="built_in">mkdir</span> WHAT=cmd/kubeadm GOFLAGS=-v</span><br><span class="line"><span class="built_in">cp</span> _output/bin/kubeadm /root/kubeadm-new</span><br></pre></td></tr></table></figure></li>
<li>更新kubeadm<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 将kubeadm进行替换</span></span><br><span class="line"><span class="built_in">cp</span> /usr/bin/kubeadm /usr/bin/kubeadm.old</span><br><span class="line"><span class="built_in">cp</span> /root/kubeadm-new /usr/bin/kubeadm</span><br><span class="line"><span class="built_in">chmod</span> a+x /usr/bin/kubeadm</span><br></pre></td></tr></table></figure></li>
<li>更新各节点证书至master节点<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="built_in">cp</span> -r /etc/kubernetes/pki /etc/kubernetes/pki.old</span><br><span class="line"><span class="built_in">cd</span> /etc/kubernetes/pki</span><br><span class="line">kubeadm alpha certs renew all --config=/usr/local/install-k8s/core/kubeadm-config.yaml</span><br><span class="line">openssl x509 -<span class="keyword">in</span> apiserver.crt -text -noout | grep Not</span><br></pre></td></tr></table></figure></li>
<li>HA集群其余master节点证书更新<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"></span><br><span class="line">masterNode=<span class="string">&quot;192.168.66.20 192.168.66.21&quot;</span></span><br><span class="line"><span class="comment">#for host in $masterNode&#125;; do#scp /etc/kubernetes/pki/(ca.crt,ca.key,sa.key, sa.pub,front-proxy-ca.crt,front-proxy-ca, key)&quot;$(USER&#125;&quot;@$host:/etc/kubernetes/pki/</span></span><br><span class="line"><span class="comment"># scp /etc/kubernetes/pki/etcd/(ca.crt,ca.key) &quot;root&quot;@$host:/etc/kubernetes/pki/etcd</span></span><br><span class="line"><span class="comment"># scp /etc/kubernetes/admin.conf &quot;root&quot;@$host:/etc/kubernetes/</span></span><br><span class="line"><span class="comment">#done</span></span><br><span class="line"><span class="keyword">for</span> host <span class="keyword">in</span> $(CONTROL_PLANE_IPS&#125;; <span class="keyword">do</span></span><br><span class="line">    scp /etc/kubernetes/pki/&#123;ca.crt,ca.key,sa.key,sa.pub,front-proxy-ca.crt,front-proxy-ca.key&#125; <span class="string">&quot;<span class="variable">$&#123;USER&#125;</span>&quot;</span>@<span class="variable">$host</span>:/root/pki/</span><br><span class="line">    scp /etc/kubernetes/pki/etcd/&#123;ca.crt,ca.key&#125; <span class="string">&quot;root&quot;</span>@<span class="variable">$host</span>:/root/etcd</span><br><span class="line">    scp /etc/kubernetes/admin.conf <span class="string">&quot;root&quot;</span>@shost:/root/kubernetes/</span><br><span class="line"><span class="keyword">done</span></span><br></pre></td></tr></table></figure></li>
</ol>

      
    </div>
    <footer class="article-footer">
      
        <blockquote class="article-copyright">
    <p><strong><span class="icon-user icon"></span>著者: </strong>本堂主 @ 本堂主Blog</p>
    <p><strong><span class="icon-link icon"></span>パーマリンク: </strong><a href="https://jade-xyy.github.io/ja/2025/04/11/k8sNote2/">https://jade-xyy.github.io/ja/2025/04/11/k8sNote2/</a></p>
    <p><strong><span class="icon-pencil icon"></span>タイトル: </strong>「K8s备忘 - 下」</p>
    
    
    <p><strong><span class="icon-copyright icon"></span>ライセンス: </strong>本ブログのすべての文書は、特に指定されていない限り、<a href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh" rel="noopener external nofollow noreferrer" target="_blank"><span class="icon-creative-commons"></span>BY-NC-SA</a> ライセンスに従っています。引用の際は出典を明記してください！</p>
    <span class="icon-creative-commons article-copyright-bg"></span>
  </blockquote>
      
      
      
        <div class="share-wrapper">
  
    <a href="https://connect.qq.com/widget/shareqq/index.html?url=www.baidu.com&amp;title=K8s%E5%A4%87%E5%BF%98%20-%20%E4%B8%8B&amp;desc=K8s%E5%A4%87%E5%BF%98%20-%20%E4%B8%8B&amp;source=https%3A%2F%2Fjade-xyy.github.io" target="_blank" rel="noopener noreferrer" title="K8s备忘 - 下">
      <div class="share-icon icon icon-qq">
        
      </div>
    </a>
  
    <a href="javascript:;"  title="K8s备忘 - 下">
      <div class="share-icon icon icon-weixin">
        
          <div id="share-weixin">
            <div class="share-weixin-dom">
              <div class="share-weixin-content">
                <img id="share-weixin-banner"> 
                <div id="share-weixin-title"></div>
                <div id="share-weixin-desc"></div>
              </div>
              <div class="share-weixin-qrcode">
                <div class="share-weixin-info">
                  <div id="share-weixin-author"></div>
                  <div id="share-weixin-theme">Powered By hexo-theme-reimu</div>
                </div>
                <img id="share-weixin-qr" >
              </div>
            </div>
            <div class="share-weixin-canvas"></div>
          </div>
        
      </div>
    </a>
  
</div>
      
      
      
        <a data-aos="zoom-in" href="/ja/2025/04/11/k8sNote2/#comments" class="article-comment-link">
          <span class="post-comments-count waline-comment-count" data-path="/ja/2025/04/11/k8sNote2/" itemprop="commentCount"></span>
          コメント
        </a>
      
      
      
      
        <span data-aos="zoom-in" class="article-visitor-link">
          <span class="waline-pageview-count" data-path="/ja/2025/04/11/k8sNote2/">0</span>
          <em class="post-meta-item-text">閲覧数</em>
        </span>
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item" data-aos="zoom-in"><a class="article-tag-list-link" href="/ja/tags/k8s/" rel="tag">k8s</a></li></ul>


    </footer>
  </div>
  
  <nav id="article-nav" data-aos="fade-up">
    
      
      <div class="article-nav-link-wrap article-nav-link-left">
        
          
          
            <img data-src="/covers/raze.jpg" data-sizes="auto" alt="FAQ - Windows" class="lazyload">
          
        
        <a href="/ja/2025/04/11/faqWindows/"></a>
        <div class="article-nav-caption">次の記事</div>
        <h3 class="article-nav-title">
          
            FAQ - Windows
          
        </h3>
      </div>
    
    
    
    <div class="article-nav-link-wrap article-nav-link-right">
      
        
        
          <img data-src="/covers/bangboo2.jpg" data-sizes="auto" alt="K8s备忘 - 上" class="lazyload">
        
      
      <a href="/ja/2025/04/09/k8sNote1/"></a>
      <div class="article-nav-caption">前の記事</div>
      <h3 class="article-nav-title">
        
          K8s备忘 - 上
        
      </h3>
    </div>
    
  </nav>


</article>









  <section id="comments" data-aos="fade-up">
    <div class="comment-header">
      
      
      <h2 class="comment-title">说些什么吧！</h2>
      <div class="comment-selector">
        <div class="comment-selector-wrap">
            
            <div class="selector-item" data-selector="waline">
              <span>waline</span>
            </div>
            
        </div>
      </div>
    </div>
    <div class="comment-content">
      
        <div class="comment waline-comment" data-aos="fade-up"
          id="waline-comment">
        </div>
      
    </div>
  </section>


</section>
        </div>
        <footer id="footer">
  <div style="width: 100%; overflow: hidden">
    <div class="footer-line"></div>
  </div>
  <div id="footer-info">
    
    <div>
      <span class="icon-copyright"></span>
      
      
      
        2025
      
      <span class="footer-info-sep rotate"></span>
      本堂主
    </div>
    
      <div>
        Powered by&nbsp;<a href="https://hexo.io/" rel="noopener external nofollow noreferrer" target="_blank">Hexo</a>&nbsp;
        Theme.<a href="https://github.com/D-Sketon/hexo-theme-reimu" rel="noopener external nofollow noreferrer" target="_blank">Reimu</a>
      </div>
    
    
      <div>
        <span class="icon-brush"></span>
        61k
        &nbsp;|&nbsp;
        <span class="icon-coffee"></span>
        04:08
      </div>
    
    
    
    
      <div>
        <span class="icon-eye"></span>
        <span id="busuanzi_container_site_pv">総閲覧数&nbsp;<span id="busuanzi_value_site_pv"></span></span>
        &nbsp;|&nbsp;
        <span class="icon-user"></span>
        <span id="busuanzi_container_site_uv">総閲覧者数&nbsp;<span id="busuanzi_value_site_uv"></span></span>
      </div>
    
  </div>
</footer>

        
          <div class="sidebar-top">
            <div class="sidebar-top-taichi rotate"></div>
            <div class="arrow-up"></div>
          </div>
        
        <div id="mask" class="hide"></div>
      </div>
      <nav id="mobile-nav">
  <div class="sidebar-wrap">
    
      
        <div class="sidebar-toc-sidebar"><div class="sidebar-toc">
  <h3 class="toc-title">見出し</h3>
  <div class="sidebar-toc-wrapper toc-div-class" >
      
        <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%B0%83%E5%BA%A6"><span class="toc-text">调度</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%AE%80%E4%BB%8B"><span class="toc-text">简介</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%B0%83%E5%BA%A6%E5%8E%9F%E5%88%99"><span class="toc-text">调度原则</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%87%AA%E5%AE%9A%E4%B9%89%E8%B0%83%E5%BA%A6%E5%99%A8"><span class="toc-text">自定义调度器</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%B0%83%E5%BA%A6%E4%BA%B2%E5%92%8C%E6%80%A7"><span class="toc-text">调度亲和性</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E8%8A%82%E7%82%B9%E4%BA%B2%E5%92%8C%E6%80%A7%EF%BC%88pod%E5%92%8Cnode%E9%97%B4%EF%BC%89"><span class="toc-text">节点亲和性（pod和node间）</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#Pod%E4%BA%B2%E5%92%8C%E6%80%A7%EF%BC%88pod%E5%92%8Cpod%E9%97%B4%EF%BC%89"><span class="toc-text">Pod亲和性（pod和pod间）</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E4%BA%B2%E5%92%8C%E6%80%A7-%E5%8F%8D%E4%BA%B2%E5%92%8C%E6%80%A7%E8%B0%83%E5%BA%A6%E7%AD%96%E7%95%A5%E6%AF%94%E8%BE%83%E5%A6%82%E4%B8%8B%EF%BC%9A"><span class="toc-text">亲和性&#x2F;反亲和性调度策略比较如下：</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Taint%E5%92%8CToleration"><span class="toc-text">Taint和Toleration</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%B1%A1%E7%82%B9%EF%BC%88Taint%EF%BC%89"><span class="toc-text">污点（Taint）</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%AE%B9%E5%BF%8D%EF%BC%88Tolerations%EF%BC%89"><span class="toc-text">容忍（Tolerations）</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%8C%87%E5%AE%9A%E8%B0%83%E5%BA%A6%E8%8A%82%E7%82%B9"><span class="toc-text">指定调度节点</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AE%89%E5%85%A8"><span class="toc-text">安全</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%9C%BA%E5%88%B6%E8%AF%B4%E6%98%8E"><span class="toc-text">机制说明</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%AE%A4%E8%AF%81%EF%BC%88Authentication%EF%BC%89"><span class="toc-text">认证（Authentication）</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#HTTPS%E8%AF%81%E4%B9%A6%E8%AE%A4%E8%AF%81"><span class="toc-text">HTTPS证书认证</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E9%9C%80%E8%A6%81%E8%AE%A4%E8%AF%81%E7%9A%84%E8%8A%82%E7%82%B9"><span class="toc-text">需要认证的节点</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#kubeconfig"><span class="toc-text">kubeconfig</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#ServiceAccount"><span class="toc-text">ServiceAccount</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#Secret%E5%92%8CSA%E5%85%B3%E7%B3%BB"><span class="toc-text">Secret和SA关系</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%89%B4%E6%9D%83%EF%BC%88Authorization%EF%BC%89"><span class="toc-text">鉴权（Authorization）</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#API-Server%E7%9B%AE%E5%89%8D%E6%94%AF%E6%8C%81%E4%B8%80%E4%B8%8B%E5%87%A0%E7%A7%8D%E6%8E%88%E6%9D%83%E7%AD%96%E7%95%A5"><span class="toc-text">API Server目前支持一下几种授权策略</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#RBAC%E6%8E%88%E6%9D%83%E6%A8%A1%E5%BC%8F"><span class="toc-text">RBAC授权模式</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%AE%9E%E8%B7%B5"><span class="toc-text">实践</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%87%86%E5%85%A5%E6%8E%A7%E5%88%B6%EF%BC%88Admission-Control%EF%BC%89"><span class="toc-text">准入控制（Admission Control）</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Helm"><span class="toc-text">Helm</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%AE%9A%E4%B9%89"><span class="toc-text">定义</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#chart"><span class="toc-text">chart</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#release"><span class="toc-text">release</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%BB%84%E4%BB%B6"><span class="toc-text">组件</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Helm%E9%83%A8%E7%BD%B2"><span class="toc-text">Helm部署</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Helm%E8%87%AA%E5%AE%9A%E4%B9%89%E6%A8%A1%E6%9D%BF"><span class="toc-text">Helm自定义模板</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#Debug"><span class="toc-text">Debug</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8Helm%E9%83%A8%E7%BD%B2dashboard"><span class="toc-text">使用Helm部署dashboard</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8Helm%E9%83%A8%E7%BD%B2metrics-server"><span class="toc-text">使用Helm部署metrics-server</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8Helm%E9%83%A8%E7%BD%B2prometheus"><span class="toc-text">使用Helm部署prometheus</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E7%BB%84%E4%BB%B6%E8%AF%B4%E6%98%8E"><span class="toc-text">组件说明</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E9%83%A8%E7%BD%B2"><span class="toc-text">部署</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#Horizontal-Pod-Autoscaling"><span class="toc-text">Horizontal Pod Autoscaling</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E8%B5%84%E6%BA%90%E9%99%90%E5%88%B6-Pod"><span class="toc-text">资源限制 - Pod</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E8%B5%84%E6%BA%90%E9%99%90%E5%88%B6-%E5%90%8D%E7%A7%B0%E7%A9%BA%E9%97%B4"><span class="toc-text">资源限制 - 名称空间</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E8%AE%BF%E9%97%AEprometheus"><span class="toc-text">访问prometheus</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E8%AE%BF%E9%97%AEgrafana"><span class="toc-text">访问grafana</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8Helm%E9%83%A8%E7%BD%B2EFK%E5%B9%B3%E5%8F%B0"><span class="toc-text">使用Helm部署EFK平台</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%AF%81%E4%B9%A6"><span class="toc-text">证书</span></a></li></ol>
      
  </div>
</div>
</div>
        <div class="sidebar-common-sidebar hidden"><div class="sidebar-author">
  <img data-src="/avatar/Omen.jpg" data-sizes="auto" alt="本堂主" class="lazyload">
  <div class="sidebar-author-name">本堂主</div>
  <div class="sidebar-description"></div>
</div>
<div class="sidebar-state">
  <div class="sidebar-state-article">
    <div>投稿</div>
    <div class="sidebar-state-number">17</div>
  </div>
  <div class="sidebar-state-category">
    <div>カテゴリー</div>
    <div class="sidebar-state-number">5</div>
  </div>
  <div class="sidebar-state-tag">
    <div>タグ</div>
    <div class="sidebar-state-number">10</div>
  </div>
</div>
<div class="sidebar-social">
  
</div>
<div class="sidebar-menu">
  
    
      <div class="sidebar-menu-link-wrap">
        <a class="sidebar-menu-link-dummy" href="/ja/" aria-label="ホーム"></a>
        <div class="sidebar-menu-icon icon rotate">
          &#xe62b;
        </div>
        <div class="sidebar-menu-link">ホーム</div>
      </div>
    
      <div class="sidebar-menu-link-wrap">
        <a class="sidebar-menu-link-dummy" href="/ja/archives" aria-label="アーカイブ"></a>
        <div class="sidebar-menu-icon icon rotate">
          &#xe62b;
        </div>
        <div class="sidebar-menu-link">アーカイブ</div>
      </div>
    
      <div class="sidebar-menu-link-wrap">
        <a class="sidebar-menu-link-dummy" href="/ja/about" aria-label="プロフィール"></a>
        <div class="sidebar-menu-icon icon rotate">
          &#xe62b;
        </div>
        <div class="sidebar-menu-link">プロフィール</div>
      </div>
    
      <div class="sidebar-menu-link-wrap">
        <a class="sidebar-menu-link-dummy" href="/ja/friend" aria-label="フレンド"></a>
        <div class="sidebar-menu-icon icon rotate">
          &#xe62b;
        </div>
        <div class="sidebar-menu-link">フレンド</div>
      </div>
    
  
</div>
</div>
      
    
  </div>
  
    
      <div class="sidebar-btn-wrapper">
        <div class="sidebar-toc-btn current"></div>
        <div class="sidebar-common-btn"></div>
      </div>
    
  
</nav>

    </div>
    
      <div class="site-search">
        <div class="reimu-popup popup">
          <div class="reimu-search">
            <div class="reimu-search-input-icon"></div>
            <div class="reimu-search-input" id="reimu-search-input"></div>
            <div class="popup-btn-close"></div>
          </div>
          <div class="reimu-results">
            <div id="reimu-stats"></div>
            <div id="reimu-hits"></div>
            <div id="reimu-pagination" class="reimu-pagination"></div>
          </div>
          <img class="reimu-bg" src="/images/reimu.png"/>
        </div>
      </div>
    
    
    
    
<script src="https://npm.webcache.cn/lazysizes@5.3.2/lazysizes.min.js" integrity="sha384-3gT&#x2F;vsepWkfz&#x2F;ff7PpWNUeMzeWoH3cDhm&#x2F;A8jM7ouoAK0&#x2F;fP&#x2F;9bcHHR5kHq2nf+e" crossorigin="anonymous"></script>


<script src="https://npm.webcache.cn/clipboard@2.0.11/dist/clipboard.min.js" integrity="sha384-J08i8An&#x2F;QeARD9ExYpvphB8BsyOj3Gh2TSh1aLINKO3L0cMSH2dN3E22zFoXEi0Q" crossorigin="anonymous"></script>





<script src="/js/script.js"></script>



  
<script src="/js/aos.js"></script>

  <script>
    var aosInit = () => {
      AOS.init({
        duration: 1000,
        easing: "ease",
        once: true,
        offset: 50,
      });
    };
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', aosInit);
    } else {
      aosInit();
    }
  </script>



<script src="/js/pjax_script.js" data-pjax></script>



  
<script src="/js/generator_search.js" defer></script>






  
<script src="https://npm.webcache.cn/mouse-firework@0.1.1/dist/index.umd.js" integrity="sha384-8LyaidD9GPxQQgLJO&#x2F;WRw&#x2F;O2h3BoNq&#x2F;ApI&#x2F;ecpvM6RsrCz2qP2ppBXUKihP4V&#x2F;2d" crossorigin="anonymous"></script>

  <script>
    window.firework && window.firework(JSON.parse('{"excludeElements":["a","button"],"particles":[{"shape":"circle","move":["emit"],"easing":"easeOutExpo","colors":["var(--red-1)","var(--red-2)","var(--red-3)","var(--red-4)"],"number":20,"duration":[1200,1800],"shapeOptions":{"radius":[16,32],"alpha":[0.3,0.5]}},{"shape":"circle","move":["diffuse"],"easing":"easeOutExpo","colors":["var(--red-0)"],"number":1,"duration":[1200,1800],"shapeOptions":{"radius":20,"alpha":[0.2,0.5],"lineWidth":6}}]}'))
  </script>









  
<script src="https://npm.webcache.cn/quicklink@2.3.0/dist/quicklink.umd.js" integrity="sha384-aD7FsuQkS1ohgFKY41fJfeA+Wd&#x2F;QRNnrOd9Bs58K3FzKdJJv8yPnYU8Tnp5z1agS" crossorigin="anonymous"></script>

  <script data-pjax>
    window.quicklink?.listen({
      timeout: 3000,
      priority: true,
      ignores: []
    });
  </script>


<div id="lazy-script">
  <div>
    
      
      
      <script data-pjax>
        window.REIMU_POST = {
          author: "本堂主",
          title: "K8s备忘 - 下",
          url: "https://jade-xyy.github.io/2025/04/11/k8sNote2/",
          excerpt: "",
          description: "",
          stripContent: "调度简介Scheduler是k8s的调度器，主要任务是定义的pod分配到集群的节点上 调度原则 公平：保证每个节点都能被分配资源 资源高效利用：集群所有资源最大化被使用 效率：调度的性能要好，能够尽快地对大批量的pod完成调度工作 灵活：允许用户根据自己的需求控制调度的逻辑Scheduler是作为单独的程序运行的，启动之后会一直坚挺（持续连接）APIServer，获取PodSpec.NodeName为空的pod，对每个pod都会创建一个binding，表明该pod应该放到哪个节点上指定了PodS",
          date: "Fri Apr 11 2025 14:57:07 GMT+0800",
          updated: "Fri Apr 18 2025 15:56:07 GMT+0800",
          cover: "/images/zzz_cjjxrrdpts.webp",
        };
      </script>
       
    
    
      
        
<script src="/js/insert_highlight.js" data-pjax></script>

        
          
<script src="https://npm.webcache.cn/html-to-image@1.11.11/dist/html-to-image.js" integrity="sha384-UbfRVKN3&#x2F;elS1r7JcK2FhmPP+KlJ4CvYwbyYD7tH+uTkbT9bNJr9eJeQ0FoFbAgz" crossorigin="anonymous" defer data-pjax></script>

          
<script src="https://npm.webcache.cn/qrcode@1.4.4/build/qrcode.min.js" integrity="sha384-0RsG1yo&#x2F;crf&#x2F;1Qc14sho26SXXOTngNCjgJw7fuvXBt9W&#x2F;OChF&#x2F;Ijx+aUuBDqQwEk" crossorigin="anonymous" defer data-pjax></script>

        
      
    
    
      <script type="module" data-pjax>
        const PhotoSwipeLightbox = (await safeImport("https://npm.webcache.cn/photoswipe@5.4.4/dist/photoswipe-lightbox.esm.min.js", "sha384-DiL6M/gG+wmTxmCRZyD1zee6lIhawn5TGvED0FOh7fXcN9B0aZ9dexSF/N6lrZi/")).default;
        
        const pswp = () => {
          if (_$$('.article-entry a.article-gallery-item').length > 0) {
            new PhotoSwipeLightbox({
              gallery: '.article-entry',
              children: 'a.article-gallery-item',
              pswpModule: () => safeImport("https://npm.webcache.cn/photoswipe@5.4.4/dist/photoswipe.esm.min.js", "sha384-WkkO3GCmgkC3VQWpaV8DqhKJqpzpF9JoByxDmnV8+oTJ7m3DfYEWX1fu1scuS4+s")
            }).init();
          }
          if(_$$('.article-gallery a.article-gallery-item').length > 0) {
            new PhotoSwipeLightbox({
              gallery: '.article-gallery',
              children: 'a.article-gallery-item',
              pswpModule: () => safeImport("https://npm.webcache.cn/photoswipe@5.4.4/dist/photoswipe.esm.min.js", "sha384-WkkO3GCmgkC3VQWpaV8DqhKJqpzpF9JoByxDmnV8+oTJ7m3DfYEWX1fu1scuS4+s")
            }).init();
          }
          window.lightboxStatus = 'done';
          window.removeEventListener('lightbox:ready', pswp);
        }
        if(window.lightboxStatus === 'ready') {
          pswp()
        } else {
          window.addEventListener('lightbox:ready', pswp);
        }
      </script>
      
        








<script data-pjax>
  var loadScript = (src, integrity) => {
    const script = document.createElement('script');
    script.src = src;
    if (integrity) script.integrity = integrity;
    script.crossOrigin = 'anonymous';
    return script;
  };

  var commentConfigKeys = ['valine', 'waline', 'twikoo', 'gitalk', 'giscus'];
  var commentConfig = {
    valine: {
      enable: false,
      load: () => {
        const container = document.querySelector('.valine-comment');
        if (!container) return;
        container.style.display = 'block';

        const script = loadScript(
          'https://npm.webcache.cn/valine@1.5.1/dist/Valine.min.js',
          'sha384-3ma91AExDeMAZ1rjTjaP8V2A2obQE+s5ltKRwYlwdpArz9xVbp0tF3b0VV2ACNPn'
        );
        script.onload = () => {
          var GUEST_INFO = ['nick', 'mail', 'link'];
          var guest_info = 'nick,mail,link'.split(',').filter((item) => {
            return GUEST_INFO.indexOf(item) > -1
          });
          var recordIP = JSON.parse('true');
          var highlight = JSON.parse('true');
          var visitor = JSON.parse('false');

          if (window.Valine) {
            new Valine({
              el: '.valine-comment',
              appId: "e8feHL9uKMe2cBgp29tyFCdv-gzGzoHsz",
              appKey: "Z289QNdRm4m1Im6mWjAWqW4P",
              placeholder: "Just go go",
              pageSize: '10',
              avatar: 'mp',
              lang: 'zh-cn',
              recordIP: recordIP,
              highlight: highlight,
              visitor: visitor,
              requiredFields: guest_info,
              path: window.location.pathname
            });
          }
        };
        document.head.appendChild(script);
      }
    },
    waline: {
      enable: true,
      load: async () => {
        const container = document.querySelector('.waline-comment');
        if (!container) return;
        container.style.display = 'block';

        let walineInit;
        const walineCdn = 'https://npm.webcache.cn/@waline/client@2.15.8/dist/waline.mjs';
        const walineIntegrity = 'sha384-9sbqJjrfGjbkI6/PI4nU/MvBfEmkkPC4YK9I4zBeMIf1CVCZdCMH/KinBEAZII/5';

        const module = await safeImport(walineCdn, walineIntegrity);
        walineInit = module.init;

        window.walineInstance = walineInit({
          el: '.waline-comment',
          serverURL: 'https://waline.fay.net.cn',
          lang: 'zh-CN',
          locale: {},
          emoji: ["https://unpkg.com/@waline/emojis@1.2.0/weibo","https://unpkg.com/@waline/emojis@1.2.0/alus","https://unpkg.com/@waline/emojis@1.2.0/bilibili","https://unpkg.com/@waline/emojis@1.2.0/qq","https://unpkg.com/@waline/emojis@1.2.0/tieba","https://unpkg.com/@waline/emojis@1.2.0/tw-emoji"],
          meta: ["nick","mail","link"],
          requiredMeta: ["nick","mail"],
          wordLimit: JSON.parse('0'),
          comment: true,
          pageSize: JSON.parse('10'),
          dark: 'html[data-theme="dark"]',
          pageview: JSON.parse('true'),
        });
      }
    },
    twikoo: {
      enable: false,
      load: () => {
        const container = document.querySelector('.twikoo-comment');
        if (!container) return;
        container.style.display = 'block';

        const script = loadScript(
          'https://npm.webcache.cn/twikoo@1.6.16/dist/twikoo.all.min.js',
          'sha384-lDHsr5aZmkMS0eKnsUu6e9RWP+dRmn7sgjRAKGOAoXfMyzbUK6Qi86zZK7R+KvRV'
        );

        script.onload = () => {
          if (window.twikoo) {
            twikoo.init({
              envId: '',
              el: '.tcomment',
              region: '',
            })
          }
        } 
        document.head.appendChild(script);
      }
    },
    gitalk: {
      enable: false,
      load: () => {
        const container = document.querySelector('.gitalk-comment');
        if (!container) return;
        container.style.display = 'block';

        const script = loadScript(
          'https://npm.webcache.cn/gitalk@1.8.0/dist/gitalk.min.js',
          'sha384-kspnZUWBoSWwoJHa0hBCXYbHGbhvU/lcEH5O8eVbSDhbPwsiVUTp/aGX/z/5EuMA'
        );

        script.onload = () => {
          if (false) {
            const md5Script = loadScript(
              'https://npm.webcache.cn/blueimp-md5@2.19.0/js/md5.min.js',
              'sha384-JmVtRz6RWiXnA14QbIOJzPuU3MidULOpBP66deeLLyyoF4Tr/gZlbkHkL6vTthxH'
            );
            md5Script.onload = initGitalk;
            document.head.appendChild(md5Script);
          } else {
            initGitalk();
          }
        }
        document.head.appendChild(script);

        function initGitalk() {
          var gitalkId = location.pathname;
          var gitalk = new Gitalk({
            clientID: '',
            clientSecret: '',
            repo: '',
            owner: '',
            admin: null,
            id: gitalkId, // Ensure uniqueness and length less than 50
            distractionFreeMode: false // Facebook-like distraction free mode
          })
          gitalk.render('gitalk-comment');
        }
      }
    },
    giscus: {
      enable: false,
      load: () => {
        const container = document.querySelector('.giscus-comment');
        if (!container) return;
        container.style.display = 'block';

        // 删除可能已存在的 giscus 脚本和 iframe
        const existingScript = container.querySelector('script[src*="giscus.app/client.js"]');
        if (existingScript) existingScript.remove();
        const existingFrame = document.querySelector('iframe.giscus-frame');
        if (existingFrame) existingFrame.remove();

        const giscusScript = document.createElement('script');
        const domMode = document.documentElement.getAttribute("data-theme");
        giscusScript.src = 'https://giscus.app/client.js';
        giscusScript.setAttribute('data-repo', '');
        giscusScript.setAttribute('data-repo-id', '');
        giscusScript.setAttribute('data-category', ''); 
        giscusScript.setAttribute('data-category-id', '');
        giscusScript.setAttribute('data-mapping', '0');
        giscusScript.setAttribute('data-strict', '0');
        giscusScript.setAttribute('data-reactions-enabled', '1');
        giscusScript.setAttribute('data-emit-metadata', '0');
        giscusScript.setAttribute('data-input-position', 'bottom');
        giscusScript.setAttribute('data-theme', domMode === 'dark' ? 'dark' : 'light');
        giscusScript.setAttribute('data-lang', 'zh-CN');
        giscusScript.setAttribute('crossorigin', 'anonymous');
        giscusScript.async = true;
        container.appendChild(giscusScript);
        document.body.addEventListener('light-theme-set', () => {
          const iframe = document.querySelector('iframe.giscus-frame');
          if (!iframe) return;
          iframe.contentWindow.postMessage({ giscus: { setConfig: { theme: 'light' } } }, 'https://giscus.app');
        });
        document.body.addEventListener('dark-theme-set', () => {
          const iframe = document.querySelector('iframe.giscus-frame');
          if (!iframe) return;
          iframe.contentWindow.postMessage({ giscus: { setConfig: { theme: 'dark' } } }, 'https://giscus.app');
        });
      }
    }
  }
  commentConfig.enable = commentConfigKeys.some(key => commentConfig[key].enable);

  var defaultComment = '';
  if (commentConfig.enable) {
    // 1. 首先检查localStorage中是否有保存的评论类型
    var savedCommentType = localStorage.getItem('commentType');
    
    // 2. 如果localStorage中有值且对应的评论系统可用，就使用它
    if (savedCommentType) {
      if (commentConfig[savedCommentType]?.enable) {
        defaultComment = savedCommentType;
      }
    }
    
    // 3. 如果localStorage无效，检查配置的默认评论系统
    if (!defaultComment) {
      var configDefault = 'valine';
      if (commentConfig[configDefault]?.enable) {
        defaultComment = configDefault;
      }
    }
    
    // 4. 如果前两项都无效，按指定顺序找到第一个可用的评论系统
    if (!defaultComment) {
      defaultComment = commentConfigKeys.find(sys => commentConfig[sys].enable) || '';
    }
  }
  function loadComments() {
    if (!commentConfig.enable) return;
    // 评论组件加载状态跟踪
    const loadedComments = {
      valine: false,
      waline: false,
      twikoo: false,
      gitalk: false,
      giscus: false
    };

    // 隐藏所有评论容器
    const hideAllComments = () => {
      const commentContainers = document.querySelectorAll('.comment');
      commentContainers.forEach(container => {
        container.style.display = 'none';
      });
    };

    // 按需加载评论系统
    const loadCommentSystem = (type) => {
      if (loadedComments[type]) {
        // 如果已加载，只需显示对应容器
        document.querySelector(`.${type}-comment`).style.display = 'block';
        return;
      }

      // 根据类型加载对应的脚本
      commentConfig[type]?.load();
      loadedComments[type] = true;
    };

    // 评论组件选择器
    const changeActiveCommentItems = (item) => {
      const commentItems = document.querySelectorAll('.selector-item');
      for (let i = 0; i < commentItems.length; i++) {
        commentItems[i].classList.remove('active');
      }
      item.classList.add('active');

      // 获取要加载的评论系统类型
      const commentType = item.getAttribute('data-selector');

      // 隐藏所有评论系统
      hideAllComments();

      // 加载选中的评论系统
      loadCommentSystem(commentType);
    };

    const commentInit = () => {
      // 评论组件选择器点击事件
      const commentItems = document.querySelectorAll('.selector-item');
      for (let item of commentItems) {
        item.addEventListener('click', () => {
          // 保存选择器状态
          const commentType = item.getAttribute('data-selector');
          window.localStorage.setItem('commentType', commentType);
          // 切换选中状态
          changeActiveCommentItems(item);
        });
      }

      // 检查是否需要加载默认评论系统
      if (defaultComment) {
        const defaultSelectorItem = document.querySelector(`[data-selector="${defaultComment}"]`);
        if (!defaultSelectorItem) return;
        defaultSelectorItem.style.display = 'block';
        defaultSelectorItem.classList.add('active');
        loadCommentSystem(defaultComment);
      }
    }

    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', commentInit);
    } else {
      commentInit();
    }
  };
  loadComments();
</script>

      
    
  </div>
</div>


  <script>
    console.log(String.raw`%c 
 ______     ______     __     __    __     __  __    
/\  == \   /\  ___\   /\ \   /\ "-./  \   /\ \/\ \   
\ \  __<   \ \  __\   \ \ \  \ \ \-./\ \  \ \ \_\ \  
 \ \_\ \_\  \ \_____\  \ \_\  \ \_\ \ \_\  \ \_____\ 
  \/_/ /_/   \/_____/   \/_/   \/_/  \/_/   \/_____/ 
                                                  
`,'color: #ff5252;')
    console.log('%c Theme.Reimu v' + '1.8.0' + ' %c https://github.com/D-Sketon/hexo-theme-reimu ', 'color: white; background: #ff5252; padding:5px 0;', 'padding:4px;border:1px solid #ff5252;')
  </script>
  



  
<script src="https://npm.webcache.cn/busuanzi@2.3.0/bsz.pure.mini.js" integrity="sha384-0M75wtSkhjIInv4coYlaJU83+OypaRCIq2SukQVQX04eGTCBXJDuWAbJet56id+S" crossorigin="anonymous" async></script>




<script>
  if ('serviceWorker' in navigator) {
    navigator.serviceWorker.getRegistrations().then((registrations) => {
      for (let registration of registrations) {
        registration.unregister();
      }
    });
  }
</script>









    
  </body>
  </html>

